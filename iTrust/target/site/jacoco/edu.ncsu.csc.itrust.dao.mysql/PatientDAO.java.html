<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PatientDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.dao.mysql</a> &gt; <span class="el_source">PatientDAO.java</span></div><h1>PatientDAO.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.dao.mysql;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Vector;
import edu.ncsu.csc.itrust.DBUtil;
import edu.ncsu.csc.itrust.beans.DiagnosisBean;
import edu.ncsu.csc.itrust.beans.PatientBean;
import edu.ncsu.csc.itrust.beans.PatientHistoryBean;
import edu.ncsu.csc.itrust.beans.PersonnelBean;
import edu.ncsu.csc.itrust.beans.PrescriptionBean;
import edu.ncsu.csc.itrust.beans.ProcedureBean;
import edu.ncsu.csc.itrust.beans.loaders.DiagnosisBeanLoader;
import edu.ncsu.csc.itrust.beans.loaders.PatientLoader;
import edu.ncsu.csc.itrust.beans.loaders.PersonnelLoader;
import edu.ncsu.csc.itrust.beans.loaders.PrescriptionBeanLoader;
import edu.ncsu.csc.itrust.beans.loaders.ProcedureBeanLoader;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.exception.ITrustException;
import edu.ncsu.csc.itrust.DateUtil;

/**
 * Used for managing all static information related to a patient. For other information related to all aspects
 * of patient care, see the other DAOs.
 * 
 * DAO stands for Database Access Object. All DAOs are intended to be reflections of the database, that is,
 * one DAO per table in the database (most of the time). For more complex sets of queries, extra DAOs are
 * added. DAOs can assume that all data has been validated and is correct.
 * 
 * DAOs should never have setters or any other parameter to the constructor than a factory. All DAOs should be
 * accessed by DAOFactory (@see {@link DAOFactory}) and every DAO should have a factory - for obtaining JDBC
 * connections and/or accessing other DAOs.
 * 
 *  
 * 
 */
public class PatientDAO {
	private DAOFactory factory;
	private PatientLoader patientLoader;
	private PersonnelLoader personnelLoader;
	private DiagnosisBeanLoader diagnosisLoader;
	private PrescriptionBeanLoader prescriptionLoader;
	private ProcedureBeanLoader procedureLoader;

	/**
	 * The typical constructor.
	 * @param factory The {@link DAOFactory} associated with this DAO, which is used for obtaining SQL connections, etc.
	 */
<span class="fc" id="L54">	public PatientDAO(DAOFactory factory) {</span>
<span class="fc" id="L55">		this.factory = factory;</span>
<span class="fc" id="L56">		this.patientLoader = new PatientLoader();</span>
<span class="fc" id="L57">		this.personnelLoader = new PersonnelLoader();</span>
<span class="fc" id="L58">		this.diagnosisLoader = new DiagnosisBeanLoader(true);</span>
<span class="fc" id="L59">		this.prescriptionLoader = new PrescriptionBeanLoader();</span>
<span class="fc" id="L60">		this.procedureLoader = new ProcedureBeanLoader(true);</span>
<span class="fc" id="L61">	}</span>

	/**
	 * Returns the name for the given MID
	 * 
	 * @param mid The MID of the patient in question.
	 * @return A String representing the patient's first name and last name.
	 * @throws ITrustException
	 * @throws DBException
	 */
	public String getName(long mid) throws ITrustException, DBException {
<span class="fc" id="L72">		Connection conn = null;</span>
<span class="fc" id="L73">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L75">			conn = factory.getConnection();</span>
<span class="fc" id="L76">			ps = conn.prepareStatement(&quot;SELECT firstName, lastName FROM patients WHERE MID=?&quot;);</span>
<span class="fc" id="L77">			ps.setLong(1, mid);</span>
			ResultSet rs;
<span class="fc" id="L79">			rs = ps.executeQuery();</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">			if (rs.next()) {</span>
<span class="fc" id="L81">				String result = rs.getString(&quot;firstName&quot;) + &quot; &quot; + rs.getString(&quot;lastName&quot;);</span>
<span class="fc" id="L82">				rs.close();</span>
<span class="fc" id="L83">				ps.close();</span>
<span class="fc" id="L84">				return result;</span>
			} else {
<span class="fc" id="L86">				rs.close();</span>
<span class="fc" id="L87">				ps.close();</span>
<span class="fc" id="L88">				throw new ITrustException(&quot;User does not exist&quot;);</span>
			}
<span class="fc" id="L90">		} catch (SQLException e) {</span>
			
<span class="fc" id="L92">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L94">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Returns the role of a particular patient - why is this in PatientDAO? It should be in AuthDAO
	 * 
	 * @param mid The MID of the patient in question.
	 * @param role A String representing the role of the patient.
	 * @return A String representing the patient's role.
	 * @throws ITrustException
	 * @throws DBException
	 */
	public String getRole(long mid, String role) throws ITrustException, DBException {
<span class="fc" id="L108">		Connection conn = null;</span>
<span class="fc" id="L109">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L111">			conn = factory.getConnection();</span>
<span class="fc" id="L112">			ps = conn.prepareStatement(&quot;SELECT role FROM users WHERE MID=? AND Role=?&quot;);</span>
<span class="fc" id="L113">			ps.setLong(1, mid);</span>
<span class="fc" id="L114">			ps.setString(2, role);</span>
			ResultSet rs;
<span class="fc" id="L116">			rs = ps.executeQuery();</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">			if (rs.next()) {</span>
<span class="fc" id="L118">				String result = rs.getString(&quot;role&quot;);</span>
<span class="fc" id="L119">				rs.close();</span>
<span class="fc" id="L120">				ps.close();</span>
<span class="fc" id="L121">				return result;</span>
			} else {
<span class="fc" id="L123">				rs.close();</span>
<span class="fc" id="L124">				ps.close();</span>
<span class="fc" id="L125">				throw new ITrustException(&quot;User does not exist with the designated role&quot;);</span>
			}
<span class="nc" id="L127">		} catch (SQLException e) {</span>
			
<span class="nc" id="L129">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L131">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Adds an empty patient to the table, returns the new MID
	 * 
	 * @return The MID of the patient as a long.
	 * @throws DBException
	 */
	public long addEmptyPatient() throws DBException {
<span class="fc" id="L142">		Connection conn = null;</span>
<span class="fc" id="L143">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L145">			conn = factory.getConnection();</span>
<span class="fc" id="L146">			ps = conn.prepareStatement(&quot;INSERT INTO patients(MID) VALUES(NULL)&quot;);</span>
<span class="fc" id="L147">			ps.executeUpdate();</span>
<span class="fc" id="L148">			long a = DBUtil.getLastInsert(conn);</span>
<span class="fc" id="L149">			ps.close();</span>
<span class="fc" id="L150">			return a;</span>
<span class="fc" id="L151">		} catch (SQLException e) {</span>
			
<span class="fc" id="L153">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L155">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Returns the patient's information for a given ID
	 * 
	 * @param mid The MID of the patient to retrieve.
	 * @return A PatientBean representing the patient.
	 * @throws DBException
	 */
	public PatientBean getPatient(long mid) throws DBException {
<span class="fc" id="L167">		Connection conn = null;</span>
<span class="fc" id="L168">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L170">			conn = factory.getConnection();</span>
<span class="fc" id="L171">			ps = conn.prepareStatement(&quot;SELECT * FROM patients WHERE MID = ?&quot;);</span>
<span class="fc" id="L172">			ps.setLong(1, mid);</span>
<span class="fc" id="L173">			ResultSet rs = ps.executeQuery();</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">			if (rs.next()) {</span>
<span class="fc" id="L175">				PatientBean pat = patientLoader.loadSingle(rs);</span>
<span class="fc" id="L176">				rs.close();</span>
<span class="fc" id="L177">				ps.close();</span>
<span class="fc" id="L178">				return pat;</span>
			} else{
<span class="fc" id="L180">				rs.close();</span>
<span class="fc" id="L181">				ps.close();</span>
<span class="fc" id="L182">				return null;</span>
			}
<span class="fc" id="L184">		} catch (SQLException e) {</span>
			
<span class="fc" id="L186">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L188">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Updates a patient's information for the given MID
	 * 
	 * @param p The patient bean representing the new information for the patient.
	 * @throws DBException
	 */
	public void editPatient(PatientBean p, long hcpid) throws DBException {
<span class="fc" id="L199">		Connection conn = null;</span>
<span class="fc" id="L200">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L202">			conn = factory.getConnection();</span>
<span class="fc" id="L203">			ps = conn.prepareStatement(&quot;UPDATE patients SET firstName=?,lastName=?,email=?,&quot;</span>
					+ &quot;address1=?,address2=?,city=?,state=?,zip=?,phone=?,&quot;
					+ &quot;eName=?,ePhone=?,iCName=?,iCAddress1=?,iCAddress2=?,iCCity=?,&quot;
					+ &quot;ICState=?,iCZip=?,iCPhone=?,iCID=?,DateOfBirth=?,&quot;
					+ &quot;DateOfDeath=?,CauseOfDeath=?,MotherMID=?,FatherMID=?,&quot;
					+ &quot;BloodType=?,Ethnicity=?,Gender=?,TopicalNotes=?, CreditCardType=?, CreditCardNumber=?, &quot;
					+ &quot;DirectionsToHome=?, Religion=?, Language=?, SpiritualPractices=?, &quot;
					+ &quot;AlternateName=?, DateOfDeactivation=? WHERE MID=?&quot;);

<span class="fc" id="L212">			patientLoader.loadParameters(ps, p);</span>
<span class="fc" id="L213">			ps.setLong(37, p.getMID());</span>
<span class="fc" id="L214">			ps.executeUpdate();</span>
			
<span class="fc" id="L216">			addHistory(p.getMID(), hcpid);</span>
<span class="fc" id="L217">			ps.close();</span>
			
<span class="fc" id="L219">		} catch (SQLException e) {</span>
			
<span class="fc" id="L221">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L223">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L224">		}</span>
<span class="fc" id="L225">	}</span>
	
	public void addHistory(long pid, long hcpid) throws DBException {
<span class="fc" id="L228">		Connection conn = null;</span>
<span class="fc" id="L229">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L231">			conn = factory.getConnection();</span>
<span class="fc" id="L232">			ps = conn.prepareStatement(&quot;INSERT INTO historypatients SELECT null, CURDATE(), ?, p.* FROM patients p WHERE p.mid=?&quot;);</span>
<span class="fc" id="L233">			ps.setLong(1, hcpid);</span>
<span class="fc" id="L234">			ps.setLong(2, pid);</span>
<span class="fc" id="L235">			ps.executeUpdate();</span>
<span class="fc" id="L236">			ps.close();</span>
<span class="nc" id="L237">		} catch (SQLException e) {</span>
			
<span class="nc" id="L239">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L241">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L242">		}</span>
<span class="fc" id="L243">	}</span>
	
	public boolean hasHistory(long pid) throws DBException {
<span class="fc" id="L246">		Connection conn = null;</span>
<span class="fc" id="L247">		PreparedStatement ps = null;</span>
<span class="fc" id="L248">		boolean hasHistory = false;</span>
		try {
<span class="fc" id="L250">			conn = factory.getConnection();</span>
<span class="fc" id="L251">			ps = conn.prepareStatement(&quot;SELECT * FROM historypatients WHERE mid=?&quot;);</span>
<span class="fc" id="L252">			ps.setLong(1, pid);</span>
			ResultSet rs;
<span class="fc" id="L254">			rs = ps.executeQuery();</span>
<span class="fc" id="L255">			hasHistory = rs.next();</span>
<span class="fc" id="L256">			rs.close();</span>
<span class="fc" id="L257">			ps.close();</span>
<span class="nc" id="L258">		} catch (SQLException e) {</span>
			
<span class="nc" id="L260">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L262">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L263">		}</span>
<span class="fc" id="L264">		return hasHistory;</span>
	}
	
	public List&lt;PatientHistoryBean&gt; getPatientHistory(long mid) throws DBException {
<span class="fc" id="L268">		Connection conn = null;</span>
<span class="fc" id="L269">		PreparedStatement ps = null;</span>
		ArrayList&lt;PatientHistoryBean&gt; pList;
		try {
<span class="fc" id="L272">			conn = factory.getConnection();</span>
<span class="fc" id="L273">			ps = conn.prepareStatement(&quot;SELECT * FROM historypatients WHERE MID = ?&quot;);</span>
<span class="fc" id="L274">			ps.setLong(1, mid);</span>
<span class="fc" id="L275">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L276">			pList = new ArrayList&lt;PatientHistoryBean&gt;();</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">			while (rs.next()) {</span>
<span class="fc" id="L278">				pList.add(patientLoader.loadSingleHistory(rs));</span>
			}
<span class="fc" id="L280">			rs.close();</span>
<span class="fc" id="L281">			ps.close();</span>
<span class="nc" id="L282">		} catch (SQLException e) {</span>
			
<span class="nc" id="L284">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L286">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L287">		}</span>
<span class="fc" id="L288">		return pList;</span>
	}

	/**
	 * Returns whether or not the patient exists
	 * 
	 * @param pid The MID of the patient in question.
	 * @return A boolean indicating whether the patient exists.
	 * @throws DBException
	 */
	public boolean checkPatientExists(long pid) throws DBException {
<span class="fc" id="L299">		Connection conn = null;</span>
<span class="fc" id="L300">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L302">			conn = factory.getConnection();</span>
<span class="fc" id="L303">			ps = conn.prepareStatement(&quot;SELECT * FROM patients WHERE MID=?&quot;);</span>
<span class="fc" id="L304">			ps.setLong(1, pid);</span>
<span class="fc" id="L305">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L306">			boolean next = rs.next();</span>
<span class="fc" id="L307">			rs.close();</span>
<span class="fc" id="L308">			ps.close();</span>
<span class="fc" id="L309">			return next;</span>
<span class="fc" id="L310">		} catch (SQLException e) {</span>
			
<span class="fc" id="L312">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L314">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Returns a list of HCPs who are declared by the given patient
	 * 
	 * @param pid The MID of the patient in question.
	 * @return A java.util.List of Personnel Beans.
	 * @throws DBException
	 */
	public List&lt;PersonnelBean&gt; getDeclaredHCPs(long pid) throws DBException {
<span class="fc" id="L326">		Connection conn = null;</span>
<span class="fc" id="L327">		PreparedStatement ps = null;</span>
		try {
<span class="fc bfc" id="L329" title="All 2 branches covered.">			if (pid == 0L) throw new SQLException(&quot;pid cannot be 0&quot;);</span>
<span class="fc" id="L330">			conn = factory.getConnection();</span>
<span class="fc" id="L331">			ps = conn.prepareStatement(&quot;SELECT * FROM declaredhcp, personnel &quot;</span>
					+ &quot;WHERE PatientID=? AND personnel.MID=declaredhcp.HCPID&quot;);
<span class="fc" id="L333">			ps.setLong(1, pid);</span>
<span class="fc" id="L334">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L335">			List&lt;PersonnelBean&gt; loadlist = personnelLoader.loadList(rs);</span>
<span class="fc" id="L336">			rs.close();</span>
<span class="fc" id="L337">			ps.close();</span>
<span class="fc" id="L338">			return loadlist;</span>
<span class="fc" id="L339">		} catch (SQLException e) {</span>
			
<span class="fc" id="L341">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L343">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Declares an HCP for a particular patient
	 * 
	 * @param pid The MID of the patient in question.
	 * @param hcpID The HCP's MID.
	 * @return A boolean as to whether the insertion was successful.
	 * @throws DBException
	 * @throws ITrustException
	 */
	public boolean declareHCP(long pid, long hcpID) throws DBException, ITrustException {
<span class="fc" id="L357">		Connection conn = null;</span>
<span class="fc" id="L358">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L360">			conn = factory.getConnection();</span>
<span class="fc" id="L361">			ps = conn.prepareStatement(&quot;INSERT INTO declaredhcp(PatientID, HCPID) VALUES(?,?)&quot;);</span>
<span class="fc" id="L362">			ps.setLong(1, pid);</span>
<span class="fc" id="L363">			ps.setLong(2, hcpID);</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">			boolean check = (1 == ps.executeUpdate());</span>
<span class="fc" id="L365">			ps.close();</span>
<span class="fc" id="L366">			return check;</span>
<span class="fc" id="L367">		} catch (SQLException e) {</span>
<span class="fc bfc" id="L368" title="All 2 branches covered.">			if (1062 == e.getErrorCode())</span>
<span class="fc" id="L369">				throw new ITrustException(&quot;HCP &quot; + hcpID + &quot; has already been declared for patient &quot; + pid);</span>
			
<span class="fc" id="L371">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L373">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Undeclare an HCP for a given patient
	 * 
	 * @param pid The MID of the patient in question.
	 * @param hcpID The MID of the HCP in question.
	 * @return A boolean indicating whether the action was successful.
	 * @throws DBException
	 */
	public boolean undeclareHCP(long pid, long hcpID) throws DBException {
<span class="fc" id="L386">		Connection conn = null;</span>
<span class="fc" id="L387">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L389">			conn = factory.getConnection();</span>
<span class="fc" id="L390">			ps = conn.prepareStatement(&quot;DELETE FROM declaredhcp WHERE PatientID=? AND HCPID=?&quot;);</span>
<span class="fc" id="L391">			ps.setLong(1, pid);</span>
<span class="fc" id="L392">			ps.setLong(2, hcpID);</span>
<span class="fc bfc" id="L393" title="All 2 branches covered.">			boolean check = (1 == ps.executeUpdate());</span>
<span class="fc" id="L394">			ps.close();</span>
<span class="fc" id="L395">			return check;</span>
<span class="fc" id="L396">		} catch (SQLException e) {</span>
			
<span class="fc" id="L398">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L400">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Check if a patient has declared the given HCP
	 * 
	 * @param pid The MID of the patient in question as a long.
	 * @param hcpid The MID of the HCP in question as a long.
	 * @return
	 * @throws DBException
	 */
	public boolean checkDeclaredHCP(long pid, long hcpid) throws DBException {
<span class="fc" id="L413">		Connection conn = null;</span>
<span class="fc" id="L414">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L416">			conn = factory.getConnection();</span>
<span class="fc" id="L417">			ps = conn.prepareStatement(&quot;SELECT * FROM declaredhcp WHERE PatientID=? AND HCPID=?&quot;);</span>
<span class="fc" id="L418">			ps.setLong(1, pid);</span>
<span class="fc" id="L419">			ps.setLong(2, hcpid);</span>
<span class="fc" id="L420">			boolean check = (ps.executeQuery().next());</span>
<span class="fc" id="L421">			ps.close();</span>
<span class="fc" id="L422">			return check;</span>
<span class="fc" id="L423">		} catch (SQLException e) {</span>
			
<span class="fc" id="L425">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L427">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Return a list of patients that the given patient represents
	 * 
	 * @param pid The MID of the patient in question.
	 * @return A java.util.List of PatientBeans
	 * @throws DBException
	 */
	public List&lt;PatientBean&gt; getRepresented(long pid) throws DBException {
<span class="fc" id="L439">		Connection conn = null;</span>
<span class="fc" id="L440">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L442">			conn = factory.getConnection();</span>
<span class="fc" id="L443">			ps = conn.prepareStatement(&quot;SELECT patients.* FROM representatives, patients &quot;</span>
					+ &quot;WHERE RepresenterMID=? AND RepresenteeMID=patients.MID&quot;);
<span class="fc" id="L445">			ps.setLong(1, pid);</span>
<span class="fc" id="L446">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L447">			List&lt;PatientBean&gt; loadlist = patientLoader.loadList(rs);</span>
<span class="fc" id="L448">			rs.close();</span>
<span class="fc" id="L449">			ps.close();</span>
<span class="fc" id="L450">			return loadlist;</span>
<span class="fc" id="L451">		} catch (SQLException e) {</span>
			
<span class="fc" id="L453">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L455">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Return a list of patients that the given patient represents
	 * 
	 * @param pid The MID of the patient in question.
	 * @return A java.util.List of PatientBeans
	 * @throws DBException
	 */
	public List&lt;PatientBean&gt; getDependents(long pid) throws DBException {
<span class="fc" id="L467">		Connection conn = null;</span>
<span class="fc" id="L468">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L470">			conn = factory.getConnection();</span>
<span class="fc" id="L471">			ps = conn.prepareStatement(&quot;SELECT patients.* FROM representatives, patients, users &quot;</span>
					+ &quot;WHERE RepresenterMID=? AND RepresenteeMID=patients.MID AND users.MID=patients.MID AND users.isDependent=1&quot;);
<span class="fc" id="L473">			ps.setLong(1, pid);</span>
<span class="fc" id="L474">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L475">			List&lt;PatientBean&gt; loadlist = patientLoader.loadList(rs);</span>
<span class="fc" id="L476">			rs.close();</span>
<span class="fc" id="L477">			ps.close();</span>
<span class="fc" id="L478">			return loadlist;</span>
<span class="nc" id="L479">		} catch (SQLException e) {</span>
			
<span class="nc" id="L481">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L483">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Return a list of patients that the given patient is represented by
	 * 
	 * @param pid The MID of the patient in question.
	 * @return A java.util.List of PatientBeans.
	 * @throws DBException
	 */
	public List&lt;PatientBean&gt; getRepresenting(long pid) throws DBException {
<span class="fc" id="L495">		Connection conn = null;</span>
<span class="fc" id="L496">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L498">			conn = factory.getConnection();</span>
<span class="fc" id="L499">			ps = conn.prepareStatement(&quot;SELECT patients.* FROM representatives, patients &quot;</span>
					+ &quot;WHERE RepresenteeMID=? AND RepresenterMID=patients.MID&quot;);
<span class="fc" id="L501">			ps.setLong(1, pid);</span>
<span class="fc" id="L502">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L503">			List&lt;PatientBean&gt; loadlist = patientLoader.loadList(rs);</span>
<span class="fc" id="L504">			rs.close();</span>
<span class="fc" id="L505">			ps.close();</span>
<span class="fc" id="L506">			return loadlist;</span>
<span class="nc" id="L507">		} catch (SQLException e) {</span>
			
<span class="nc" id="L509">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L511">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Check if the given representer represents the representee
	 * 
	 * @param representer The MID of the representer in question.
	 * @param representee The MID of the representee in question.
	 * @return A boolean indicating whether represenation is in place.
	 * @throws DBException
	 */
	public boolean represents(long representer, long representee) throws DBException {
<span class="fc" id="L524">		Connection conn = null;</span>
<span class="fc" id="L525">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L527">			conn = factory.getConnection();</span>
<span class="fc" id="L528">			ps = conn</span>
<span class="fc" id="L529">					.prepareStatement(&quot;SELECT * FROM representatives WHERE RepresenterMID=? AND RepresenteeMID=?&quot;);</span>
<span class="fc" id="L530">			ps.setLong(1, representer);</span>
<span class="fc" id="L531">			ps.setLong(2, representee);</span>
<span class="fc" id="L532">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L533">			boolean check = rs.next();</span>
<span class="fc" id="L534">			rs.close();</span>
<span class="fc" id="L535">			ps.close();</span>
<span class="fc" id="L536">			return check;</span>
<span class="fc" id="L537">		} catch (SQLException e) {</span>
			
<span class="fc" id="L539">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L541">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Assign a representer to the representee
	 * 
	 * @param representer The MID of the representer as a long.
	 * @param representee The MID of the representee as a long.
	 * @return A boolean as to whether the insertion was correct.
	 * @throws DBException
	 * @throws ITrustException
	 */
	public boolean addRepresentative(long representer, long representee) throws DBException, ITrustException {
<span class="fc" id="L555">		Connection conn = null;</span>
<span class="fc" id="L556">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L558">			conn = factory.getConnection();</span>
<span class="fc" id="L559">			ps = conn</span>
<span class="fc" id="L560">					.prepareStatement(&quot;INSERT INTO representatives(RepresenterMID,RepresenteeMID) VALUES (?,?)&quot;);</span>
<span class="fc" id="L561">			ps.setLong(1, representer);</span>
<span class="fc" id="L562">			ps.setLong(2, representee);</span>
			
<span class="pc bpc" id="L564" title="1 of 2 branches missed.">			boolean check = (1 == ps.executeUpdate());</span>
<span class="fc" id="L565">			ps.close();</span>
<span class="fc" id="L566">			return check;</span>
<span class="fc" id="L567">		} catch (SQLException e) {</span>
<span class="fc bfc" id="L568" title="All 2 branches covered.">			if (1062 == e.getErrorCode())</span>
<span class="fc" id="L569">				throw new ITrustException(&quot;Patient &quot; + representer + &quot; already represents patient &quot;</span>
						+ representee);
			
<span class="fc" id="L572">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L574">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	public boolean checkIfRepresenteeIsActive(long representee) throws DBException
	{
<span class="fc" id="L580">		Connection conn = null;</span>
<span class="fc" id="L581">		PreparedStatement ps = null;</span>
		try {
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">			if (representee == 0L) throw new SQLException(&quot;pid cannot be 0&quot;);</span>
<span class="fc" id="L584">			conn = factory.getConnection();</span>
<span class="fc" id="L585">			ps = conn.prepareStatement(&quot;SELECT * FROM patients WHERE MID=? AND DateOfDeactivation IS NULL&quot;);</span>
<span class="fc" id="L586">			ps.setLong(1, representee);</span>
<span class="fc" id="L587">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L588">			PatientBean bean = new PatientBean();</span>
<span class="pc bpc" id="L589" title="1 of 2 branches missed.">			if(rs.next())</span>
<span class="fc" id="L590">				bean = patientLoader.loadSingle(rs);</span>
<span class="fc" id="L591">			rs.close();</span>
<span class="fc" id="L592">			ps.close();</span>
<span class="pc bpc" id="L593" title="1 of 2 branches missed.">			if(bean.getMID() == representee)</span>
<span class="fc" id="L594">				return true;</span>
<span class="nc" id="L595">			return false;</span>
<span class="nc" id="L596">		} catch (SQLException e) {</span>
			
<span class="nc" id="L598">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L600">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	public boolean checkIfPatientIsActive(long pid) throws ITrustException
	{
<span class="fc" id="L606">		Connection conn = null;</span>
<span class="fc" id="L607">		PreparedStatement ps = null;</span>
		try {
<span class="fc bfc" id="L609" title="All 2 branches covered.">			if (pid == 0L) throw new SQLException(&quot;pid cannot be 0&quot;);</span>
<span class="fc" id="L610">			conn = factory.getConnection();</span>
<span class="fc" id="L611">			ps = conn.prepareStatement(&quot;SELECT * FROM patients WHERE MID=? AND DateOfDeactivation IS NULL&quot;);</span>
<span class="fc" id="L612">			ps.setLong(1, pid);</span>
<span class="fc" id="L613">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L614">			PatientBean bean = new PatientBean();</span>
<span class="pc bpc" id="L615" title="1 of 2 branches missed.">			if(rs.next())</span>
<span class="nc" id="L616">				bean = patientLoader.loadSingle(rs);</span>
<span class="fc" id="L617">			rs.close();</span>
<span class="fc" id="L618">			ps.close();</span>
<span class="pc bpc" id="L619" title="1 of 2 branches missed.">			if(bean.getMID() == pid)</span>
<span class="nc" id="L620">				return true;</span>
<span class="fc" id="L621">			return false;</span>
<span class="fc" id="L622">		} catch (SQLException e) {</span>
			
<span class="fc" id="L624">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L626">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Unassign the representation
	 * 
	 * @param representer The MID of the representer in question.
	 * @param representee The MID of the representee in question.
	 * @return A boolean indicating whether the unassignment was sucessful.
	 * @throws DBException
	 */
	public boolean removeRepresentative(long representer, long representee) throws DBException {
<span class="fc" id="L639">		Connection conn = null;</span>
<span class="fc" id="L640">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L642">			conn = factory.getConnection();</span>
<span class="fc" id="L643">			ps = conn</span>
<span class="fc" id="L644">					.prepareStatement(&quot;DELETE FROM representatives WHERE RepresenterMID=? AND RepresenteeMID=?&quot;);</span>
<span class="fc" id="L645">			ps.setLong(1, representer);</span>
<span class="fc" id="L646">			ps.setLong(2, representee);</span>
<span class="fc bfc" id="L647" title="All 2 branches covered.">			return 1 == ps.executeUpdate();</span>
<span class="fc" id="L648">		} catch (SQLException e) {</span>
			
<span class="fc" id="L650">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L652">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Removes all dependencies represented by the patient passed in the parameter
	 * 
	 * @param representerMID the mid for the patient to remove all representees for
	 * @throws DBException
	 */
	public void removeAllRepresented(long representerMID) throws DBException {
<span class="fc" id="L663">		Connection conn = null;</span>
<span class="fc" id="L664">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L666">			conn = factory.getConnection();</span>
<span class="fc" id="L667">			ps = conn.prepareStatement(&quot;UPDATE users U, representatives R SET U.isDependent=0 WHERE R.representerMID=? AND &quot;</span>
					+ &quot;R.representeeMID=U.MID AND R.representeeMID NOT IN &quot;
					+ &quot;(SELECT representeeMID FROM representatives WHERE representerMID&lt;&gt;?)&quot;);
<span class="fc" id="L670">			ps.setLong(1, representerMID);</span>
<span class="fc" id="L671">			ps.setLong(2, representerMID);</span>
<span class="fc" id="L672">			ps.executeUpdate();</span>
<span class="fc" id="L673">			ps.close();</span>
<span class="fc" id="L674">			ps = conn.prepareStatement(&quot;DELETE FROM representatives WHERE representerMID=?&quot;);</span>
<span class="fc" id="L675">			ps.setLong(1, representerMID);</span>
<span class="fc" id="L676">			ps.executeUpdate();</span>
<span class="fc" id="L677">			ps.close();</span>
<span class="fc" id="L678">		} catch (SQLException e) {</span>
			
<span class="fc" id="L680">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L682">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L683">		}</span>
<span class="fc" id="L684">	}</span>
	
	/**
	 * Removes all dependencies participated by the patient passed in the parameter
	 * 
	 * @param representerMID the mid for the patient to remove all representees for
	 * @throws DBException
	 */
	public void removeAllRepresentee(long representeeMID) throws DBException {
<span class="fc" id="L693">		Connection conn = null;</span>
<span class="fc" id="L694">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L696">			conn = factory.getConnection();</span>
<span class="fc" id="L697">			ps = conn.prepareStatement(&quot;DELETE FROM representatives WHERE representeeMID=?&quot;);</span>
<span class="fc" id="L698">			ps.setLong(1, representeeMID);</span>
<span class="fc" id="L699">			ps.executeUpdate();</span>
<span class="fc" id="L700">			ps.close();</span>
<span class="fc" id="L701">			ps = conn.prepareStatement(&quot;UPDATE users SET isDependent=0 WHERE MID=?&quot;);</span>
<span class="fc" id="L702">			ps.setLong(1, representeeMID);</span>
<span class="fc" id="L703">			ps.executeUpdate();</span>
<span class="fc" id="L704">			ps.close();</span>
<span class="nc" id="L705">		} catch (SQLException e) {</span>
			
<span class="nc" id="L707">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L709">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L710">		}</span>
<span class="fc" id="L711">	}</span>

	/**
	 * Return a list of all diagnoses for a given patient
	 * 
	 * @param pid The MID of the patient in question.
	 * @return A java.util.List of Diagnoses.
	 * @throws DBException
	 */
	public List&lt;DiagnosisBean&gt; getDiagnoses(long pid) throws DBException {
<span class="fc" id="L721">		Connection conn = null;</span>
<span class="fc" id="L722">		PreparedStatement ps = null;</span>
		try {
<span class="fc bfc" id="L724" title="All 2 branches covered.">			if (pid == 0L) throw new SQLException(&quot;pid cannot be 0&quot;);</span>
<span class="fc" id="L725">			conn = factory.getConnection();</span>
<span class="fc" id="L726">			ps = conn.prepareStatement(&quot;SELECT * FROM ovdiagnosis ovd, officevisits ov, icdcodes icd &quot;</span>
					+ &quot;WHERE ovd.VisitID=ov.ID and icd.Code=ovd.ICDCode and ov.PatientID=? &quot;
					+ &quot;ORDER BY ov.visitDate DESC&quot;);
<span class="fc" id="L729">			ps.setLong(1, pid);</span>
<span class="fc" id="L730">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L731">			List&lt;DiagnosisBean&gt; loadlist = diagnosisLoader.loadList(rs);</span>
<span class="fc" id="L732">			rs.close();</span>
<span class="fc" id="L733">			ps.close();</span>
<span class="fc" id="L734">			return loadlist;</span>
<span class="fc" id="L735">		} catch (SQLException e) {</span>
			
<span class="fc" id="L737">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L739">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
 
	/**
	 * Return a list of all procedures for a given patient
	 * 
	 * @param pid The MID of the patient in question.
	 * @return A java.util.List of all the procedures.
	 * @throws DBException
	 */
	public List&lt;ProcedureBean&gt; getProcedures(long pid) throws DBException {
<span class="fc" id="L751">		Connection conn = null;</span>
<span class="fc" id="L752">		PreparedStatement ps = null;</span>
		try {
<span class="pc bpc" id="L754" title="1 of 2 branches missed.">			if (pid == 0L) throw new SQLException(&quot;pid cannot be 0&quot;);</span>
<span class="fc" id="L755">			conn = factory.getConnection();</span>
<span class="fc" id="L756">			ps = conn.prepareStatement(&quot;Select * From ovprocedure ovp, officevisits ov, cptcodes cpt &quot;</span>
					+ &quot;Where ovp.VisitID=ov.ID and cpt.code=ovp.cptcode and ov.patientID=? &quot;
					+ &quot;ORDER BY ov.visitDate desc&quot;);
<span class="fc" id="L759">			ps.setLong(1, pid);</span>
<span class="fc" id="L760">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L761">			List&lt;ProcedureBean&gt; loadlist = procedureLoader.loadList(rs);</span>
<span class="fc" id="L762">			rs.close();</span>
<span class="fc" id="L763">			ps.close();</span>
<span class="fc" id="L764">			return loadlist;</span>
<span class="nc" id="L765">		} catch (SQLException e) {</span>
			
<span class="nc" id="L767">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L769">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Return a list of all immunization procedures for a given patient
	 * 
	 * @param pid The MID of the patient in question.
	 * @return A java.util.List of the procedures.
	 * @throws DBException
	 */
	public List&lt;ProcedureBean&gt; getImmunizationProcedures(long pid) throws DBException {
<span class="nc" id="L781">		Connection conn = null;</span>
<span class="nc" id="L782">		PreparedStatement ps = null;</span>
		try {
<span class="nc bnc" id="L784" title="All 2 branches missed.">			if (pid == 0L) throw new SQLException(&quot;pid cannot be 0&quot;);</span>
<span class="nc" id="L785">			conn = factory.getConnection();</span>
<span class="nc" id="L786">			ps = conn.prepareStatement(&quot;Select * From ovprocedure ovp, officevisits ov, cptcodes cpt &quot;</span>
					+ &quot;Where ovp.VisitID=ov.ID and cpt.code=ovp.cptcode and ov.patientID=? and cpt.attribute='immunization'&quot;
					+ &quot;ORDER BY ov.visitDate desc&quot;);
<span class="nc" id="L789">			ps.setLong(1, pid);</span>
<span class="nc" id="L790">			ResultSet rs = ps.executeQuery();</span>
<span class="nc" id="L791">			List&lt;ProcedureBean&gt; loadlist = procedureLoader.loadList(rs);</span>
<span class="nc" id="L792">			rs.close();</span>
<span class="nc" id="L793">			ps.close();</span>
<span class="nc" id="L794">			return loadlist;</span>
<span class="nc" id="L795">		} catch (SQLException e) {</span>
			
<span class="nc" id="L797">			throw new DBException(e);</span>
		} finally {
<span class="nc" id="L799">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	
	/**
	 * Return a list of all prescriptions for a patient
	 * 
	 * @param patientID The MID of the patient in question.
	 * @return A java.util.List of prescriptions.
	 * @throws DBException
	 */
	public List&lt;PrescriptionBean&gt; getPrescriptions(long patientID) throws DBException {
<span class="fc" id="L812">		Connection conn = null;</span>
<span class="fc" id="L813">		PreparedStatement ps = null;</span>
		try {
<span class="pc bpc" id="L815" title="1 of 2 branches missed.">			if (patientID == 0L) throw new SQLException(&quot;pid cannot be 0&quot;);</span>
<span class="fc" id="L816">			conn = factory.getConnection();</span>
<span class="fc" id="L817">			ps = conn.prepareStatement(&quot;Select * From ovmedication,ndcodes,officevisits &quot;</span>
					+ &quot;Where officevisits.PatientID = ? AND ovmedication.VisitID = &quot;
					+ &quot;officevisits.ID AND ndcodes.Code=ovmedication.NDCode &quot;
					+ &quot;ORDER BY officevisits.visitDate DESC, ovmedication.NDCode ASC;&quot;);
<span class="fc" id="L821">			ps.setLong(1, patientID);</span>
<span class="fc" id="L822">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L823">			List&lt;PrescriptionBean&gt; loadlist = prescriptionLoader.loadList(rs);</span>
<span class="fc" id="L824">			rs.close();</span>
<span class="fc" id="L825">			ps.close();</span>
<span class="fc" id="L826">			return loadlist;</span>
<span class="nc" id="L827">		} catch (SQLException e) {</span>
			
<span class="nc" id="L829">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L831">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Return a list of prescriptions which are currently prescribed for a patient
	 * 
	 * @param patientID The MID of the patient in question.
	 * @return A java.util.List of prescription beans.
	 * @throws DBException
	 */
	public List&lt;PrescriptionBean&gt; getCurrentPrescriptions(long patientID) throws DBException {
<span class="fc" id="L843">		Connection conn = null;</span>
<span class="fc" id="L844">		PreparedStatement ps = null;</span>
		try {
<span class="pc bpc" id="L846" title="1 of 2 branches missed.">			if (patientID == 0L) throw new SQLException(&quot;pid cannot be 0&quot;);</span>
<span class="fc" id="L847">			conn = factory.getConnection();</span>
			
<span class="fc" id="L849">			ps = conn.prepareStatement(&quot;Select * From ovmedication,ndcodes,officevisits &quot;</span>
					+ &quot;Where officevisits.PatientID = ? AND ovmedication.VisitID = &quot;
					+ &quot;officevisits.ID AND ndcodes.Code=ovmedication.NDCode AND &quot;
					+ &quot;ovmedication.EndDate &gt;= ?&quot; + &quot;ORDER BY ovmedication.ID DESC;&quot;);
<span class="fc" id="L853">			ps.setLong(1, patientID);</span>
<span class="fc" id="L854">			ps.setDate(2, DateUtil.getSQLdateXDaysAgoFromNow(0));</span>
<span class="fc" id="L855">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L856">			List&lt;PrescriptionBean&gt; loadlist = prescriptionLoader.loadList(rs);</span>
<span class="fc" id="L857">			rs.close();</span>
<span class="fc" id="L858">			ps.close();</span>
<span class="fc" id="L859">			return loadlist;</span>
<span class="nc" id="L860">		} catch (SQLException e) {</span>
			
<span class="nc" id="L862">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L864">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Return a list of prescriptions which are expired prescription for a patient
	 * 
	 * @param patientID The MID of the patient in question.
	 * @return A java.util.List of prescriptions.
	 * @throws DBException
	 **/
	 
	public List&lt;PrescriptionBean&gt; getExpiredPrescriptions (long patientID) throws DBException {
<span class="fc" id="L877">		Connection conn = null;</span>
<span class="fc" id="L878">		PreparedStatement ps = null;</span>
		try {
<span class="fc bfc" id="L880" title="All 2 branches covered.">			if (patientID == 0L) throw new SQLException(&quot;pid cannot be 0&quot;);</span>
<span class="fc" id="L881">			conn = factory.getConnection();</span>
<span class="fc" id="L882">			ps = conn.prepareStatement(&quot;Select * From ovmedication,ndcodes,officevisits &quot;</span>
					+ &quot;Where officevisits.PatientID = ? AND ovmedication.VisitID = &quot;
					+ &quot;officevisits.ID AND ndcodes.Code=ovmedication.NDCode AND &quot;
					+ &quot;ovmedication.EndDate &lt; ?&quot; + &quot;ORDER BY ovmedication.ID DESC;&quot;);
<span class="fc" id="L886">			ps.setLong(1, patientID);</span>
<span class="fc" id="L887">			ps.setDate(2, DateUtil.getSQLdateXDaysAgoFromNow(0));</span>
<span class="fc" id="L888">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L889">			List&lt;PrescriptionBean&gt; loadlist = prescriptionLoader.loadList(rs);</span>
<span class="fc" id="L890">			rs.close();</span>
<span class="fc" id="L891">			ps.close();</span>
<span class="fc" id="L892">			return loadlist;</span>
<span class="fc" id="L893">		} catch (SQLException e) {</span>
			
<span class="fc" id="L895">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L897">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Lists every patient in the database.
	 * 
	 * @return A java.util.List of PatientBeans representing the patients.
	 * @throws DBException
	 */
	public List&lt;PatientBean&gt; getAllPatients() throws DBException {
<span class="fc" id="L908">		Connection conn = null;</span>
<span class="fc" id="L909">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L911">			conn = factory.getConnection();</span>
<span class="fc" id="L912">			ps = conn.prepareStatement(&quot;SELECT * FROM patients &quot;);</span>
<span class="fc" id="L913">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L914">			List&lt;PatientBean&gt; loadlist = patientLoader.loadList(rs);</span>
<span class="fc" id="L915">			rs.close();</span>
<span class="fc" id="L916">			ps.close();</span>
<span class="fc" id="L917">			return loadlist;</span>
<span class="nc" id="L918">		} catch (SQLException e) {</span>
			
<span class="nc" id="L920">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L922">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Return a list of patients with a special-diagnosis-history who
	 * have the logged in HCP as a DHCP and whose medications are going to
	 * expire within seven days.
	 * 
	 * @param hcpMID The MID of the logged in HCP
	 * @return A list of patients satisfying the conditions.
	 * @throws DBException
	 */
	public List&lt;PatientBean&gt; getRenewalNeedsPatients(long hcpMID) throws DBException {
<span class="fc" id="L936">		Connection conn = null;</span>
<span class="fc" id="L937">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L939">			conn = factory.getConnection();</span>
			
				
<span class="fc" id="L942">				ps = conn.prepareStatement(&quot;SELECT * FROM ( &quot; + </span>

				&quot;SELECT DISTINCT patients.* From patients, declaredhcp, ovdiagnosis, officevisits, ovmedication &quot; + 
				&quot;Where &quot; + 
				
				&quot;declaredhcp.HCPID = ? AND &quot; + 
				&quot;patients.MID = declaredhcp.PatientID AND &quot; + 
				
				
				&quot;( &quot; + 
				&quot;ovdiagnosis.VisitID = officevisits.ID AND officevisits.PatientID = declaredhcp.PatientID &quot; + 
				&quot;AND &quot; + 
				
				&quot;((ovdiagnosis.ICDCode &gt;= ? AND ovdiagnosis.ICDCode &lt; ?) &quot; + 
				&quot;OR (ovdiagnosis.ICDCode &gt;= ? AND ovdiagnosis.ICDCode &lt; ?) &quot; + 
				&quot;OR (ovdiagnosis.ICDCode &gt;= ? AND ovdiagnosis.ICDCode &lt; ?)) &quot; + 
				&quot;) &quot; + 
				
				
				
				&quot;UNION ALL &quot; + 
				
				
				&quot;SELECT DISTINCT patients.* From patients, declaredhcp, ovdiagnosis, officevisits, ovmedication &quot; + 
				&quot;Where &quot; + 
				
				&quot;declaredhcp.HCPID = ? AND &quot; + 
				&quot;patients.MID = declaredhcp.PatientID AND &quot; + 
				
				&quot;( &quot; + 
				&quot;declaredhcp.PatientID = officevisits.PatientID AND officevisits.ID = ovmedication.VisitID &quot; + 
				&quot;AND &quot; + 
				&quot;ovmedication.EndDate BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 7 DAY) &quot; + 
				&quot;) &quot; + 
				
				&quot;) AS final &quot; + 
				
				&quot;GROUP BY final.MID HAVING COUNT(*) = 2 &quot; + 
				
				&quot;ORDER BY final.lastname ASC, final.firstname ASC&quot;); 
			
<span class="fc" id="L983">			ps.setLong(1, hcpMID);</span>
			
<span class="fc" id="L985">			ps.setFloat(2, 250.0f);</span>
<span class="fc" id="L986">			ps.setFloat(3, 251.0f);</span>
				
<span class="fc" id="L988">			ps.setFloat(4, 493.0f);</span>
<span class="fc" id="L989">			ps.setFloat(5, 494.0f);</span>
			
<span class="fc" id="L991">			ps.setFloat(6, 390.0f);</span>
<span class="fc" id="L992">			ps.setFloat(7, 460.99f);</span>

<span class="fc" id="L994">			ps.setLong(8, hcpMID);</span>
			
<span class="fc" id="L996">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L997">			List&lt;PatientBean&gt; loadlist = patientLoader.loadList(rs);</span>
<span class="fc" id="L998">			rs.close();</span>
<span class="fc" id="L999">			ps.close();</span>
<span class="fc" id="L1000">			return loadlist;</span>
<span class="fc" id="L1001">		} catch (SQLException e) {</span>
			
<span class="fc" id="L1003">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L1005">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Returns all patients with names &quot;LIKE&quot; (as in SQL) the passed in parameters.
	 * 
	 * @param first The patient's first name.
	 * @param last The patient's last name.
	 * @return A java.util.List of PatientBeans.
	 * @throws DBException
	 */
	public List&lt;PatientBean&gt; searchForPatientsWithName(String first, String last) throws DBException {
<span class="fc" id="L1018">		Connection conn = null;</span>
<span class="fc" id="L1019">		PreparedStatement ps = null;</span>
		
<span class="pc bpc" id="L1021" title="1 of 4 branches missed.">		if (first.equals(&quot;%&quot;) &amp;&amp; last.equals(&quot;%&quot;)) return new Vector&lt;PatientBean&gt;();</span>
		
		try {
<span class="fc" id="L1024">			conn = factory.getConnection();</span>
			
<span class="fc" id="L1026">			ps = conn.prepareStatement(&quot;SELECT * FROM patients WHERE firstName LIKE ? AND lastName LIKE ?&quot;);</span>
<span class="fc" id="L1027">			ps.setString(1, first);</span>
<span class="fc" id="L1028">			ps.setString(2, last);</span>
<span class="fc" id="L1029">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L1030">			List&lt;PatientBean&gt; loadlist = patientLoader.loadList(rs);</span>
<span class="fc" id="L1031">			rs.close();</span>
<span class="fc" id="L1032">			ps.close();</span>
<span class="fc" id="L1033">			return loadlist;</span>
<span class="nc" id="L1034">		} catch (SQLException e) {</span>
			
<span class="nc" id="L1036">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L1038">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Returns all patients with names &quot;LIKE&quot; with wildcards (as in SQL) the passed in parameters.
	 * 
	 * @param first The patient's first name.
	 * @param last The patient's last name.
	 * @return A java.util.List of PatientBeans.
	 * @throws DBException
	 */
	public List&lt;PatientBean&gt; fuzzySearchForPatientsWithName(String first, String last) throws DBException {
<span class="fc" id="L1051">		Connection conn = null;</span>
<span class="fc" id="L1052">		PreparedStatement ps = null;</span>
		
<span class="pc bpc" id="L1054" title="3 of 4 branches missed.">		if (first.equals(&quot;%&quot;) &amp;&amp; last.equals(&quot;%&quot;)) return new Vector&lt;PatientBean&gt;();</span>
		
		try {
<span class="fc" id="L1057">			conn = factory.getConnection();</span>
			
<span class="fc" id="L1059">			ps = conn.prepareStatement(&quot;SELECT * FROM patients WHERE firstName LIKE ? AND lastName LIKE ?&quot;);</span>
<span class="fc" id="L1060">			ps.setString(1, &quot;%&quot;+first+&quot;%&quot;);</span>
<span class="fc" id="L1061">			ps.setString(2, &quot;%&quot;+last+&quot;%&quot;);</span>
			
<span class="fc" id="L1063">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L1064">			List&lt;PatientBean&gt; loadlist = patientLoader.loadList(rs);</span>
<span class="fc" id="L1065">			rs.close();</span>
<span class="fc" id="L1066">			ps.close();</span>
<span class="fc" id="L1067">			return loadlist;</span>
<span class="nc" id="L1068">		} catch (SQLException e) {</span>
			
<span class="nc" id="L1070">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L1072">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Returns all patients with the given MID as a substring in their MID
	 * @param MID the patients MID
	 * @return list of patients with that MID as a substring
	 * @throws DBException
	 */
	public List&lt;PatientBean&gt; fuzzySearchForPatientsWithMID(long MID) throws DBException {
<span class="fc" id="L1083">		Connection conn = null;</span>
<span class="fc" id="L1084">		PreparedStatement ps = null;</span>
		
		
		try {
<span class="fc" id="L1088">			conn = factory.getConnection();</span>
			
<span class="fc" id="L1090">			ps = conn.prepareStatement(&quot;SELECT * FROM patients WHERE MID LIKE ? ORDER BY MID&quot;);</span>
<span class="fc" id="L1091">			ps.setString(1, &quot;%&quot;+MID+&quot;%&quot;);</span>
			
<span class="fc" id="L1093">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L1094">			List&lt;PatientBean&gt; loadlist = patientLoader.loadList(rs);</span>
<span class="fc" id="L1095">			rs.close();</span>
<span class="fc" id="L1096">			ps.close();</span>
<span class="fc" id="L1097">			return loadlist;</span>
<span class="nc" id="L1098">		} catch (SQLException e) {</span>
			
<span class="nc" id="L1100">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L1102">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Allows a patient to add a designated nutritionist. Only
	 * the designated nutritionist will be able to view the patient's
	 * nutritional information.
	 */
	public int addDesignatedNutritionist(long patientMID, long HCPID) 
			throws DBException {
<span class="fc" id="L1113">		Connection conn = null;</span>
<span class="fc" id="L1114">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L1116">			conn = factory.getConnection();</span>
<span class="fc" id="L1117">			ps = conn.prepareStatement(&quot;INSERT INTO &quot;</span>
					+ &quot;designatedNutritionist(PatientID, HCPID) VALUES(?,?);&quot;);
<span class="fc" id="L1119">			ps.setLong(1, patientMID);</span>
<span class="fc" id="L1120">			ps.setLong(2, HCPID);</span>
<span class="fc" id="L1121">			int updated = ps.executeUpdate();</span>
<span class="fc" id="L1122">			return updated;</span>
<span class="nc" id="L1123">		} catch (SQLException e) {</span>
<span class="nc" id="L1124">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L1126">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Returns the ID of the designated nutritionist for the patient
	 * returns -1 if the patient does not have a designated nutritionist
	 */
	public long getDesignatedNutritionist(long patientMID) 
			throws DBException {
<span class="fc" id="L1136">		Connection conn = null;</span>
<span class="fc" id="L1137">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L1139">			conn = factory.getConnection();</span>
<span class="fc" id="L1140">			ps = conn.prepareStatement(&quot;SELECT HCPID FROM &quot;</span>
					+ &quot;designatedNutritionist WHERE PatientID = ?;&quot;);
<span class="fc" id="L1142">			ps.setLong(1, patientMID);</span>
<span class="fc" id="L1143">			ResultSet results = ps.executeQuery();</span>
<span class="fc" id="L1144">			long desNutr = -1;</span>
			//if it has a next one
<span class="fc bfc" id="L1146" title="All 2 branches covered.">			if (results.next()) {</span>
<span class="fc" id="L1147">				desNutr = results.getLong(1);</span>
			}
<span class="fc" id="L1149">			results.close();</span>
<span class="fc" id="L1150">			ps.close();</span>
<span class="fc" id="L1151">			return desNutr;</span>
<span class="fc" id="L1152">		} catch (SQLException e) {</span>
<span class="fc" id="L1153">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L1155">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Updates the designated nutritionist for this patient.
	 * Assumes that the patient already has a designated nutritionist.
	 */
	public int updateDesignatedNutritionist(long patientMID, long HCPID) 
			throws DBException {
<span class="fc" id="L1165">		Connection conn = null;</span>
<span class="fc" id="L1166">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L1168">			conn = factory.getConnection();</span>
<span class="fc" id="L1169">			ps = conn.prepareStatement(&quot;UPDATE designatedNutritionist &quot;</span>
					+ &quot;SET HCPID = ? WHERE PatientID = ?;&quot;);
<span class="fc" id="L1171">			ps.setLong(1, HCPID);</span>
<span class="fc" id="L1172">			ps.setLong(2, patientMID);</span>
<span class="fc" id="L1173">			int numUpdated = ps.executeUpdate();</span>
<span class="fc" id="L1174">			ps.close();</span>
<span class="fc" id="L1175">			return numUpdated;</span>
<span class="nc" id="L1176">		} catch (SQLException e) {</span>
<span class="nc" id="L1177">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L1179">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Deletes the designated nutritionist for this patient.
	 * Assumes that the patient already has a designated nutritionist
	 */
	public int deleteDesignatedNutritionist(long patientMID) 
			throws DBException {
<span class="fc" id="L1189">		Connection conn = null;</span>
<span class="fc" id="L1190">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L1192">			conn = factory.getConnection();</span>
<span class="fc" id="L1193">			ps = conn.prepareStatement(&quot;DELETE FROM designatedNutritionist &quot;</span>
					+ &quot;WHERE PatientID = ?;&quot;);
<span class="fc" id="L1195">			ps.setLong(1, patientMID);</span>
<span class="fc" id="L1196">			int numDeleted = ps.executeUpdate();</span>
<span class="fc" id="L1197">			ps.close();</span>
<span class="fc" id="L1198">			return numDeleted;</span>
<span class="nc" id="L1199">		} catch (SQLException e) {</span>
<span class="nc" id="L1200">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L1202">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>