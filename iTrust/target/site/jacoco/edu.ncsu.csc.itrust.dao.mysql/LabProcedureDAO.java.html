<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>LabProcedureDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.dao.mysql</a> &gt; <span class="el_source">LabProcedureDAO.java</span></div><h1>LabProcedureDAO.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.dao.mysql;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;
import edu.ncsu.csc.itrust.DBUtil;
import edu.ncsu.csc.itrust.beans.LabProcedureBean;
import edu.ncsu.csc.itrust.beans.loaders.LabProcedureBeanLoader;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.exception.DBException;

/**
 * A DAO for managing lab procedure codes. Database Access Object. All info coming into a DAO is already validated. 
 * Just worry about DB stuff here. Note that all DAOs need to have a DAOFactory with which to access other 
 * DAOs and to get connections. Also, every DAO must have a constructor with a DAOFactory as a parameter.
 */
public class LabProcedureDAO {
	private DAOFactory factory;
	private LabProcedureBeanLoader labProcedureLoader;

	/**
	 * The typical constructor.
	 * @param factory The {@link DAOFactory} associated with this DAO, which is used for obtaining SQL connections, etc.
	 */
<span class="fc" id="L27">	public LabProcedureDAO(DAOFactory factory) {</span>
<span class="fc" id="L28">		this.factory = factory;</span>
<span class="fc" id="L29">		labProcedureLoader = new LabProcedureBeanLoader();</span>
<span class="fc" id="L30">	}</span>
	
	/**
	 * Get a list of the lab procedures associated with a given patient.
	 * @param id The MID of the patient as a long.
	 * @return A java.util.List of LabProcedureBeans
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getLabProceduresForPatient(long id) throws DBException {
<span class="fc" id="L39">		Connection conn = null;</span>
<span class="fc" id="L40">		PreparedStatement ps = null;</span>

		try {
<span class="fc bfc" id="L43" title="All 2 branches covered.">			if (id == 0L) throw new SQLException(&quot;PatientMID cannot be null&quot;);</span>
<span class="fc" id="L44">			conn = factory.getConnection();</span>
<span class="fc" id="L45">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE PatientMID = ? AND Rights = ? ORDER BY UpdatedDate DESC&quot;);</span>
<span class="fc" id="L46">			ps.setLong(1, id);</span>
<span class="fc" id="L47">			ps.setString(2, LabProcedureBean.Allow);</span>
<span class="fc" id="L48">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L49">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L50">			rs.close();</span>
<span class="fc" id="L51">			ps.close();</span>
<span class="fc" id="L52">			return loadlist;</span>
<span class="fc" id="L53">		} catch (SQLException e) {</span>
			
<span class="fc" id="L55">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L57">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Get lab procedures for a specific office visit, but excluding lab 
	 * procedures which a patient does not have access to.
	 * 
	 * @param ovid Office visit id.
	 * @return
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getLabProceduresForPatientOV(long ovid) throws DBException {
<span class="fc" id="L70">		Connection conn = null;</span>
<span class="fc" id="L71">		PreparedStatement ps = null;</span>

		try {
<span class="fc" id="L74">			conn = factory.getConnection();</span>
<span class="fc" id="L75">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE OfficeVisitID = ? AND Rights = ? ORDER BY UpdatedDate DESC&quot;);</span>
<span class="fc" id="L76">			ps.setLong(1, ovid);</span>
<span class="fc" id="L77">			ps.setString(2, LabProcedureBean.Allow);</span>
<span class="fc" id="L78">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L79">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L80">			rs.close();</span>
<span class="fc" id="L81">			ps.close();</span>
<span class="fc" id="L82">			return loadlist;</span>
<span class="nc" id="L83">		} catch (SQLException e) {</span>
			
<span class="nc" id="L85">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L87">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Gets all the lab procedures for a given patient that occur within the next month.
	 * @param id The MID of the patient as a long.
	 * @return A java.util.List of LabProcedureBeans.
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getLabProceduresForPatientForNextMonth(long id) throws DBException {
<span class="fc" id="L98">		Connection conn = null;</span>
<span class="fc" id="L99">		PreparedStatement ps = null;</span>

		try {
<span class="fc bfc" id="L102" title="All 2 branches covered.">			if (id == 0L) throw new SQLException(&quot;PatientMID cannot be null&quot;);</span>
<span class="fc" id="L103">			conn = factory.getConnection();</span>
<span class="fc" id="L104">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE PatientMID = ? AND Rights = ? AND Status = ? AND (DateDiff(SYSDATE(),UpdatedDate) &lt;= 30) ORDER BY UpdatedDate DESC&quot;);</span>
<span class="fc" id="L105">			ps.setLong(1, id);</span>
<span class="fc" id="L106">			ps.setString(2, LabProcedureBean.Allow);</span>
<span class="fc" id="L107">			ps.setString(3, LabProcedureBean.Completed);</span>
<span class="fc" id="L108">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L109">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L110">			rs.close();</span>
<span class="fc" id="L111">			ps.close();</span>
<span class="fc" id="L112">			return loadlist;</span>
<span class="fc" id="L113">		} catch (SQLException e) {</span>
			
<span class="fc" id="L115">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L117">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Gets an individual lab procedure.
	 * @param id The ID of the lab procedure.
	 * @return A LabProcedureBean representing the procedure.
	 * @throws DBException
	 */
	public LabProcedureBean getLabProcedure(long id) throws DBException {
<span class="fc" id="L128">		Connection conn = null;</span>
<span class="fc" id="L129">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L131">			conn = factory.getConnection();</span>
<span class="fc" id="L132">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE LaboratoryProcedureID = ?&quot;);</span>
<span class="fc" id="L133">			ps.setLong(1, id);</span>
<span class="fc" id="L134">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L135">			rs.next();</span>
<span class="fc" id="L136">			LabProcedureBean loaded = labProcedureLoader.loadSingle(rs);</span>
<span class="fc" id="L137">			rs.close();</span>
<span class="fc" id="L138">			ps.close();</span>
<span class="fc" id="L139">			return loaded;</span>
<span class="fc" id="L140">		} catch (SQLException e) {</span>
			
<span class="fc" id="L142">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L144">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	/**
	 * Gets all procedures for Patient
	 * @param mid patient id
	 * @return A java.util.List of LabProcedureBeans.
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getAllLabProceduresDate(long mid) throws DBException {
<span class="fc" id="L154">		Connection conn = null;</span>
<span class="fc" id="L155">		PreparedStatement ps = null;</span>

		try {
<span class="fc bfc" id="L158" title="All 2 branches covered.">			if (mid == 0L) throw new SQLException(&quot;PatientMID cannot be null&quot;);</span>
<span class="fc" id="L159">			conn = factory.getConnection();</span>
<span class="fc" id="L160">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE PatientMID = ? ORDER BY UpdatedDate DESC&quot;);</span>
<span class="fc" id="L161">			ps.setLong(1, mid);</span>
<span class="fc" id="L162">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L163">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L164">			rs.close();</span>
<span class="fc" id="L165">			ps.close();</span>
<span class="fc" id="L166">			return loadlist;</span>
<span class="fc" id="L167">		} catch (SQLException e) {</span>
			
<span class="fc" id="L169">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L171">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	/**
	 * This gets all the procedures for a particular patient on a particular office visit
	 * @param mid The MID of the patient.
	 * @param ovid The Office Visit ID.
	 * @return A java.util.List of LabProcedureBeans.
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getAllLabProceduresForDocOV(long mid, long ovid) throws DBException {
<span class="fc" id="L182">		Connection conn = null;</span>
<span class="fc" id="L183">		PreparedStatement ps = null;</span>

		try {
<span class="fc bfc" id="L186" title="All 2 branches covered.">			if (mid == 0L) throw new SQLException(&quot;PatientMID cannot be null&quot;);</span>
<span class="fc" id="L187">			conn = factory.getConnection();</span>
<span class="fc" id="L188">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE PatientMID = ? AND OfficeVisitID = ? ORDER BY UpdatedDate DESC&quot;);</span>
<span class="fc" id="L189">			ps.setLong(1, mid);</span>
<span class="fc" id="L190">			ps.setLong(2, ovid);</span>
<span class="fc" id="L191">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L192">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L193">			rs.close();</span>
<span class="fc" id="L194">			ps.close();</span>
<span class="fc" id="L195">			return loadlist;</span>
<span class="fc" id="L196">		} catch (SQLException e) {</span>
			
<span class="fc" id="L198">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L200">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * This gets all the procedures for a particular patient on a particular office visit
	 * @param ovid The Office Visit ID.
	 * @return A java.util.List of LabProcedureBeans
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getAllLabProceduresForDocOV(long ovid) throws DBException {
<span class="fc" id="L211">		Connection conn = null;</span>
<span class="fc" id="L212">		PreparedStatement ps = null;</span>

		try {
<span class="fc" id="L215">			conn = factory.getConnection();</span>
<span class="fc" id="L216">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE OfficeVisitID = ? &quot;);</span>
<span class="fc" id="L217">			ps.setLong(1, ovid);</span>
<span class="fc" id="L218">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L219">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L220">			rs.close();</span>
<span class="fc" id="L221">			ps.close();</span>
<span class="fc" id="L222">			return loadlist;</span>
<span class="fc" id="L223">		} catch (SQLException e) {</span>
			
<span class="fc" id="L225">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L227">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Gets all lab procedures, period.
	 * @return A java.util.List of LabProcedureBeans.
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getAllLabProcedures() throws DBException {
<span class="fc" id="L237">		Connection conn = null;</span>
<span class="fc" id="L238">		PreparedStatement ps = null;</span>

		try {
<span class="fc" id="L241">			conn = factory.getConnection();</span>
<span class="fc" id="L242">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure ORDER BY UpdatedDate ASC&quot;);</span>
<span class="fc" id="L243">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L244">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L245">			rs.close();</span>
<span class="fc" id="L246">			ps.close();</span>
<span class="fc" id="L247">			return loadlist;</span>
<span class="fc" id="L248">		} catch (SQLException e) {</span>
			
<span class="fc" id="L250">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L252">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	
	/**
	 * Get all lab procedures associated with a particular HCP.
	 * @param mid The HCP's id.
	 * @return
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getHCPLabProcedures(long mid) throws DBException {
<span class="fc" id="L264">		Connection conn = null;</span>
<span class="fc" id="L265">		PreparedStatement ps = null;</span>

		try {
<span class="fc bfc" id="L268" title="All 2 branches covered.">			if (mid == 0L) throw new SQLException(&quot;HCP id cannot be null&quot;);</span>
<span class="fc" id="L269">			conn = factory.getConnection();</span>
<span class="fc" id="L270">			ps = conn.prepareStatement(</span>
					&quot;SELECT * FROM LabProcedure WHERE labprocedure.OfficeVisitID IN &quot; +
					    &quot;(SELECT officevisits.ID FROM officevisits WHERE officevisits.HCPID = ?)&quot;
					);
<span class="fc" id="L274">			ps.setLong(1, mid);</span>
<span class="fc" id="L275">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L276">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L277">			rs.close();</span>
<span class="fc" id="L278">			ps.close();</span>
<span class="fc" id="L279">			return loadlist;</span>
<span class="fc" id="L280">		} catch (SQLException e) {</span>
			
<span class="fc" id="L282">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L284">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Get all lab procedures associated with a particular HCP and Patient.
	 * @param mid The HCP's id.
	 * @return
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getLabProcedures(long mid, long pid) throws DBException {
<span class="fc" id="L295">		Connection conn = null;</span>
<span class="fc" id="L296">		PreparedStatement ps = null;</span>

		try {
<span class="fc bfc" id="L299" title="All 2 branches covered.">			if (mid == 0L) throw new SQLException(&quot;HCP id cannot be null&quot;);</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">			if (pid == 0L) throw new SQLException(&quot;HCP id cannot be null&quot;);</span>
<span class="fc" id="L301">			conn = factory.getConnection();</span>
<span class="fc" id="L302">			ps = conn.prepareStatement(</span>
					&quot;SELECT * FROM labprocedure WHERE labprocedure.OfficeVisitID IN &quot; +
					    &quot;(SELECT officevisits.ID FROM officevisits WHERE &quot; +
					    &quot; officevisits.HCPID = ? AND officevisits.PatientID = ?)&quot;
					);
<span class="fc" id="L307">			ps.setLong(1, mid);</span>
<span class="fc" id="L308">			ps.setLong(2, pid);</span>
<span class="fc" id="L309">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L310">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L311">			rs.close();</span>
<span class="fc" id="L312">			ps.close();</span>
<span class="fc" id="L313">			return loadlist;</span>
<span class="fc" id="L314">		} catch (SQLException e) {</span>
			
<span class="fc" id="L316">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L318">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Get a count of all pending lab procedures for a particular HCP.
	 * @param mid
	 * @return
	 * @throws DBException
	 */
	public int getHCPPendingCount(long mid) throws DBException {
<span class="fc" id="L329">		Connection conn = null;</span>
<span class="fc" id="L330">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L332">			int count = 0;</span>
<span class="fc" id="L333">			conn = factory.getConnection();</span>
<span class="fc" id="L334">			ps = conn.prepareStatement(</span>
					&quot;SELECT COUNT(*) FROM labprocedure WHERE Status = ? AND labprocedure.OfficeVisitID IN &quot; +
					    &quot;(SELECT officevisits.ID FROM officevisits WHERE officevisits.HCPID = ?)&quot;
					);
<span class="fc" id="L338">			ps.setString(1, LabProcedureBean.Pending);</span>
<span class="fc" id="L339">			ps.setLong(2, mid);</span>
<span class="fc" id="L340">			ResultSet rs = ps.executeQuery();</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L342">				count = rs.getInt(1);</span>
			}
<span class="fc" id="L344">			rs.close();</span>
<span class="fc" id="L345">			ps.close();</span>
<span class="fc" id="L346">			return count;</span>
<span class="nc" id="L347">		} catch (SQLException e) {</span>
			
<span class="nc" id="L349">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L351">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Gets the lab procedures for a given LHCP that occur within the next month.
	 * @param ovid The Office Visit ID conducted by the LHCP in question.
	 * @return A java.util.List of LabProcedureBeans.
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getLabProceduresForLHCPForNextMonth(long ovid) throws DBException {
<span class="fc" id="L362">		Connection conn = null;</span>
<span class="fc" id="L363">		PreparedStatement ps = null;</span>
		try {
<span class="fc bfc" id="L365" title="All 2 branches covered.">			if (ovid == 0L) throw new SQLException(&quot;OfficeVisitID cannot be null&quot;);</span>
<span class="fc" id="L366">			conn = factory.getConnection();</span>
<span class="fc" id="L367">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE OfficeVisitID = ? AND Status = ? AND (DateDiff(SYSDATE(),UpdatedDate) &lt;= 30) ORDER BY UpdatedDate DESC&quot;);</span>
<span class="fc" id="L368">			ps.setLong(1, ovid);</span>
<span class="fc" id="L369">			ps.setString(2, LabProcedureBean.Completed);</span>
<span class="fc" id="L370">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L371">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L372">			rs.close();</span>
<span class="fc" id="L373">			ps.close();</span>
<span class="fc" id="L374">			return loadlist;</span>
<span class="fc" id="L375">		} catch (SQLException e) {</span>
			
<span class="fc" id="L377">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L379">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Inserts a lab procedure into the database.
	 * @param b The LabProcedureBean to be inserted.
	 * @return A long containing the ID of the newly inserted lab procedure bean.
	 * @throws DBException
	 */
	public long addLabProcedure(LabProcedureBean b) throws DBException {
<span class="fc" id="L390">		Connection conn = null;</span>
<span class="fc" id="L391">		PreparedStatement ps = null;</span>
		try {
<span class="fc bfc" id="L393" title="All 2 branches covered.">			if (b.getPid() == 0L) throw new SQLException(&quot;PatientMID cannot be null&quot;);</span>
<span class="fc" id="L394">			conn = factory.getConnection();</span>
<span class="fc" id="L395">			ps = conn.prepareStatement(</span>
					&quot;INSERT INTO labprocedure &quot; +
					&quot;(PatientMID, LaboratoryProcedureCode, Status, Commentary, &quot; + 
					 &quot;Results, OfficeVisitID, Rights, LabTechID, PriorityCode, &quot; + 
					 &quot;NumericalResults, LowerBound, UpperBound) &quot; + 
					&quot;VALUES (?,?,?,?,?,?,?,?,?,?,?,?)&quot;);
<span class="fc" id="L401">			ps.setLong(1, b.getPid());</span>
<span class="fc" id="L402">			ps.setString(2, b.getLoinc());</span>
<span class="fc" id="L403">			ps.setString(3, b.getStatus());</span>
<span class="fc" id="L404">			ps.setString(4, b.getCommentary());</span>
<span class="fc" id="L405">			ps.setString(5, b.getResults());</span>
<span class="fc" id="L406">			ps.setLong(6, b.getOvID());</span>
<span class="fc" id="L407">			ps.setString(7, b.getRights());</span>
<span class="fc" id="L408">			ps.setLong(8, b.getLTID());</span>
<span class="fc" id="L409">			ps.setInt(9, b.getPriorityCode());</span>
<span class="fc" id="L410">			ps.setString(10, b.getNumericalResult());</span>
<span class="fc" id="L411">			ps.setString(11, b.getLowerBound());</span>
<span class="fc" id="L412">			ps.setString(12, b.getUpperBound());</span>
			
<span class="fc" id="L414">			ps.executeUpdate();</span>
<span class="fc" id="L415">			ps.close();</span>
<span class="fc" id="L416">			return DBUtil.getLastInsert(conn);</span>
<span class="fc" id="L417">		} catch (SQLException e) {</span>
			
<span class="fc" id="L419">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L421">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Updates an existing lab procedure.
	 * @param b The LabProcedureBean representing the procedure to be updated.
	 * @throws DBException
	 */
	public void updateLabProcedure(LabProcedureBean b) throws DBException {
<span class="fc" id="L431">		Connection conn = null;</span>
<span class="fc" id="L432">		PreparedStatement ps = null;</span>
		try {
<span class="fc bfc" id="L434" title="All 2 branches covered.">			if (b.getPid() == 0L) throw new SQLException(&quot;PatientMID cannot be null&quot;);</span>
<span class="fc" id="L435">			conn = factory.getConnection();</span>
<span class="fc" id="L436">			ps = conn.prepareStatement(&quot;UPDATE labprocedure SET &quot;+</span>
					&quot; Status = ?, Commentary = ?, Results = ?, UpdatedDate = ?, &quot;+
					&quot; LabTechID = ?, PriorityCode = ? , NumericalResults = ?, &quot;+
					&quot; LowerBound = ?, UpperBound = ? &quot;+
					&quot; WHERE LaboratoryProcedureID=?&quot;);
<span class="fc" id="L441">			ps.setString(1, b.getStatus());</span>
<span class="fc" id="L442">			ps.setString(2, b.getCommentary());</span>
<span class="fc" id="L443">			ps.setString(3, b.getResults());</span>
<span class="fc" id="L444">			ps.setTimestamp(4, new java.sql.Timestamp(System.currentTimeMillis()));</span>
<span class="fc" id="L445">			ps.setLong(5, b.getLTID());</span>
<span class="fc" id="L446">			ps.setInt(6, b.getPriorityCode());</span>
<span class="fc" id="L447">			ps.setString(7, b.getNumericalResult());</span>
<span class="fc" id="L448">			ps.setString(8, b.getLowerBound());</span>
<span class="fc" id="L449">			ps.setString(9, b.getUpperBound());</span>
<span class="fc" id="L450">			ps.setLong(10, b.getProcedureID());</span>
<span class="fc" id="L451">			ps.executeUpdate();</span>
<span class="fc" id="L452">			ps.close();</span>
<span class="fc" id="L453">		} catch (SQLException e) {</span>
			
<span class="fc" id="L455">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L457">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L458">		}</span>
<span class="fc" id="L459">	}</span>
	
	/**
	 * Marks a lab procedure as viewed by the patient
	 * @param b The LabProcedureBean representing the procedure to be marked as viewed.
	 * @throws DBException
	 */
	public void markViewed(LabProcedureBean b) throws DBException {
<span class="fc" id="L467">		Connection conn = null;</span>
<span class="fc" id="L468">		PreparedStatement ps = null;</span>
		try {
<span class="pc bpc" id="L470" title="1 of 2 branches missed.">			if (b.getPid() == 0L) throw new SQLException(&quot;PatientMID cannot be null&quot;);</span>
<span class="fc" id="L471">			conn = factory.getConnection();</span>
<span class="fc" id="L472">			ps = conn.prepareStatement(&quot;UPDATE labprocedure SET ViewedByPatient = ? WHERE LaboratoryProcedureID=?&quot;);</span>
<span class="fc" id="L473">			ps.setBoolean(1, b.isViewedByPatient());</span>
<span class="fc" id="L474">			ps.setLong(2, b.getProcedureID());</span>
<span class="fc" id="L475">			ps.executeUpdate();</span>
<span class="fc" id="L476">			ps.close();</span>
<span class="fc" id="L477">		} catch (SQLException e) {</span>
			
<span class="fc" id="L479">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L481">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L482">		}</span>
<span class="fc" id="L483">	}</span>
	
	/**
	 * Get the count of unviewed lab procedures for a particular patient.
	 * @param pid
	 * @return
	 * @throws DBException
	 */
	public int getPatientUnviewedCount(long pid) throws DBException {
<span class="fc" id="L492">		Connection conn = null;</span>
<span class="fc" id="L493">		PreparedStatement ps = null;</span>
		try {
<span class="pc bpc" id="L495" title="1 of 2 branches missed.">			if (pid == 0L) throw new SQLException(&quot;PatientMID cannot be null&quot;);</span>
<span class="fc" id="L496">			int count = 0;</span>
<span class="fc" id="L497">			conn = factory.getConnection();</span>
<span class="fc" id="L498">			ps = conn.prepareStatement(&quot;SELECT COUNT(*) FROM labprocedure WHERE PatientMID = ? AND Rights = ? AND Status = ? AND ViewedByPatient = FALSE &quot;);</span>
<span class="fc" id="L499">			ps.setLong(1, pid);</span>
<span class="fc" id="L500">			ps.setString(2, LabProcedureBean.Allow);</span>
<span class="fc" id="L501">			ps.setString(3, LabProcedureBean.Completed);</span>
<span class="fc" id="L502">			ResultSet rs = ps.executeQuery();</span>
<span class="pc bpc" id="L503" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L504">				count = rs.getInt(1);</span>
			}
<span class="fc" id="L506">			rs.close();</span>
<span class="fc" id="L507">			ps.close();</span>
<span class="fc" id="L508">			return count;</span>
<span class="nc" id="L509">		} catch (SQLException e) {</span>
			
<span class="nc" id="L511">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L513">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	
	/**
	 * Gets all the lab procedures that correspond to a particular LOINC.
	 * @param id The LOINC in question.
	 * @return A java.util.List of LabProcedureBeans.
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getAllLabProceduresLOINC(long id, String loinc) throws DBException {
<span class="fc" id="L525">		Connection conn = null;</span>
<span class="fc" id="L526">		PreparedStatement ps = null;</span>

		try {
<span class="fc" id="L529">			conn = factory.getConnection();</span>
<span class="fc" id="L530">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE PatientMID = ? AND LaboratoryProcedureCode = ? AND Status = ?&quot;);</span>
<span class="fc" id="L531">			ps.setLong(1, id);</span>
<span class="fc" id="L532">			ps.setString(2, loinc);</span>
<span class="fc" id="L533">			ps.setString(3, &quot;Completed&quot;);</span>
<span class="fc" id="L534">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L535">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L536">			rs.close();</span>
<span class="fc" id="L537">			ps.close();</span>
<span class="fc" id="L538">			return loadlist;</span>
<span class="fc" id="L539">		} catch (SQLException e) {</span>
			
<span class="fc" id="L541">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L543">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Updates the rights of a user on a given lab procedure.
	 * @param b The LabProcedureBean in question.
	 * @throws DBException
	 */
	public void updateRights(LabProcedureBean b) throws DBException {
<span class="fc" id="L553">		Connection conn = null;</span>
<span class="fc" id="L554">		PreparedStatement ps = null;</span>
		try {
<span class="pc bpc" id="L556" title="1 of 2 branches missed.">			if (b.getPid() == 0L) throw new SQLException(&quot;PatientMID cannot be null&quot;);</span>
<span class="fc" id="L557">			conn = factory.getConnection();</span>
<span class="fc" id="L558">			ps = conn.prepareStatement(&quot;UPDATE labprocedure SET Rights = ?, UpdatedDate = ? WHERE LaboratoryProcedureID=?&quot;);</span>
<span class="fc" id="L559">			ps.setString(1, b.getRights());</span>
<span class="fc" id="L560">			ps.setTimestamp(2, new java.sql.Timestamp(System.currentTimeMillis()));</span>
<span class="fc" id="L561">			ps.setLong(3, b.getProcedureID());</span>
<span class="fc" id="L562">			ps.executeUpdate();</span>
<span class="fc" id="L563">			ps.close();</span>
<span class="fc" id="L564">		} catch (SQLException e) {</span>
			
<span class="fc" id="L566">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L568">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L569">		}</span>
<span class="fc" id="L570">	}</span>
	

	/**
	 * Delete a given lab procedure form the database.
	 * @param procedureID
	 * @throws DBException
	 */
	public void removeLabProcedure(long procedureID) throws DBException {
<span class="fc" id="L579">		Connection conn = null;</span>
<span class="fc" id="L580">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L582">			conn = factory.getConnection();</span>
<span class="fc" id="L583">			ps = conn.prepareStatement(&quot;DELETE FROM labprocedure WHERE LaboratoryProcedureID=? &quot;);</span>
<span class="fc" id="L584">			ps.setLong(1, procedureID);</span>
<span class="fc" id="L585">			ps.executeUpdate();</span>
<span class="fc" id="L586">			ps.close();</span>
<span class="fc" id="L587">		} catch (SQLException e) {</span>
			
<span class="fc" id="L589">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L591">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L592">		}</span>
<span class="fc" id="L593">	}</span>

	/**
	 * Get a list of the lab procedures in transit associated with a given Lab Tech.
	 * @param id The MID of the LT as a long.
	 * @return A java.util.List of LabProcedureBeans
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getLabProceduresInTransitForLabTech(long id) throws DBException {
<span class="fc" id="L602">		Connection conn = null;</span>
<span class="fc" id="L603">		PreparedStatement ps = null;</span>

		try {
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">			if (id == 0L) throw new SQLException(&quot;LabTechID cannot be null&quot;);</span>
<span class="fc" id="L607">			conn = factory.getConnection();</span>
<span class="fc" id="L608">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE LabTechID = ? AND Status = ? ORDER BY UpdatedDate ASC&quot;);</span>
<span class="fc" id="L609">			ps.setLong(1, id);</span>
<span class="fc" id="L610">			ps.setString(2, LabProcedureBean.In_Transit);</span>
<span class="fc" id="L611">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L612">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L613">			rs.close();</span>
<span class="fc" id="L614">			ps.close();</span>
<span class="fc" id="L615">			return loadlist;</span>
<span class="fc" id="L616">		} catch (SQLException e) {</span>
			
<span class="fc" id="L618">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L620">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Get a list of the lab procedures received for a given Lab Tech.
	 * @param id The MID of the LT as a long.
	 * @return A java.util.List of LabProcedureBeans
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getLabProceduresReceivedForLabTech(long id) throws DBException {
<span class="fc" id="L631">		Connection conn = null;</span>
<span class="fc" id="L632">		PreparedStatement ps = null;</span>

		try {
<span class="pc bpc" id="L635" title="1 of 2 branches missed.">			if (id == 0L) throw new SQLException(&quot;LabTechID cannot be null&quot;);</span>
<span class="fc" id="L636">			conn = factory.getConnection();</span>
<span class="fc" id="L637">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE LabTechID = ? AND Status = ? ORDER BY PriorityCode ASC, UpdatedDate DESC&quot;);</span>
<span class="fc" id="L638">			ps.setLong(1, id);</span>
<span class="fc" id="L639">			ps.setString(2, LabProcedureBean.Received);</span>
<span class="fc" id="L640">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L641">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L642">			rs.close();</span>
<span class="fc" id="L643">			ps.close();</span>
<span class="fc" id="L644">			return loadlist;</span>
<span class="fc" id="L645">		} catch (SQLException e) {</span>
			
<span class="fc" id="L647">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L649">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Get a list of the lab procedures testing for a given Lab Tech.
	 * @param id The MID of the LT as a long.
	 * @return A java.util.List of LabProcedureBeans
	 * @throws DBException
	 */
	public List&lt;LabProcedureBean&gt; getLabProceduresTestingForLabTech(long id) throws DBException {
<span class="fc" id="L660">		Connection conn = null;</span>
<span class="fc" id="L661">		PreparedStatement ps = null;</span>

		try {
<span class="pc bpc" id="L664" title="1 of 2 branches missed.">			if (id == 0L) throw new SQLException(&quot;LabTechID cannot be null&quot;);</span>
<span class="fc" id="L665">			conn = factory.getConnection();</span>
<span class="fc" id="L666">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE LabTechID = ? AND Status = ? ORDER BY UpdatedDate DESC&quot;);</span>
<span class="fc" id="L667">			ps.setLong(1, id);</span>
<span class="fc" id="L668">			ps.setString(2, LabProcedureBean.Testing);</span>
<span class="fc" id="L669">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L670">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L671">			rs.close();</span>
<span class="fc" id="L672">			ps.close();</span>
<span class="fc" id="L673">			return loadlist;</span>
<span class="fc" id="L674">		} catch (SQLException e) {</span>
			
<span class="fc" id="L676">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L678">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Get the count of the In_Transit and Received lab procedures assigned to 
	 * a specific lab tech.
	 *  
	 * @param mid
	 * @return
	 * @throws DBException
	 */
	public int getLabTechQueueSize(long mid) throws DBException {
<span class="fc" id="L691">		Connection conn = null;</span>
<span class="fc" id="L692">		PreparedStatement ps = null;</span>

		try {
<span class="pc bpc" id="L695" title="1 of 2 branches missed.">			if (mid == 0L) throw new SQLException(&quot;LabTechID cannot be null&quot;);</span>
<span class="fc" id="L696">			conn = factory.getConnection();</span>
<span class="fc" id="L697">			int count = 0;</span>
<span class="fc" id="L698">			ps = conn.prepareStatement(&quot;SELECT COUNT(*) FROM labprocedure WHERE LabTechID = ? AND (Status = ? OR Status = ?)&quot;);</span>
<span class="fc" id="L699">			ps.setLong(1, mid);</span>
<span class="fc" id="L700">			ps.setString(2, LabProcedureBean.In_Transit);</span>
<span class="fc" id="L701">			ps.setString(3, LabProcedureBean.Received);</span>
<span class="fc" id="L702">			ResultSet rs = ps.executeQuery();</span>
<span class="pc bpc" id="L703" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L704">				count = rs.getInt(1);</span>
			}
<span class="fc" id="L706">			rs.close();</span>
<span class="fc" id="L707">			ps.close();</span>
<span class="fc" id="L708">			return count;</span>
<span class="nc" id="L709">		} catch (SQLException e) {</span>
			
<span class="nc" id="L711">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L713">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Get the count of the In_Transit and Received lab procedures assigned to 
	 * a specific lab tech grouped by priority.
	 *  
	 * @param mid
	 * @return
	 * @throws DBException
	 */
	public int[] getLabTechQueueSizeByPriority(long mid) throws DBException {
<span class="fc" id="L726">		Connection conn = null;</span>
<span class="fc" id="L727">		PreparedStatement ps = null;</span>
<span class="fc" id="L728">		int[] sizes = new int[4];</span>

		try {
<span class="pc bpc" id="L731" title="1 of 2 branches missed.">			if (mid == 0L) throw new SQLException(&quot;LabTechID cannot be null&quot;);</span>
<span class="fc" id="L732">			conn = factory.getConnection();</span>
<span class="fc bfc" id="L733" title="All 2 branches covered.">			for(int i=1; i&lt;=3; i++) {</span>
<span class="fc" id="L734">				int count = 0;</span>
<span class="fc" id="L735">				ps = conn.prepareStatement(&quot;SELECT COUNT(*) FROM labprocedure WHERE LabTechID = ? AND (Status = ? OR Status = ?) AND PriorityCode = ?&quot;);</span>
<span class="fc" id="L736">				ps.setLong(1, mid);</span>
<span class="fc" id="L737">				ps.setString(2, LabProcedureBean.In_Transit);</span>
<span class="fc" id="L738">				ps.setString(3, LabProcedureBean.Received);</span>
<span class="fc" id="L739">				ps.setInt(4, i);</span>
<span class="fc" id="L740">				ResultSet rs = ps.executeQuery();</span>
<span class="pc bpc" id="L741" title="1 of 2 branches missed.">				if (rs.next()) {</span>
<span class="fc" id="L742">					count = rs.getInt(1);</span>
				}
<span class="fc" id="L744">				rs.close();</span>
<span class="fc" id="L745">				sizes[i] = count;</span>
			}
			
<span class="fc" id="L748">			ps.close();</span>
<span class="fc" id="L749">			return sizes;</span>
<span class="nc" id="L750">		} catch (SQLException e) {</span>
			
<span class="nc" id="L752">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L754">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * @param id
	 * @param parseLong
	 * @param parseLong2
	 * @param parseLong3
	 * @throws DBException 
	 */
	public void submitTestResults(long id, String numericalResult, String numericalResultUnit, String upper, String lower) throws DBException {	
<span class="fc" id="L766">		Connection conn = null;</span>
<span class="fc" id="L767">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L769">			conn = factory.getConnection();</span>
<span class="fc" id="L770">			ps = conn.prepareStatement(&quot;UPDATE labprocedure SET NumericalResults = ?, NumericalResultsUnit = ?, UpperBound = ?, LowerBound = ?, Status = ?, UpdatedDate = ? WHERE LaboratoryProcedureID=?&quot;);</span>
<span class="fc" id="L771">			ps.setString(1, numericalResult);</span>
<span class="fc" id="L772">			ps.setString(2, numericalResultUnit);</span>
<span class="fc" id="L773">			ps.setString(3, upper);</span>
<span class="fc" id="L774">			ps.setString(4, lower);</span>
<span class="fc" id="L775">			ps.setString(5, &quot;Pending&quot;);</span>
<span class="fc" id="L776">			ps.setTimestamp(6, new java.sql.Timestamp(System.currentTimeMillis()));</span>
<span class="fc" id="L777">			ps.setLong(7, id);</span>
<span class="fc" id="L778">			ps.executeUpdate();</span>
<span class="fc" id="L779">			ps.close();</span>
<span class="fc" id="L780">		} catch (SQLException e) {</span>
			
<span class="fc" id="L782">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L784">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L785">		}</span>
		
<span class="fc" id="L787">	}</span>

	/**
	 * @param parseLong
	 * @throws DBException 
	 */
	public void submitReceivedLP(long id) throws DBException {
<span class="fc" id="L794">		Connection conn = null;</span>
<span class="fc" id="L795">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L797">			conn = factory.getConnection();</span>
<span class="fc" id="L798">			ps = conn.prepareStatement(&quot;UPDATE labprocedure SET Status = ?, UpdatedDate = ? WHERE LaboratoryProcedureID=?&quot;);</span>
<span class="fc" id="L799">			ps.setString(1, &quot;Received&quot;);</span>
<span class="fc" id="L800">			ps.setTimestamp(2, new java.sql.Timestamp(System.currentTimeMillis()));</span>
<span class="fc" id="L801">			ps.setLong(3, id);</span>
<span class="fc" id="L802">			ps.executeUpdate();</span>
<span class="fc" id="L803">			ps.close();</span>
<span class="fc" id="L804">		} catch (SQLException e) {</span>
			
<span class="fc" id="L806">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L808">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L809">		}</span>
<span class="fc" id="L810">	}</span>

	/**
	 * @param parseLong
	 * @throws DBException 
	 */
	public void setLPToTesting(long id) throws DBException {
<span class="fc" id="L817">		Connection conn = null;</span>
<span class="fc" id="L818">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L820">			conn = factory.getConnection();</span>
<span class="fc" id="L821">			ps = conn.prepareStatement(&quot;UPDATE labprocedure SET Status = ?, UpdatedDate = ? WHERE LaboratoryProcedureID=?&quot;);</span>
<span class="fc" id="L822">			ps.setString(1, &quot;Testing&quot;);</span>
<span class="fc" id="L823">			ps.setTimestamp(2, new java.sql.Timestamp(System.currentTimeMillis()));</span>
<span class="fc" id="L824">			ps.setLong(3, id);</span>
<span class="fc" id="L825">			ps.executeUpdate();</span>
<span class="fc" id="L826">			ps.close();</span>
<span class="fc" id="L827">		} catch (SQLException e) {</span>
			
<span class="fc" id="L829">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L831">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L832">		}</span>
<span class="fc" id="L833">	}</span>

	public List&lt;LabProcedureBean&gt; getAllLabProceduresLOINC(long id) throws DBException {
<span class="fc" id="L836">		Connection conn = null;</span>
<span class="fc" id="L837">		PreparedStatement ps = null;</span>

		try {
<span class="fc bfc" id="L840" title="All 2 branches covered.">			if (id == 0L) throw new SQLException(&quot;PatientMID cannot be null&quot;);</span>
<span class="fc" id="L841">			conn = factory.getConnection();</span>
<span class="fc" id="L842">			ps = conn.prepareStatement(&quot;SELECT * FROM labprocedure WHERE PatientMID = ? ORDER BY LaboratoryProcedureCode ASC&quot;);</span>
<span class="fc" id="L843">			ps.setLong(1, id);</span>
<span class="fc" id="L844">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L845">			List&lt;LabProcedureBean&gt; loadlist = labProcedureLoader.loadList(rs);</span>
<span class="fc" id="L846">			rs.close();</span>
<span class="fc" id="L847">			ps.close();</span>
<span class="fc" id="L848">			return loadlist;</span>
<span class="fc" id="L849">		} catch (SQLException e) {</span>
			
<span class="fc" id="L851">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L853">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>