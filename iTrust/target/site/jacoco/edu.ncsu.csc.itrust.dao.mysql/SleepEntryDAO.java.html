<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SleepEntryDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.dao.mysql</a> &gt; <span class="el_source">SleepEntryDAO.java</span></div><h1>SleepEntryDAO.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.dao.mysql;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Date;
import java.util.List;

import edu.ncsu.csc.itrust.DBUtil;
import edu.ncsu.csc.itrust.beans.SleepEntryBean;
import edu.ncsu.csc.itrust.beans.loaders.SleepEntryLoader;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.exception.ITrustException;

/**
 * SleepEntryDAO.java Version 1 4/6/2015 Copyright notice: none
 * 
 * Responsible for loading the entries in a patient's sleep diary, the totals
 * a patient has slept, and adding a new entry to a patient's sleep diary
 */
public class SleepEntryDAO {
	private transient final DAOFactory factory;
	private transient final SleepEntryLoader sleepLoader;

	/**
	 * Basic constructor
	 * 
	 * @param factory
	 *            the factory to use for getting connections
	 */
<span class="fc" id="L33">	public SleepEntryDAO(final DAOFactory factory) {</span>
<span class="fc" id="L34">		this.factory = factory;</span>
<span class="fc" id="L35">		sleepLoader = new SleepEntryLoader();</span>
<span class="fc" id="L36">	}</span>

	/**
	 * Returns all of the entries in the Sleep Entry table that contain the
	 * ID of the patient.
	 * 
	 * @param patientMID
	 *            which patient to select Sleep Diary for
	 * @return the list of all of that patient's sleep entries
	 * @throws DBException
	 */
	public List&lt;SleepEntryBean&gt; getPatientSleepDiary(long patientMID)
			throws DBException {
<span class="fc" id="L49">		Connection conn = null;</span>
<span class="fc" id="L50">		PreparedStatement pstring = null;</span>
		try {
<span class="fc" id="L52">			conn = factory.getConnection();</span>
<span class="fc" id="L53">			pstring = conn</span>
<span class="fc" id="L54">					.prepareStatement(&quot;SELECT * FROM sleepEntry WHERE &quot;</span>
							+ &quot;PatientID = ? ORDER BY Date DESC&quot;);
<span class="fc" id="L56">			pstring.setLong(1, patientMID);</span>
<span class="fc" id="L57">			final ResultSet results = pstring.executeQuery();</span>
<span class="fc" id="L58">			final List&lt;SleepEntryBean&gt; diaryList = this.sleepLoader</span>
<span class="fc" id="L59">					.loadList(results);</span>
<span class="fc" id="L60">			results.close();</span>
<span class="fc" id="L61">			pstring.close();</span>
<span class="fc" id="L62">			return diaryList;</span>
<span class="fc" id="L63">		} catch (SQLException e) {</span>
<span class="fc" id="L64">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L66">			DBUtil.closeConnection(conn, pstring);</span>
		}
	}

	/**
	 * Returns the total hours slept for each day in the sleep
	 * diary. The total just sums up the values for each individual sleep
	 * entry.
	 * 
	 * @param patientMID
	 *            patient whose sleep diary we want
	 * @return a list in descending order of date (dates closest to today first)
	 *         of the totals slept on each day for a patient
	 * @throws DBException
	 */
	public List&lt;SleepEntryBean&gt; getPatientSleepDiaryTotals(long patientMID)
			throws DBException {
<span class="fc" id="L83">		Connection conn = null;</span>
<span class="fc" id="L84">		PreparedStatement pstring = null;</span>
		try {
<span class="fc" id="L86">			conn = factory.getConnection();</span>
<span class="fc" id="L87">			pstring = conn.prepareStatement(&quot; SELECT EntryID AS EntryID, Date AS Date, SleepType AS SleepType, &quot;</span>
					+ &quot; SUM(Hours) AS Hours, PatientID AS PatientID, LabelID AS LabelID &quot;
					+ &quot; FROM sleepEntry &quot;
					+ &quot; WHERE PatientID = ? &quot;
					+ &quot; GROUP BY Date &quot;
					+ &quot; ORDER BY Date DESC &quot;);
<span class="fc" id="L93">			pstring.setLong(1, patientMID);</span>

<span class="fc" id="L95">			final ResultSet results = pstring.executeQuery();</span>
<span class="fc" id="L96">			final List&lt;SleepEntryBean&gt; diaryTotals = this.sleepLoader</span>
<span class="fc" id="L97">					.loadList(results);</span>
					
<span class="fc" id="L99">			results.close();</span>
<span class="fc" id="L100">			pstring.close();</span>
<span class="fc" id="L101">			return diaryTotals;</span>
<span class="nc" id="L102">		} catch (SQLException e) {</span>
<span class="nc" id="L103">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L105">			DBUtil.closeConnection(conn, pstring);</span>
		}
	}

	/**
	 * Adds a sleep entry to a patient's sleep diary
	 * 
	 * @param sleepEntry
	 *            the entry to add
	 * @throws DBException
	 */
	public void addSleepEntry(SleepEntryBean sleepEntry)
			throws DBException, ITrustException {

<span class="fc" id="L119">		Connection conn = null;</span>
<span class="fc" id="L120">		PreparedStatement pstring = null;</span>
<span class="fc" id="L121">		final long nextID = getNextEntryID();</span>
<span class="fc" id="L122">		sleepEntry.setEntryID(nextID);</span>
		try {
<span class="fc" id="L124">			conn = factory.getConnection();</span>
<span class="fc" id="L125">			pstring = conn</span>
<span class="fc" id="L126">					.prepareStatement(&quot;INSERT INTO sleepEntry(EntryID, Date, SleepType, &quot;</span>
							+ &quot; Hours, PatientID) &quot;
							+ &quot; VALUES (?,?,?,?,?)&quot;);
<span class="fc" id="L129">			pstring = sleepLoader.loadParameters(pstring, sleepEntry);</span>
<span class="fc" id="L130">			pstring.executeUpdate();</span>
<span class="nc" id="L131">		} catch (SQLException e) {</span>
<span class="nc" id="L132">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L134">			DBUtil.closeConnection(conn, pstring);</span>
<span class="fc" id="L135">		}</span>
<span class="fc" id="L136">	}</span>

	/**
	 * Queries the db to find the highest sleep entry id currently in use and
	 * then returns the next number so it can be used for a new sleep entry.
	 * 
	 * @return the next id available for a sleep entry
	 * @throws DBException
	 * @throws ITrustException
	 */
	public long getNextEntryID() throws DBException, ITrustException {
<span class="fc" id="L147">		Connection conn = null;</span>
<span class="fc" id="L148">		PreparedStatement pstmt = null;</span>
<span class="fc" id="L149">		long nextID = 1;</span>

		try {
<span class="fc" id="L152">			conn = factory.getConnection();</span>

<span class="fc" id="L154">			pstmt = conn.prepareStatement(&quot;SELECT MAX(sleepEntry.EntryID) &quot;</span>
					+ &quot;FROM sleepEntry&quot;);
<span class="fc" id="L156">			final ResultSet results = pstmt.executeQuery();</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">			if (results.next()) {</span>
<span class="fc" id="L158">				nextID = results.getLong(1) + 1;</span>
			}
<span class="fc" id="L160">			results.close();</span>
<span class="fc" id="L161">			pstmt.close();</span>
<span class="fc" id="L162">			return nextID;</span>
<span class="fc" id="L163">		} catch (SQLException e) {</span>
<span class="fc" id="L164">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L166">			DBUtil.closeConnection(conn, pstmt);</span>
		}
	}

	/**
	 * Deletes the sleep entry from the sleep diary that has the same
	 * unique id as the one passed in. Returns the count of the number of rows
	 * affected. The number of rows affected should never be more than 1. The
	 * patientMID is included to try to ensure that users cannot delete sleep
	 * diary entries that belong to users other than themselves.
	 * 
	 * @param entryID
	 *            which sleep entry to delete
	 * @param patientMID
	 *            the owner of this sleep entry
	 * @return how many entries were deleted from the sleep diary
	 * @throws DBException
	 */
	public int deleteSleepEntry(long entryID, long patientMID)
			throws DBException {
<span class="fc" id="L186">		Connection conn = null;</span>
<span class="fc" id="L187">		PreparedStatement pstmt = null;</span>
		try {
<span class="fc" id="L189">			conn = factory.getConnection();</span>
<span class="fc" id="L190">			pstmt = conn.prepareStatement(&quot;DELETE FROM sleepEntry &quot;</span>
					+ &quot;WHERE EntryID = ? AND PatientID = ?&quot;);
<span class="fc" id="L192">			pstmt.setLong(1, entryID);</span>
<span class="fc" id="L193">			pstmt.setLong(2, patientMID);</span>
<span class="fc" id="L194">			final int numDeleted = pstmt.executeUpdate();</span>
<span class="fc" id="L195">			return numDeleted;</span>
<span class="fc" id="L196">		} catch (SQLException e) {</span>
<span class="fc" id="L197">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L199">			DBUtil.closeConnection(conn, pstmt);</span>
		}
	}

	/**
	 * Updates a particular sleep entry with the new data. Neither the
	 * entryid nor the patientid will ever change, so there is no reason to
	 * include them as possibilities to change. It includes the patientMID in an
	 * attempt to ensure that patients can only update their own previous
	 * sleep entries.
	 * 
	 * @param entryID
	 *            the sleep entry to update
	 * @param patientMID
	 *            who the patient is making this update
	 * @param sleepEntry
	 *            the edited form of the sleep entry
	 * @return the number of rows updated (should never be more than 1)
	 * @throws DBException
	 */
	public int updateSleepEntry(long entryID, long patientMID,
			SleepEntryBean sleepEntry) throws DBException {
<span class="fc" id="L221">		Connection conn = null;</span>
<span class="fc" id="L222">		PreparedStatement pstmt = null;</span>
		try {
<span class="fc" id="L224">			conn = factory.getConnection();</span>

<span class="fc" id="L226">			pstmt = conn</span>
<span class="fc" id="L227">					.prepareStatement(&quot;UPDATE sleepEntry &quot;</span>
							+ &quot; SET Date = ?, SleepType = ?, Hours = ?, LabelID = ? &quot;
							+ &quot; WHERE EntryID = ? AND PatientID = ? &quot;);

<span class="fc" id="L231">			pstmt.setDate(1, new java.sql.Date(sleepEntry.getDate()</span>
<span class="fc" id="L232">					.getTime()));</span>
<span class="fc" id="L233">			pstmt.setString(2, sleepEntry.getSleepType().getName());</span>
<span class="fc" id="L234">			pstmt.setDouble(3, sleepEntry.getHoursSlept());</span>
<span class="fc" id="L235">			pstmt.setLong(4, sleepEntry.getLabelID());</span>
<span class="fc" id="L236">			pstmt.setLong(5, entryID);</span>
<span class="fc" id="L237">			pstmt.setLong(6, patientMID);</span>

<span class="fc" id="L239">			final int numUpdated = pstmt.executeUpdate();</span>
<span class="fc" id="L240">			return numUpdated;</span>
<span class="fc" id="L241">		} catch (SQLException d) {</span>
<span class="fc" id="L242">			throw new DBException(d);</span>
		} finally {
<span class="fc" id="L244">			DBUtil.closeConnection(conn, pstmt);</span>
		}

	}

	/**
	 * Returns the entries in the Sleep Entry table that are within a
	 * specified date range.
	 * 
	 * @param lower
	 *            the lower date
	 * @param upper
	 *            the lower date
	 * @param patientMID
	 *            which patient to select Sleep Diary for
	 * 
	 * @return the list of sleep entries between the two dates
	 * @throws DBException
	 */
	public List&lt;SleepEntryBean&gt; getBoundedSleepDiary(Date lower,
			Date upper, long patientMID) throws DBException {
<span class="fc" id="L265">		Connection conn = null;</span>
<span class="fc" id="L266">		PreparedStatement pstring = null;</span>
		try {
<span class="fc" id="L268">			conn = factory.getConnection();</span>

<span class="fc" id="L270">			pstring = conn.prepareStatement(&quot;SELECT * FROM sleepEntry &quot;</span>
					+ &quot; WHERE PatientID = ? &quot; + &quot; AND Date BETWEEN ? AND ? &quot;
					+ &quot; ORDER BY Date DESC&quot;);

<span class="fc" id="L274">			pstring.setLong(1, patientMID);</span>
			// Convert java.util.Date to java.sql.Date
<span class="fc" id="L276">			java.sql.Date lowerSQLDate = new java.sql.Date(lower.getTime());</span>
<span class="fc" id="L277">			java.sql.Date upperSQLDate = new java.sql.Date(upper.getTime());</span>
<span class="fc" id="L278">			pstring.setDate(2, lowerSQLDate);</span>
<span class="fc" id="L279">			pstring.setDate(3, upperSQLDate);</span>

<span class="fc" id="L281">			final ResultSet results = pstring.executeQuery();</span>
<span class="fc" id="L282">			final List&lt;SleepEntryBean&gt; diaryList = this.sleepLoader</span>
<span class="fc" id="L283">					.loadList(results);</span>
<span class="fc" id="L284">			results.close();</span>
<span class="fc" id="L285">			pstring.close();</span>

<span class="fc" id="L287">			return diaryList;</span>
<span class="nc" id="L288">		} catch (SQLException e) {</span>
<span class="nc" id="L289">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L291">			DBUtil.closeConnection(conn, pstring);</span>
		}
	}

	/**
	 * Returns the total hours and calories burned of each day in the sleep
	 * diary that falls between the two given dates. The total just sums up the
	 * values for each individual sleep entry.
	 * 
	 * @param lower
	 *            the lower date
	 * @param upper
	 *            the lower date
	 * @param patientMID
	 *            which patient to select Sleep Diary for
	 * 
	 * @return the list of sleep entries between the two dates
	 * @throws DBException
	 */
	public List&lt;SleepEntryBean&gt; getBoundedSleepDiaryTotals(Date lower,
			Date upper, long patientMID) throws DBException {
<span class="fc" id="L312">		Connection conn = null;</span>
<span class="fc" id="L313">		PreparedStatement pstring = null;</span>
		try {
<span class="fc" id="L315">			conn = factory.getConnection();</span>

<span class="fc" id="L317">			pstring = conn.prepareStatement(&quot; SELECT EntryID AS EntryID, Date AS Date, SleepType AS SleepType, &quot;</span>
					+ &quot; SUM(Hours) AS Hours, PatientID AS PatientID, LabelID AS LabelID  &quot;
					+ &quot; FROM sleepEntry &quot;
					+ &quot; WHERE PatientID = ? &quot; + &quot; AND Date BETWEEN ? AND ? &quot;
					+ &quot; GROUP BY Date &quot; + &quot; ORDER BY Date DESC&quot;);

			// Add params
<span class="fc" id="L324">			pstring.setLong(1, patientMID);</span>
			// Convert java.util.Date to java.sql.Date
<span class="fc" id="L326">			java.sql.Date lowerSQLDate = new java.sql.Date(lower.getTime());</span>
<span class="fc" id="L327">			java.sql.Date upperSQLDate = new java.sql.Date(upper.getTime());</span>
<span class="fc" id="L328">			pstring.setDate(2, lowerSQLDate);</span>
<span class="fc" id="L329">			pstring.setDate(3, upperSQLDate);</span>

<span class="fc" id="L331">			final ResultSet results = pstring.executeQuery();</span>
<span class="fc" id="L332">			final List&lt;SleepEntryBean&gt; diaryList = this.sleepLoader</span>
<span class="fc" id="L333">					.loadList(results);</span>
<span class="fc" id="L334">			results.close();</span>
<span class="fc" id="L335">			pstring.close();</span>

<span class="fc" id="L337">			return diaryList;</span>
<span class="nc" id="L338">		} catch (SQLException e) {</span>
<span class="nc" id="L339">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L341">			DBUtil.closeConnection(conn, pstring);</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>