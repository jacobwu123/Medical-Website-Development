<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ExerciseEntryDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.dao.mysql</a> &gt; <span class="el_source">ExerciseEntryDAO.java</span></div><h1>ExerciseEntryDAO.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.dao.mysql;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Date;
import java.util.List;

import edu.ncsu.csc.itrust.DBUtil;
import edu.ncsu.csc.itrust.beans.ExerciseEntryBean;
import edu.ncsu.csc.itrust.beans.loaders.ExerciseEntryLoader;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.exception.ITrustException;

/**
 * ExerciseEntryDAO.java Version 1 4/2/2015 Copyright notice: none
 * 
 * Responsible for loading the entries in a patient's exercise diary, the totals
 * a patient has performed, and adding a new entry to a patient's exercise diary
 */
public class ExerciseEntryDAO {

	private transient final DAOFactory factory;
	private transient final ExerciseEntryLoader exerciseLoader;

	/**
	 * Basic constructor
	 * 
	 * @param factory
	 *            the factory to use for getting connections
	 */
<span class="fc" id="L34">	public ExerciseEntryDAO(final DAOFactory factory) {</span>
<span class="fc" id="L35">		this.factory = factory;</span>
<span class="fc" id="L36">		exerciseLoader = new ExerciseEntryLoader();</span>
<span class="fc" id="L37">	}</span>

	/**
	 * Returns all of the entries in the Exercise Entry table that contain the
	 * ID of the patient.
	 * 
	 * @param patientMID
	 *            which patient to select Exercise Diary for
	 * @return the list of all of that patient's exercise entries
	 * @throws DBException
	 */
	public List&lt;ExerciseEntryBean&gt; getPatientExerciseDiary(long patientMID)
			throws DBException {
<span class="fc" id="L50">		Connection conn = null;</span>
<span class="fc" id="L51">		PreparedStatement pstring = null;</span>
		try {
<span class="fc" id="L53">			conn = factory.getConnection();</span>
<span class="fc" id="L54">			pstring = conn</span>
<span class="fc" id="L55">					.prepareStatement(&quot;SELECT * FROM exerciseEntry WHERE &quot;</span>
							+ &quot;PatientID = ? ORDER BY Date DESC&quot;);
<span class="fc" id="L57">			pstring.setLong(1, patientMID);</span>
<span class="fc" id="L58">			final ResultSet results = pstring.executeQuery();</span>
<span class="fc" id="L59">			final List&lt;ExerciseEntryBean&gt; diaryList = this.exerciseLoader</span>
<span class="fc" id="L60">					.loadList(results);</span>
<span class="fc" id="L61">			results.close();</span>
<span class="fc" id="L62">			pstring.close();</span>
<span class="fc" id="L63">			return diaryList;</span>
<span class="fc" id="L64">		} catch (SQLException e) {</span>
<span class="fc" id="L65">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L67">			DBUtil.closeConnection(conn, pstring);</span>
		}
	}

	/**
	 * Returns the total hours and calories burned of each day in the exercise
	 * diary. The total just sums up the values for each individual exercise
	 * entry.
	 * 
	 * @param patientMID
	 *            patient whose exercise diary we want
	 * @return a list in descending order of date (dates closest to today first)
	 *         of the totals performed on each day for a patient
	 * @throws DBException
	 */
	public List&lt;ExerciseEntryBean&gt; getPatientExerciseDiaryTotals(long patientMID)
			throws DBException {
<span class="fc" id="L84">		Connection conn = null;</span>
<span class="fc" id="L85">		PreparedStatement pstring = null;</span>
		try {
<span class="fc" id="L87">			conn = factory.getConnection();</span>
<span class="fc" id="L88">			pstring = conn.prepareStatement(&quot; SELECT EntryID AS EntryID, Date AS Date, ExerciseType AS ExerciseType, Name AS Name, &quot;</span>
					+ &quot; SUM(Hours) AS Hours, &quot; + &quot; SUM(Calories) AS Calories, &quot;
					+ &quot; Sets AS Sets, Reps AS Reps, PatientID AS PatientID, LabelID AS LabelID &quot;
					+ &quot; FROM exerciseEntry &quot;
					+ &quot; WHERE PatientID = ? &quot;
					+ &quot; GROUP BY Date &quot;
					+ &quot; ORDER BY Date DESC &quot;);
<span class="fc" id="L95">			pstring.setLong(1, patientMID);</span>

<span class="fc" id="L97">			final ResultSet results = pstring.executeQuery();</span>
<span class="fc" id="L98">			final List&lt;ExerciseEntryBean&gt; diaryTotals = this.exerciseLoader</span>
<span class="fc" id="L99">					.loadList(results);</span>
					
<span class="fc" id="L101">			results.close();</span>
<span class="fc" id="L102">			pstring.close();</span>
<span class="fc" id="L103">			return diaryTotals;</span>
<span class="nc" id="L104">		} catch (SQLException e) {</span>
<span class="nc" id="L105">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L107">			DBUtil.closeConnection(conn, pstring);</span>
		}
	}

	/**
	 * Adds a exercise entry to a patient's exercise diary
	 * 
	 * @param exerciseEntry
	 *            the entry to add
	 * @throws DBException
	 */
	public void addExerciseEntry(ExerciseEntryBean exerciseEntry)
			throws DBException, ITrustException {

<span class="fc" id="L121">		Connection conn = null;</span>
<span class="fc" id="L122">		PreparedStatement pstring = null;</span>
<span class="fc" id="L123">		final long nextID = getNextEntryID();</span>
<span class="fc" id="L124">		exerciseEntry.setEntryID(nextID);</span>
		try {
<span class="fc" id="L126">			conn = factory.getConnection();</span>
<span class="fc" id="L127">			pstring = conn</span>
<span class="fc" id="L128">					.prepareStatement(&quot;INSERT INTO exerciseEntry(EntryID, Date, ExerciseType, &quot;</span>
							+ &quot; Name, Hours, Calories, Sets, Reps, PatientID) &quot;
							+ &quot; VALUES (?,?,?,?,?,?,?,?,?)&quot;);
<span class="fc" id="L131">			pstring = exerciseLoader.loadParameters(pstring, exerciseEntry);</span>
<span class="fc" id="L132">			pstring.executeUpdate();</span>
<span class="nc" id="L133">		} catch (SQLException e) {</span>
<span class="nc" id="L134">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L136">			DBUtil.closeConnection(conn, pstring);</span>
<span class="fc" id="L137">		}</span>
<span class="fc" id="L138">	}</span>

	/**
	 * Queries the db to find the highest exercise entry id currently in use and
	 * then returns the next number so it can be used for a new exercise entry.
	 * 
	 * @return the next id available for a exercise entry
	 * @throws DBException
	 * @throws ITrustException
	 */
	public long getNextEntryID() throws DBException, ITrustException {
<span class="fc" id="L149">		Connection conn = null;</span>
<span class="fc" id="L150">		PreparedStatement pstmt = null;</span>
<span class="fc" id="L151">		long nextID = 1;</span>

		try {
<span class="fc" id="L154">			conn = factory.getConnection();</span>

<span class="fc" id="L156">			pstmt = conn.prepareStatement(&quot;SELECT MAX(exerciseEntry.EntryID) &quot;</span>
					+ &quot;FROM exerciseEntry&quot;);
<span class="fc" id="L158">			final ResultSet results = pstmt.executeQuery();</span>
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">			if (results.next()) {</span>
<span class="fc" id="L160">				nextID = results.getLong(1) + 1;</span>
			}
<span class="fc" id="L162">			results.close();</span>
<span class="fc" id="L163">			pstmt.close();</span>
<span class="fc" id="L164">			return nextID;</span>
<span class="fc" id="L165">		} catch (SQLException e) {</span>
<span class="fc" id="L166">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L168">			DBUtil.closeConnection(conn, pstmt);</span>
		}
	}

	/**
	 * Deletes the exercise entry from the exercise diary that has the same
	 * unique id as the one passed in. Returns the count of the number of rows
	 * affected. The number of rows affected should never be more than 1. The
	 * patientMID is included to try to ensure that users cannot delete exercise
	 * diary entries that belong to users other than themselves.
	 * 
	 * @param entryID
	 *            which exercise entry to delete
	 * @param patientMID
	 *            the owner of this exercise entry
	 * @return how many entries were deleted from the exercise diary
	 * @throws DBException
	 */
	public int deleteExerciseEntry(long entryID, long patientMID)
			throws DBException {
<span class="fc" id="L188">		Connection conn = null;</span>
<span class="fc" id="L189">		PreparedStatement pstmt = null;</span>
		try {
<span class="fc" id="L191">			conn = factory.getConnection();</span>
<span class="fc" id="L192">			pstmt = conn.prepareStatement(&quot;DELETE FROM exerciseEntry &quot;</span>
					+ &quot;WHERE EntryID = ? AND PatientID = ?&quot;);
<span class="fc" id="L194">			pstmt.setLong(1, entryID);</span>
<span class="fc" id="L195">			pstmt.setLong(2, patientMID);</span>
<span class="fc" id="L196">			final int numDeleted = pstmt.executeUpdate();</span>
<span class="fc" id="L197">			return numDeleted;</span>
<span class="fc" id="L198">		} catch (SQLException e) {</span>
<span class="fc" id="L199">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L201">			DBUtil.closeConnection(conn, pstmt);</span>
		}
	}

	/**
	 * Updates a particular exercise entry with the new data. Neither the
	 * entryid nor the patientid will ever change, so there is no reason to
	 * include them as possibilities to change. It includes the patientMID in an
	 * attempt to ensure that patients can only update their own previous
	 * exercise entries.
	 * 
	 * @param entryID
	 *            the exercise entry to update
	 * @param patientMID
	 *            who the patient is making this update
	 * @param exerciseEntry
	 *            the edited form of the exercise entry
	 * @return the number of rows updated (should never be more than 1)
	 * @throws DBException
	 */
	public int updateExerciseEntry(long entryID, long patientMID,
			ExerciseEntryBean exerciseEntry) throws DBException {
<span class="fc" id="L223">		Connection conn = null;</span>
<span class="fc" id="L224">		PreparedStatement pstmt = null;</span>
		try {
<span class="fc" id="L226">			conn = factory.getConnection();</span>

<span class="fc" id="L228">			pstmt = conn</span>
<span class="fc" id="L229">					.prepareStatement(&quot;UPDATE exerciseEntry &quot;</span>
							+ &quot; SET Date = ?, ExerciseType = ?, Name = ?, &quot;
							+ &quot; Hours = ?, Calories = ?, Sets = ?, Reps = ?, LabelID = ? &quot;
							+ &quot; WHERE EntryID = ? AND PatientID = ? &quot;);

<span class="fc" id="L234">			pstmt.setDate(1, new java.sql.Date(exerciseEntry.getDate()</span>
<span class="fc" id="L235">					.getTime()));</span>
<span class="fc" id="L236">			pstmt.setString(2, exerciseEntry.getExerciseType().getName());</span>
<span class="fc" id="L237">			pstmt.setString(3, exerciseEntry.getStrName());</span>
<span class="fc" id="L238">			pstmt.setDouble(4, exerciseEntry.getHoursWorked());</span>
<span class="fc" id="L239">			pstmt.setDouble(5, exerciseEntry.getCaloriesBurned());</span>
<span class="fc" id="L240">			pstmt.setDouble(6, exerciseEntry.getNumSets());</span>
<span class="fc" id="L241">			pstmt.setDouble(7, exerciseEntry.getNumReps());</span>
<span class="fc" id="L242">			pstmt.setLong(8, exerciseEntry.getLabelID());</span>
<span class="fc" id="L243">			pstmt.setLong(9, entryID);</span>
<span class="fc" id="L244">			pstmt.setLong(10, patientMID);</span>

<span class="fc" id="L246">			final int numUpdated = pstmt.executeUpdate();</span>
<span class="fc" id="L247">			return numUpdated;</span>
<span class="fc" id="L248">		} catch (SQLException d) {</span>
<span class="fc" id="L249">			throw new DBException(d);</span>
		} finally {
<span class="fc" id="L251">			DBUtil.closeConnection(conn, pstmt);</span>
		}

	}

	/**
	 * Returns the entries in the Exercise Entry table that are within a
	 * specified date range.
	 * 
	 * @param lower
	 *            the lower date
	 * @param upper
	 *            the lower date
	 * @param patientMID
	 *            which patient to select Exercise Diary for
	 * 
	 * @return the list of exercise entries between the two dates
	 * @throws DBException
	 */
	public List&lt;ExerciseEntryBean&gt; getBoundedExerciseDiary(Date lower,
			Date upper, long patientMID) throws DBException {
<span class="fc" id="L272">		Connection conn = null;</span>
<span class="fc" id="L273">		PreparedStatement pstring = null;</span>
		try {
<span class="fc" id="L275">			conn = factory.getConnection();</span>

<span class="fc" id="L277">			pstring = conn.prepareStatement(&quot;SELECT * FROM exerciseEntry &quot;</span>
					+ &quot; WHERE PatientID = ? &quot; + &quot; AND Date BETWEEN ? AND ? &quot;
					+ &quot; ORDER BY Date DESC&quot;);

<span class="fc" id="L281">			pstring.setLong(1, patientMID);</span>
			// Convert java.util.Date to java.sql.Date
<span class="fc" id="L283">			java.sql.Date lowerSQLDate = new java.sql.Date(lower.getTime());</span>
<span class="fc" id="L284">			java.sql.Date upperSQLDate = new java.sql.Date(upper.getTime());</span>
<span class="fc" id="L285">			pstring.setDate(2, lowerSQLDate);</span>
<span class="fc" id="L286">			pstring.setDate(3, upperSQLDate);</span>

<span class="fc" id="L288">			final ResultSet results = pstring.executeQuery();</span>
<span class="fc" id="L289">			final List&lt;ExerciseEntryBean&gt; diaryList = this.exerciseLoader</span>
<span class="fc" id="L290">					.loadList(results);</span>
<span class="fc" id="L291">			results.close();</span>
<span class="fc" id="L292">			pstring.close();</span>

<span class="fc" id="L294">			return diaryList;</span>
<span class="nc" id="L295">		} catch (SQLException e) {</span>
<span class="nc" id="L296">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L298">			DBUtil.closeConnection(conn, pstring);</span>
		}
	}

	/**
	 * Returns the total hours and calories burned of each day in the exercise
	 * diary that falls between the two given dates. The total just sums up the
	 * values for each individual exercise entry.
	 * 
	 * @param lower
	 *            the lower date
	 * @param upper
	 *            the lower date
	 * @param patientMID
	 *            which patient to select Exercise Diary for
	 * 
	 * @return the list of exercise entries between the two dates
	 * @throws DBException
	 */
	public List&lt;ExerciseEntryBean&gt; getBoundedExerciseDiaryTotals(Date lower,
			Date upper, long patientMID) throws DBException {
<span class="fc" id="L319">		Connection conn = null;</span>
<span class="fc" id="L320">		PreparedStatement pstring = null;</span>
		try {
<span class="fc" id="L322">			conn = factory.getConnection();</span>

<span class="fc" id="L324">			pstring = conn.prepareStatement(&quot; SELECT EntryID AS EntryID, Date AS Date, ExerciseType AS ExerciseType, Name AS Name, &quot;</span>
					+ &quot; SUM(Hours) AS Hours, &quot; + &quot; SUM(Calories) AS Calories, &quot;
					+ &quot; Sets AS Sets, Reps AS Reps, PatientID AS PatientID, LabelID AS LabelID  &quot;
					+ &quot; FROM exerciseEntry &quot;
					+ &quot; WHERE PatientID = ? &quot; + &quot; AND Date BETWEEN ? AND ? &quot;
					+ &quot; GROUP BY Date &quot; + &quot; ORDER BY Date DESC&quot;);

			// Add params
<span class="fc" id="L332">			pstring.setLong(1, patientMID);</span>
			// Convert java.util.Date to java.sql.Date
<span class="fc" id="L334">			java.sql.Date lowerSQLDate = new java.sql.Date(lower.getTime());</span>
<span class="fc" id="L335">			java.sql.Date upperSQLDate = new java.sql.Date(upper.getTime());</span>
<span class="fc" id="L336">			pstring.setDate(2, lowerSQLDate);</span>
<span class="fc" id="L337">			pstring.setDate(3, upperSQLDate);</span>

<span class="fc" id="L339">			final ResultSet results = pstring.executeQuery();</span>
<span class="fc" id="L340">			final List&lt;ExerciseEntryBean&gt; diaryList = this.exerciseLoader</span>
<span class="fc" id="L341">					.loadList(results);</span>
<span class="fc" id="L342">			results.close();</span>
<span class="fc" id="L343">			pstring.close();</span>

<span class="fc" id="L345">			return diaryList;</span>
<span class="nc" id="L346">		} catch (SQLException e) {</span>
<span class="nc" id="L347">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L349">			DBUtil.closeConnection(conn, pstring);</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>