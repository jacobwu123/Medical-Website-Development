<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ReferralDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.dao.mysql</a> &gt; <span class="el_source">ReferralDAO.java</span></div><h1>ReferralDAO.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.dao.mysql;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.List;

import edu.ncsu.csc.itrust.DBUtil;
import edu.ncsu.csc.itrust.beans.ReferralBean;
import edu.ncsu.csc.itrust.beans.VerboseReferralBean;
import edu.ncsu.csc.itrust.beans.loaders.ReferralBeanLoader;
import edu.ncsu.csc.itrust.beans.loaders.VerboseReferralBeanLoader;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.enums.SortDirection;
import edu.ncsu.csc.itrust.exception.DBException;

/**
 * Used to update referrals, and fetch lists of referrals sent to and
 * from HCPs.
 *
 * DAO stands for Database Access Object. All DAOs are intended to be reflections of the database, that is,
 * one DAO per table in the database (most of the time). For more complex sets of queries, extra DAOs are
 * added. DAOs can assume that all data has been validated and is correct.
 * 
 * DAOs should never have setters or any other parameter to the constructor than a factory. All DAOs should be
 * accessed by DAOFactory (@see {@link DAOFactory}) and every DAO should have a factory - for obtaining JDBC
 * connections and/or accessing other DAOs.
 */
public class ReferralDAO {
	
	private DAOFactory factory;
	private ReferralBeanLoader referralLoader;
	private VerboseReferralBeanLoader verboseLoader;

	/**
	 * The typical constructor.
	 * @param factory The {@link DAOFactory} associated with this DAO, which is used for obtaining SQL connections, etc.
	 */
<span class="fc" id="L41">	public ReferralDAO(DAOFactory factory) {</span>
<span class="fc" id="L42">		this.factory = factory;</span>
<span class="fc" id="L43">		referralLoader = new ReferralBeanLoader();</span>
<span class="fc" id="L44">		verboseLoader = new VerboseReferralBeanLoader();</span>
<span class="fc" id="L45">	}</span>
	
	/**
	 * Get all referrals associated with a particular office visit.
	 * @param ovid The office visit id.
	 * @return A list of ReferralBeans.
	 * @throws DBException
	 */
	public List&lt;ReferralBean&gt; getReferralsFromOV(long ovid) throws DBException {
<span class="fc" id="L54">		Connection conn = null;</span>
<span class="fc" id="L55">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L57">			conn = factory.getConnection();</span>
<span class="fc" id="L58">			ps = conn.prepareStatement(&quot;SELECT * FROM referrals WHERE ovID = ?&quot;);</span>
<span class="fc" id="L59">			ps.setLong(1, ovid);</span>
<span class="fc" id="L60">			ResultSet rs = ps.executeQuery();</span>
			
<span class="fc" id="L62">			List&lt;ReferralBean&gt; loadlist = referralLoader.loadList(rs);</span>
<span class="fc" id="L63">			rs.close();</span>
<span class="fc" id="L64">			ps.close();</span>
<span class="fc" id="L65">			return loadlist;</span>
			
<span class="fc" id="L67">		} catch (SQLException e) {</span>
			
<span class="fc" id="L69">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L71">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Gets a list of all referrals sent from an HCP
	 * @param mid The HCP's mid.
	 * @return The list of the referrals they sent.
	 * @throws DBException
	 */
	public List&lt;ReferralBean&gt; getReferralsSentFrom(long mid) throws DBException {
<span class="fc" id="L82">		Connection conn = null;</span>
<span class="fc" id="L83">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L85">			conn = factory.getConnection();</span>
<span class="fc" id="L86">			ps = conn.prepareStatement(&quot;SELECT * FROM referrals WHERE SenderID = ?&quot;);</span>
<span class="fc" id="L87">			ps.setLong(1, mid);</span>
<span class="fc" id="L88">			ResultSet rs = ps.executeQuery();</span>
			
			
<span class="fc" id="L91">			List&lt;ReferralBean&gt; loadlist = referralLoader.loadList(rs);</span>
<span class="fc" id="L92">			rs.close();</span>
<span class="fc" id="L93">			ps.close();</span>
<span class="fc" id="L94">			return loadlist;</span>
			
<span class="fc" id="L96">		} catch (SQLException e) {</span>
			
<span class="fc" id="L98">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L100">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Get a specific referral.
	 * @param id The id of the referral to retrieve.
	 * @return A ReferralBean.
	 * @throws DBException
	 */
	public ReferralBean getReferral(long id) throws DBException {
<span class="fc" id="L111">		Connection conn = null;</span>
<span class="fc" id="L112">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L114">			conn = factory.getConnection();</span>
<span class="fc" id="L115">			ps = conn.prepareStatement(&quot;SELECT * FROM referrals WHERE id = ?&quot;);</span>
<span class="fc" id="L116">			ps.setLong(1, id);</span>
<span class="fc" id="L117">			ResultSet rs = ps.executeQuery();</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">			if(rs.next()){</span>
<span class="fc" id="L119">				ReferralBean loadlist = referralLoader.loadSingle(rs);</span>
<span class="fc" id="L120">				rs.close();</span>
<span class="fc" id="L121">				ps.close();</span>
<span class="fc" id="L122">				return loadlist;</span>
			} else{
<span class="fc" id="L124">				rs.close();</span>
<span class="fc" id="L125">				return null;</span>
			}
			
<span class="fc" id="L128">		} catch (SQLException e) {</span>
			
<span class="fc" id="L130">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L132">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	
	/**
	 * Set referral message.
	 * @param messageID messageID
	 * @param referralID referralID
	 * @return A ReferralBean.
	 * @throws DBException
	 */
	public boolean setReferralMessage(long messageID, long referralID) throws DBException {
<span class="nc" id="L145">		Connection conn = null;</span>
<span class="nc" id="L146">		PreparedStatement ps = null;</span>
		try {
<span class="nc" id="L148">			conn = factory.getConnection();</span>
<span class="nc" id="L149">			ps = conn.prepareStatement(&quot;INSERT INTO referralmessage (messageID,referralID) VALUES (?,?) &quot;);</span>
<span class="nc" id="L150">			ps.setLong(1, messageID);</span>
<span class="nc" id="L151">			ps.setLong(2, referralID);</span>
<span class="nc" id="L152">			ps.executeUpdate();</span>
<span class="nc" id="L153">			ps.close();</span>
<span class="nc" id="L154">		} catch (SQLException e) {</span>
			
<span class="nc" id="L156">			throw new DBException(e);</span>
		} finally {
<span class="nc" id="L158">			DBUtil.closeConnection(conn, ps);</span>
<span class="nc" id="L159">		}</span>
<span class="nc" id="L160">		return true;</span>
	}
	
	
	/**
	 * Set referral message.
	 * @param messageID messageID
	 * @return A ReferralBean.
	 * @throws DBException
	 */
	public long isReferralMessage(long messageID) throws DBException {
<span class="fc" id="L171">		Connection conn = null;</span>
<span class="fc" id="L172">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L174">			conn = factory.getConnection();</span>
<span class="fc" id="L175">			ps = conn.prepareStatement(&quot;SELECT * FROM referralmessage WHERE messageID = ?&quot;);</span>
<span class="fc" id="L176">			ps.setLong(1, messageID);</span>
<span class="fc" id="L177">			ResultSet rs = ps.executeQuery();</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">			if(rs.next()){</span>
<span class="nc" id="L179">				long a = rs.getLong(2);</span>
<span class="nc" id="L180">				rs.close();</span>
<span class="nc" id="L181">				ps.close();</span>
<span class="nc" id="L182">				return a;</span>
			} else{
<span class="fc" id="L184">				rs.close();</span>
<span class="fc" id="L185">				ps.close();</span>
<span class="fc" id="L186">				return 0;</span>
			}
<span class="nc" id="L188">		} catch (SQLException e) {</span>
			
<span class="nc" id="L190">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L192">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	
	/**
	 * Gets a list of all referrals sent to an HCP
	 * @param mid The HCP's mid.
	 * @return The list of the referrals sent to them.
	 * @throws DBException
	 */
	public List&lt;ReferralBean&gt; getReferralsSentTo(long mid) throws DBException {
<span class="fc" id="L204">		Connection conn = null;</span>
<span class="fc" id="L205">		PreparedStatement ps = null;</span>
		try {
<span class="nc" id="L207">			conn = factory.getConnection();</span>
<span class="nc" id="L208">			ps = conn.prepareStatement(&quot;SELECT * FROM referrals WHERE ReceiverID = ?&quot;);</span>
<span class="nc" id="L209">			ps.setLong(1, mid);</span>
<span class="nc" id="L210">			ResultSet rs = ps.executeQuery();</span>
			
			
<span class="nc" id="L213">			List&lt;ReferralBean&gt; loadlist = referralLoader.loadList(rs);</span>
<span class="nc" id="L214">			rs.close();</span>
<span class="nc" id="L215">			ps.close();</span>
<span class="nc" id="L216">			return loadlist;</span>
			
<span class="fc" id="L218">		} catch (SQLException e) {</span>
			
<span class="fc" id="L220">			throw new DBException(e);</span>
		} finally {
<span class="pc" id="L222">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Gets a list of all referrals a HCP has received
	 * @param mid The patients's mid.
	 * @return The list of the referrals they received.
	 * @throws DBException
	 */
	public List&lt;ReferralBean&gt; getReferralsForReceivingHCP(long mid) throws DBException {
<span class="fc" id="L233">		Connection conn = null;</span>
<span class="fc" id="L234">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L236">			conn = factory.getConnection();</span>
<span class="fc" id="L237">			ps = conn.prepareStatement(&quot;SELECT * FROM referrals WHERE ReceiverID = ? ORDER BY PriorityCode ASC&quot;);</span>
<span class="fc" id="L238">			ps.setLong(1, mid);</span>
<span class="fc" id="L239">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L240">			List&lt;ReferralBean&gt; loadlist = referralLoader.loadList(rs);</span>
<span class="fc" id="L241">			rs.close();</span>
<span class="fc" id="L242">			ps.close();</span>
<span class="fc" id="L243">			return loadlist;</span>
			
<span class="fc" id="L245">		} catch (SQLException e) {</span>
			
<span class="fc" id="L247">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L249">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Gets a list of all referrals sent to a patient.
	 * @param mid The patients's mid.
	 * @return The list of the referrals they received.
	 * @throws DBException
	 */
	public List&lt;ReferralBean&gt; getReferralsForPatient(long mid) throws DBException {
<span class="fc" id="L260">		Connection conn = null;</span>
<span class="fc" id="L261">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L263">			conn = factory.getConnection();</span>
<span class="fc" id="L264">			ps = conn.prepareStatement(&quot;SELECT * FROM referrals WHERE PatientID = ? ORDER BY viewed_by_patient, PriorityCode ASC&quot;);</span>
<span class="fc" id="L265">			ps.setLong(1, mid);</span>
<span class="fc" id="L266">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L267">			List&lt;ReferralBean&gt; loadlist = referralLoader.loadList(rs);</span>
<span class="fc" id="L268">			rs.close();</span>
<span class="fc" id="L269">			ps.close();</span>
<span class="fc" id="L270">			return loadlist;</span>
			
<span class="fc" id="L272">		} catch (SQLException e) {</span>
			
<span class="fc" id="L274">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L276">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Gets a list of all referrals sent to a patient
	 * @param mid The patients's mid.
	 * @return The list of the referrals they received that were unread.
	 * @throws DBException
	 */
	public List&lt;ReferralBean&gt; getReferralsForReceivingHCPUnread(long mid) throws DBException {
<span class="fc" id="L287">		Connection conn = null;</span>
<span class="fc" id="L288">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L290">			conn = factory.getConnection();</span>
<span class="fc" id="L291">			ps = conn.prepareStatement(&quot;SELECT * FROM referrals WHERE ReceiverID = ? AND viewed_by_HCP = false&quot;);</span>
<span class="fc" id="L292">			ps.setLong(1, mid);</span>
<span class="fc" id="L293">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L294">			List&lt;ReferralBean&gt; loadlist = referralLoader.loadList(rs);</span>
<span class="fc" id="L295">			rs.close();</span>
<span class="fc" id="L296">			ps.close();</span>
<span class="fc" id="L297">			return loadlist;</span>
			
<span class="fc" id="L299">		} catch (SQLException e) {</span>
			
<span class="fc" id="L301">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L303">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Gets a list of all referrals sent to a patient
	 * @param mid The patients's mid.
	 * @return The list of the referrals they received that were unread.
	 * @throws DBException
	 */
	public List&lt;ReferralBean&gt; getReferralsForPatientUnread(long mid) throws DBException {
<span class="fc" id="L314">		Connection conn = null;</span>
<span class="fc" id="L315">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L317">			conn = factory.getConnection();</span>
<span class="fc" id="L318">			ps = conn.prepareStatement(&quot;SELECT * FROM referrals WHERE PatientID = ? AND viewed_by_patient = false&quot;);</span>
<span class="fc" id="L319">			ps.setLong(1, mid);</span>
<span class="fc" id="L320">			ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L321">			List&lt;ReferralBean&gt; loadlist = referralLoader.loadList(rs);</span>
<span class="fc" id="L322">			rs.close();</span>
<span class="fc" id="L323">			ps.close();</span>
<span class="fc" id="L324">			return loadlist;</span>
			
<span class="fc" id="L326">		} catch (SQLException e) {</span>
			
<span class="fc" id="L328">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L330">			DBUtil.closeConnection(conn, ps);</span>
		}
	}

	/**
	 * Updates a given referral in the database.
	 * @param r The referral to update.
	 * @throws DBException
	 */
	public void editReferral(ReferralBean r) throws DBException {
<span class="fc" id="L340">		Connection conn = null;</span>
<span class="fc" id="L341">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L343">			conn = factory.getConnection();</span>
<span class="fc" id="L344">			ps = conn.prepareStatement(&quot;UPDATE referrals SET PatientID=?,SenderID=?,ReceiverID=?,&quot;</span>
					+ &quot;ReferralDetails=?,OVID=?,viewed_by_patient=?,viewed_by_HCP=?,PriorityCode=?  WHERE ID=?&quot;);
<span class="fc" id="L346">			referralLoader.loadParameters(ps, r);</span>
<span class="fc" id="L347">			ps.setLong(9, r.getId());</span>
<span class="fc" id="L348">			ps.executeUpdate();</span>
<span class="fc" id="L349">			ps.close();</span>
<span class="fc" id="L350">		} catch (SQLException e) {</span>
			
<span class="fc" id="L352">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L354">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L355">		}</span>
<span class="fc" id="L356">	}</span>
	
	/**
	 * Adds a given referral to the database.
	 * @param r The referral to add.
	 * @return DBUtil
	 * @throws DBException
	 */
	public long addReferral(ReferralBean r) throws DBException {
<span class="fc" id="L365">		Connection conn = null;</span>
<span class="fc" id="L366">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L368">			conn = factory.getConnection();</span>
<span class="fc" id="L369">			ps = conn.prepareStatement(&quot;INSERT INTO referrals (PatientID,SenderID,ReceiverID,&quot;</span>
					+ &quot;ReferralDetails,OVID,viewed_by_patient,viewed_by_HCP,PriorityCode,TimeStamp)  &quot;
					+ &quot;VALUES (?,?,?,?,?,?,?,?,NOW())&quot;);
<span class="fc" id="L372">			ps = referralLoader.loadParameters(ps, r);</span>
<span class="fc" id="L373">			ps.executeUpdate();</span>
<span class="fc" id="L374">			ps.close();</span>
<span class="fc" id="L375">			return DBUtil.getLastInsert(conn);</span>
<span class="fc" id="L376">		} catch (SQLException e) {</span>
			
<span class="fc" id="L378">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L380">			DBUtil.closeConnection(conn, ps);</span>
		}
	}
	
	/**
	 * Removes the given referral.
	 * 
	 * @param id The unique ID of the referral to be removed.
	 * @throws DBException
	 */
	public void removeReferral(long id) throws DBException {
<span class="fc" id="L391">		Connection conn = null;</span>
<span class="fc" id="L392">		PreparedStatement ps = null;</span>
		try {
<span class="fc" id="L394">			conn = factory.getConnection();</span>
<span class="fc" id="L395">			ps = conn.prepareStatement(&quot;DELETE FROM referrals WHERE ID=? &quot;);</span>
<span class="fc" id="L396">			ps.setLong(1, id);</span>
<span class="fc" id="L397">			ps.executeUpdate();</span>
<span class="fc" id="L398">			ps.close();</span>
<span class="fc" id="L399">		} catch (SQLException e) {</span>
			
<span class="fc" id="L401">			throw new DBException(e);</span>
		} finally {
<span class="fc" id="L403">			DBUtil.closeConnection(conn, ps);</span>
<span class="fc" id="L404">		}</span>
<span class="fc" id="L405">	}</span>


	/**
	 * An abstract class that encapsulates a sorted query of referrals.  
	 * Derived classes provide the user id which all retrieved referrals will 
	 * contain.
	 */
	public abstract class ReferralListQuery {
		
		private DAOFactory factory;
		private long userid;
		private HashMap&lt;String, String&gt; sortColumns;
		
		/**
		 * Create a new ReferralListQuery object.
		 * @param factory factory
		 * @param userid userid
		 */
<span class="fc" id="L424">		public ReferralListQuery(DAOFactory factory, long userid) {</span>
<span class="fc" id="L425">			this.factory = factory;</span>
<span class="fc" id="L426">			this.userid = userid;</span>
			// initialize lookup map
<span class="fc" id="L428">			sortColumns = new HashMap&lt;String, String&gt;();</span>
<span class="fc" id="L429">			sortColumns.put(&quot;patientName&quot;, &quot;CONCAT(patients.lastName, ' ', patients.firstName)&quot;);</span>
<span class="fc" id="L430">			sortColumns.put(&quot;receiverName&quot;, &quot;CONCAT(preceiver.lastName, preceiver.firstName)&quot;);</span>
<span class="fc" id="L431">			sortColumns.put(&quot;senderName&quot;, &quot;CONCAT(psender.lastName, psender.firstName)&quot;);</span>
<span class="fc" id="L432">			sortColumns.put(&quot;timestamp&quot;, &quot;referrals.timestamp&quot;);</span>
<span class="fc" id="L433">			sortColumns.put(&quot;priority&quot;, &quot;referrals.PriorityCode&quot;);</span>
<span class="fc" id="L434">		}</span>
		
		/**
		 * Perform the query.
		 * 
		 * @param sortField The pseudo-field name in which to sort.
		 * @param dir The direction of the desired sort (ascending or 
		 * 			  descending)
		 * @return A list of VerboseReferralBeans.
		 * @throws DBException
		 */
		protected List&lt;VerboseReferralBean&gt; doquery(String sortField, SortDirection dir) throws DBException {
<span class="fc" id="L446">			String stmt = </span>
				&quot;SELECT &quot; +
				    &quot;CONCAT(psender.firstName,' ',psender.lastName) AS senderName, &quot; +
				    &quot;CONCAT(preceiver.firstName,' ',preceiver.lastName) AS receiverName, &quot; +
				    &quot;referrals.*, &quot; +
				    &quot;officevisits.visitDate, &quot; +
				    &quot;CONCAT(patients.firstName,' ',patients.lastName) AS patientName &quot; +
				&quot;FROM &quot; +
				    &quot;referrals, &quot; +
				    &quot;personnel AS psender, &quot; +
				    &quot;personnel AS preceiver, &quot; +
				    &quot;patients, &quot; +
				    &quot;officevisits &quot; +
				&quot;WHERE &quot; +
				    &quot;referrals.SenderID=psender.mid &quot; +
				    &quot;AND referrals.ReceiverID=preceiver.mid &quot; +
				    &quot;AND referrals.PatientID=patients.mid &quot; +
				    &quot;AND referrals.ovid=officevisits.id &quot;;
<span class="fc" id="L464">			stmt += String.format(&quot;AND %s = ? &quot;, getUserField());</span>
<span class="fc" id="L465">			stmt += buildSort(sortField, dir);</span>
			
<span class="fc" id="L467">			Connection conn = null;</span>
<span class="fc" id="L468">			PreparedStatement ps = null;</span>
			try {
<span class="fc" id="L470">				conn = factory.getConnection();</span>
<span class="fc" id="L471">				ps = conn.prepareStatement(stmt);</span>
<span class="fc" id="L472">				ps.setLong(1, getUserId());</span>
<span class="fc" id="L473">				ResultSet rs = ps.executeQuery();</span>
<span class="fc" id="L474">				List&lt;VerboseReferralBean&gt; loadlist = verboseLoader.loadList(rs);</span>
<span class="fc" id="L475">				rs.close();</span>
<span class="fc" id="L476">				ps.close();</span>
<span class="fc" id="L477">				return loadlist;</span>
				
<span class="fc" id="L479">			} catch (SQLException e) {</span>
				
<span class="fc" id="L481">				throw new DBException(e);</span>
			} finally {
<span class="fc" id="L483">				DBUtil.closeConnection(conn, ps);</span>
			}
		}
		
		/**
		 * Perform the query.
		 * 
		 * @param sortField The pseudo-field name in which to sort.
		 * @param dir The direction of the desired sort (ascending or 
		 * 			  descending)
		 * @return A list of VerboseReferralBeans.
		 * @throws DBException
		 */
		public List&lt;VerboseReferralBean&gt; query(String sortField, SortDirection dir) throws DBException {
<span class="fc" id="L497">			List&lt;VerboseReferralBean&gt; beans = doquery(sortField, dir);</span>
<span class="fc" id="L498">			return beans;</span>
		}
		
		/**
		 * Get the name of the user pseudo-field which is used to limit the 
		 * query.  Only referrals where this field equals a specific user id 
		 * will be returned.  This must be overridden by derived classes.
		 * 
		 * @return The user field as a string.
		 */
		protected abstract String getUserField();
		
		/**
		 * getUserId
		 * @return long
		 */
<span class="fc" id="L514">		protected long getUserId() { return userid; }</span>
		
		/**
		 * Builds the sort portion of the SQL query (i.e. the ORDER BY... portion).
		 * 
		 * @param sortField The pseudo-field to sort on.
		 * @param dir The sort direction.
		 * @return A string which can be a part of an SQL query.
		 */
		protected String buildSort(String sortField, SortDirection dir) {
<span class="fc" id="L524">			String sortexp = sortColumns.get(sortField);</span>
<span class="fc" id="L525">			return String.format(&quot; ORDER BY %s %s &quot;, sortexp, dir);</span>
		}
	}
	
	/**
	 * Concrete ReferralListQuery for accessing an HCPs sent referrals.
	 */
	public class SenderReferralListQuery extends ReferralListQuery {

		/**
		 * SenderReferralListQuery
		 * @param factory factory
		 * @param userid userid
		 */
<span class="fc" id="L539">		public SenderReferralListQuery(DAOFactory factory, long userid) {</span>
<span class="fc" id="L540">			super(factory, userid);</span>
<span class="fc" id="L541">		}</span>

		@Override
		protected String getUserField() {
<span class="fc" id="L545">			return &quot;referrals.SenderID&quot;;</span>
		}
	}
	
	/**
	 * Concrete ReferralListQuery for accessing an HCPs received referrals.
	 */
	public class ReceiverReferralListQuery extends ReferralListQuery {

		/**
		 * ReceiverReferralListQuery
		 * @param factory factory
		 * @param userid userid
		 */
<span class="fc" id="L559">		public ReceiverReferralListQuery(DAOFactory factory, long userid) {</span>
<span class="fc" id="L560">			super(factory, userid);</span>
<span class="fc" id="L561">		}</span>

		@Override
		protected String getUserField() {
<span class="fc" id="L565">			return &quot;referrals.ReceiverID&quot;;</span>
		}
	}
	
	/**
	 * Concrete ReferralListQuery for accessing a patients referrals.
	 */
	public class PatientReferralListQuery extends ReferralListQuery {

		/**
		 * PatientReferralListQuery
		 * @param factory factory
		 * @param userid userid
		 */
<span class="fc" id="L579">		public PatientReferralListQuery(DAOFactory factory, long userid) {</span>
<span class="fc" id="L580">			super(factory, userid);</span>
<span class="fc" id="L581">		}</span>

		@Override
		protected String getUserField() {
<span class="fc" id="L585">			return &quot;referrals.PatientID&quot;;</span>
		}
	}
	
	/**
	 * Get a referral query for a sending HCP.
	 * @param mid The HCP id.
	 * @return A ReferralListQuery object.
	 */
	public ReferralListQuery getSenderQuery(long mid) {
<span class="fc" id="L595">		return new SenderReferralListQuery(this.factory, mid);</span>
	}
	
	/**
	 * Get a referral query for a receiving HCP.
	 * @param mid The HCP id.
	 * @return A ReferralListQuery object.
	 */
	public ReferralListQuery getReceiverQuery(long mid) {
<span class="fc" id="L604">		return new ReceiverReferralListQuery(this.factory, mid);</span>
	}
	
	/**
	 * Get a referral query for a patient.
	 * @param pid pid
	 * @return A ReferralListQuery object.
	 */
	public ReferralListQuery getPatientQuery(long pid) {
<span class="fc" id="L613">		return new PatientReferralListQuery(this.factory, pid);</span>
	}
	
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>