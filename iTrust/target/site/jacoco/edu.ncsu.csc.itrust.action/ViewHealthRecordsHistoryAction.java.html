<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ViewHealthRecordsHistoryAction.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.action</a> &gt; <span class="el_source">ViewHealthRecordsHistoryAction.java</span></div><h1>ViewHealthRecordsHistoryAction.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.action;

import java.util.Calendar;
import java.util.Date;
import java.util.List;

import edu.ncsu.csc.itrust.beans.CDCStatsBean;
import edu.ncsu.csc.itrust.beans.NormalBean;
import edu.ncsu.csc.itrust.beans.OfficeVisitBean;
import edu.ncsu.csc.itrust.beans.PatientBean;
import edu.ncsu.csc.itrust.beans.HealthRecord;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.dao.mysql.AuthDAO;
import edu.ncsu.csc.itrust.dao.mysql.CDCBmiStatsDAO;
import edu.ncsu.csc.itrust.dao.mysql.CDCHeadCircStatsDAO;
import edu.ncsu.csc.itrust.dao.mysql.CDCHeightStatsDAO;
import edu.ncsu.csc.itrust.dao.mysql.CDCStatsDAO;
import edu.ncsu.csc.itrust.dao.mysql.CDCWeightStatsDAO;
import edu.ncsu.csc.itrust.dao.mysql.HealthRecordsDAO;
import edu.ncsu.csc.itrust.dao.mysql.NormalDAO;
import edu.ncsu.csc.itrust.dao.mysql.OfficeVisitDAO;
import edu.ncsu.csc.itrust.dao.mysql.PatientDAO;
import edu.ncsu.csc.itrust.enums.Role;
import edu.ncsu.csc.itrust.enums.TransactionType;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.exception.ITrustException;

/**
 * ViewHealthRecordsHistoryAction is an action class used for viewing a patient's health records.
 * Allows a patient or hcp to view a patient's health records dependent on the age. Contains methods 
 * that will sort health records by age during the office visit, calculating z scores for health metrics,
 * and calculating percentiles for those z scores. 
 */
public class ViewHealthRecordsHistoryAction {
	
	/** The number of months in a year */
	public static final int MONTHS_IN_YEAR = 12;
	/** The integer for representing a Male patient */
	public static final int MALE = 1;
	/** The integer for representing a Female patient */
	public static final int FEMALE = 2;
	/** Pounds in a kilogram */
	public static final double POUNDS_IN_KG = 2.2046;
	/** Inches in a centimeter */
	public static final double INCHES_IN_CM = 0.3937;
	/** The max z score value in the normal distribution table */
	public static final double MAX_Z = 5.09;
	/** The min z score value in the normal distribution table */
	public static final double MIN_Z = -4;
	
	private PatientDAO patientDAO;
	private HealthRecordsDAO hrDAO;
	private OfficeVisitDAO ovDAO;
	private AuthDAO authDAO;
	private CDCWeightStatsDAO weightStatsDAO;
	private CDCHeightStatsDAO heightStatsDAO;
	private CDCHeadCircStatsDAO headCircStatsDAO;
	private CDCBmiStatsDAO bmiStatsDAO;
	private NormalDAO normalDAO;
<span class="fc" id="L60">	private long patientID = 0;</span>
	
	
	private Role user;
	
	private long loggedInMID;
	
	private EventLoggingAction loggingAction;
	
	/**
	 * Constructor for ViewHealthRecordsHistoryAction. Initializes all DAO field objects with the DAOFactory that is passed
	 * in. Also sets the pid of the patient whose records are to be viewed and saves the logged in user's mid for logging.
	 * @param factory the DAOFactory to have database interactions with
	 * @param pidString the String representing the patient's mid
	 * @param loggedInMID long for the logged in user's mid
	 * @throws ITrustException
	 */
<span class="fc" id="L77">	public ViewHealthRecordsHistoryAction(DAOFactory factory, String pidString, long loggedInMID) throws ITrustException{</span>
<span class="fc" id="L78">		init(factory);</span>
<span class="fc" id="L79">		weightStatsDAO = new CDCWeightStatsDAO(factory);</span>
<span class="fc" id="L80">		heightStatsDAO = new CDCHeightStatsDAO(factory);</span>
<span class="fc" id="L81">		headCircStatsDAO = new CDCHeadCircStatsDAO(factory);</span>
<span class="fc" id="L82">		bmiStatsDAO = new CDCBmiStatsDAO(factory);</span>
<span class="fc" id="L83">		normalDAO = new NormalDAO(factory);</span>
<span class="fc" id="L84">		this.patientID = Long.parseLong(pidString);</span>
<span class="fc" id="L85">		this.user = authDAO.getUserRole(loggedInMID);</span>
<span class="fc" id="L86">		this.loggedInMID = loggedInMID;</span>
			
<span class="fc" id="L88">	}</span>
	
	/**
	 * Initializes the DAO fields by getting them from the DAOFactory passed in from the constructor
	 * @param factory DAOFactory to initialize the DAO fields with
	 */
	private void init(DAOFactory factory){
<span class="fc" id="L95">		authDAO = factory.getAuthDAO();</span>
<span class="fc" id="L96">		hrDAO = factory.getHealthRecordsDAO();</span>
<span class="fc" id="L97">		ovDAO = factory.getOfficeVisitDAO();</span>
<span class="fc" id="L98">		patientDAO = factory.getPatientDAO();</span>
		
<span class="fc" id="L100">		loggingAction = new EventLoggingAction(factory);		</span>
<span class="fc" id="L101">	}</span>
	
	/**
	 * Gets the patient's MID as a long
	 * @return the patient's mid
	 */
	public long getPatientID(){
<span class="fc" id="L108">		return patientID;</span>
	}
	
	/**
	 * Get the patient's name as a String
	 * @return the patient's name
	 * @throws ITrustException
	 */
	public String getPatientName() throws ITrustException{
<span class="fc" id="L117">		return patientDAO.getName(patientID);</span>
	}
	
	/**
	 * Gets all of a patient's health records. Returns an ordered list starting from when the patient is youngest 
	 * to oldest at the time the health record was taken.
	 * @return list of health records ordered by oldest to most recent
	 * @throws ITrustException
	 */
	public List&lt;HealthRecord&gt; getAllPatientHealthRecords() throws ITrustException{
		
<span class="fc bfc" id="L128" title="All 2 branches covered.">		if(user.getUserRolesString().equals(&quot;patient&quot;)){</span>
			//Log for a patient
<span class="fc" id="L130">			loggingAction.logEvent(TransactionType.PATIENT_VIEW_BASIC_HEALTH_METRICS, loggedInMID, patientID, &quot;&quot;);</span>
		}
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">		if(user.getUserRolesString().equals(&quot;hcp&quot;)){</span>
			//Log for an HCP
<span class="nc" id="L134">			loggingAction.logEvent(TransactionType.HCP_VIEW_BASIC_HEALTH_METRICS, loggedInMID, patientID, &quot;&quot;);</span>
			
		}
		//Get the patient's date of birth
<span class="fc" id="L138">		Date dateOfBirth = patientDAO.getPatient(patientID).getDateOfBirth();</span>
		
		//Age 3 date
<span class="fc" id="L141">		Calendar ovDateLower = Calendar.getInstance();</span>
<span class="fc" id="L142">		ovDateLower.setTime(dateOfBirth);</span>
<span class="fc" id="L143">		ovDateLower.add(Calendar.YEAR, 3);</span>
		
		//Age 12 date
<span class="fc" id="L146">		Calendar ovDateUpper = Calendar.getInstance();</span>
<span class="fc" id="L147">		ovDateUpper.setTime(dateOfBirth);</span>
<span class="fc" id="L148">		ovDateUpper.add(Calendar.YEAR, 12);		</span>
		
<span class="fc" id="L150">		List&lt;HealthRecord&gt; adultList = hrDAO.getAllRecordsAfterOVDate(patientID, ovDateUpper.getTime());</span>
<span class="fc" id="L151">		List&lt;HealthRecord&gt; youthList = hrDAO.getAllRecordsBetweenOVDates(patientID, ovDateLower.getTime(), ovDateUpper.getTime());</span>
<span class="fc" id="L152">		List&lt;HealthRecord&gt; babyList = hrDAO.getAllRecordsBeforeOVDate(patientID, ovDateLower.getTime());</span>
		
<span class="fc" id="L154">		youthList.addAll(adultList);</span>
<span class="fc" id="L155">		babyList.addAll(youthList);</span>
		
<span class="fc" id="L157">		List&lt;HealthRecord&gt; allList = babyList;</span>
		
<span class="fc" id="L159">		return allList;		</span>
	}
	
	/**
	 * Calculates the percentile based on a z score. Turns the z score into a string that has significant figures to
	 * two decimal places. Uses the z score value up to the first decimal digit to get a normal bean from the database.
	 * After getting the normal bean, the percentile is obtained from the bean based on the last digit (value from the 
	 * second decimal place). 
	 * @param zScore the z-score to get the percentile for as a double. Z score should be an up to 2 decimal digit value.
	 * @return The percentile obtained from the z-score value
	 * -1 is returned if there is an error finding the z score in the database.
	 * @throws DBException 
	 */
	public double getPercentile(double zScore) throws DBException {
<span class="fc bfc" id="L173" title="All 2 branches covered.">		if (zScore &lt; MIN_Z) {</span>
<span class="fc" id="L174">			return 0.0;</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">		} else if (zScore &gt; MAX_Z) {</span>
<span class="fc" id="L176">			return 100.0;</span>
		}
		
		//Convert the z score into a string rounded to two decimal places
<span class="fc" id="L180">		String zString = String.format(&quot;%.2f&quot;, zScore);</span>
		//Get the normal bean for the z score based on the z score value up to the first decimal digit
<span class="fc" id="L182">		NormalBean normal = normalDAO.getNormal(Double.parseDouble(zString.substring(0, zString.length() - 1)));</span>
		//If the z score cannot be found in the database, return -1
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">		if (normal == null)</span>
<span class="nc" id="L185">			return -1;</span>
		
		//Double value for holding the percentile
		double percentile;
		
		//Get the percentile based on the last decimal digit value 
<span class="fc bfc" id="L191" title="All 10 branches covered.">		switch (Integer.parseInt(zString.substring(zString.length() - 1))) {</span>
			case 1:
<span class="fc" id="L193">				percentile = normal.get_01();</span>
<span class="fc" id="L194">				break;</span>
			case 2:
<span class="fc" id="L196">				percentile = normal.get_02();</span>
<span class="fc" id="L197">				break;</span>
			case 3:
<span class="fc" id="L199">				percentile = normal.get_03();</span>
<span class="fc" id="L200">				break;</span>
			case 4:
<span class="fc" id="L202">				percentile = normal.get_04();</span>
<span class="fc" id="L203">				break;</span>
			case 5:
<span class="fc" id="L205">				percentile = normal.get_05();</span>
<span class="fc" id="L206">				break;</span>
			case 6:
<span class="fc" id="L208">				percentile = normal.get_06();</span>
<span class="fc" id="L209">				break;</span>
			case 7:
<span class="fc" id="L211">				percentile = normal.get_07();</span>
<span class="fc" id="L212">				break;</span>
			case 8:
<span class="fc" id="L214">				percentile = normal.get_08();</span>
<span class="fc" id="L215">				break;</span>
			case 9:
<span class="fc" id="L217">				percentile = normal.get_09();</span>
<span class="fc" id="L218">				break;</span>
			default:
				//If the value is not 1-9 then it is 0
<span class="fc" id="L221">				percentile = normal.get_00();</span>
				break;
		}
		
		//Multiply the percentile value by 100 to actually get a percent value
<span class="fc" id="L226">		percentile = percentile * 100;</span>
		//Format the percent to two decimal places
<span class="fc" id="L228">		percentile = Double.parseDouble(String.format(&quot;%.2f&quot;, percentile));</span>
		
		//Return the percentile
<span class="fc" id="L231">		return percentile;</span>
	}
	
	/**
	 * Calculates the z score for a patient's weight depending on his or her age and sex. References
	 * values from the cdc weight statistics table. Takes the L (Box-Cox transformation), M (median), and
	 * S (generalized coefficient of variation) and calculates the z-score using the following equation:
	 * Z = ((X / M) ^ L - 1) / (L * S), if L != 0
	 * and
	 * Z = ln(X / M) / S, if L == 0
	 * where X is the patient's weight in kilograms. 
	 * After the z score is calculated, it is rounded to two decimal places before it is returned.
	 * @param record the HealthRecord to get the patient's weight z score for
	 * @return the z score of the patient's weight at the office visit's rounded to two decimal places.
	 * -999 is also returned if there is no matching CDC stats entry in the database.
	 * @throws DBException
	 */
	public double getWeightZScore(HealthRecord record) throws DBException {
		//Get the CDCStatsBean for a patient's weight at his or her age
<span class="fc" id="L250">		CDCStatsBean statsBean = getCDCStatsBean(record, weightStatsDAO);</span>
		//If there is no matching entry in the CDC Stats table then return -999
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">		if (statsBean == null)</span>
<span class="nc" id="L253">			return -999;</span>
		
		//Get the weight in kilograms
<span class="fc" id="L256">		double weight = record.getWeight() / POUNDS_IN_KG;</span>
		
		//Get the z score for the patient's weight
<span class="fc" id="L259">		double zScore = getZScore(statsBean, weight);</span>
		
<span class="fc" id="L261">		return zScore;</span>
	}
	
	/**
	 * Calculates the z score for a patient's height depending on his or her age and sex. References
	 * values from the cdc height statistics table. Takes the L (Box-Cox transformation), M (median), and
	 * S (generalized coefficient of variation) and calculates the z-score using the following equation:
	 * Z = ((X / M) ^ L - 1) / (L * S), if L != 0
	 * and
	 * Z = ln(X / M) / S, if L == 0
	 * where X is the patient's height in centimeters.
	 * After the z score is calculated, it is rounded to two decimal places before it is returned.
	 * @param record the HealthRecord to get the patient's height z score for
	 * @return the z score of the patient's height at the office visit's rounded to two decimal places.
	 * -999 is also returned if there is no matching CDC stats entry in the database.
	 * @throws DBException
	 */
	public double getHeightZScore(HealthRecord record) throws DBException {
		//Get the CDCStatsBean for a patient's height at his or her age
<span class="fc" id="L280">		CDCStatsBean statsBean = getCDCStatsBean(record, heightStatsDAO);</span>
		//If there is no matching entry in the CDC Stats table then return -999
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">		if (statsBean == null)</span>
<span class="nc" id="L283">			return -999;</span>
		
		//Get the height in centimeters
<span class="fc" id="L286">		double height = record.getHeight() / INCHES_IN_CM;</span>
		
		//Get the z score for the patient's height
<span class="fc" id="L289">		double zScore = getZScore(statsBean, height);</span>
		
<span class="fc" id="L291">		return zScore;</span>
	}
	
	/**
	 * Calculates the z score for a patient's head circumference depending on his or her age and sex. References
	 * values from the cdc head circumference statistics table. Takes the L (Box-Cox transformation), M (median), and
	 * S (generalized coefficient of variation) and calculates the z-score using the following equation:
	 * Z = ((X / M) ^ L - 1) / (L * S), if L != 0
	 * and
	 * Z = ln(X / M) / S, if L == 0
	 * where X is the patient's head circumference in centimeters.
	 * After the z score is calculated, it is rounded to two decimal places before it is returned.
	 * @param record the HealthRecord to get the patient's head circumference z score for
	 * @return the z score of the patient's head circumference at the office visit's rounded to two decimal places
	 * -999 is also returned if there is no matching CDC stats entry in the database.
	 * @throws DBException
	 */
	public double getHeadCircZScore(HealthRecord record) throws DBException {
		//Get the CDCStatsBean for a patient's head circumference at his or her age
<span class="fc" id="L310">		CDCStatsBean statsBean = getCDCStatsBean(record, headCircStatsDAO);</span>
		//If there is no matching entry in the CDC Stats table then return -999
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">		if (statsBean == null)</span>
<span class="nc" id="L313">			return -999;</span>
		
		//Get the head cirumference in centimeters
<span class="fc" id="L316">		double headCirc = record.getHeadCircumference() / INCHES_IN_CM;</span>
		
		//Get the z score for the patient's head circumference
<span class="fc" id="L319">		double zScore = getZScore(statsBean, headCirc);</span>
		
<span class="fc" id="L321">		return zScore;</span>
	}
	
	/**
	 * Calculates the z score for a patient's bmi depending on his or her age and sex. References
	 * values from the cdc bmi statistics table. Takes the L (Box-Cox transformation), M (median), and
	 * S (generalized coefficient of variation) and calculates the z-score using the following equation:
	 * Z = ((X / M) ^ L - 1) / (L * S), if L != 0
	 * and
	 * Z = ln(X / M) / S, if L == 0
	 * where X is the patient's bmi in centimeters.
	 * After the z score is calculated, it is rounded to two decimal places before it is returned.
	 * @param record the HealthRecord to get the patient's bmi z score for
	 * @return the z score of the patient's bmi at the office visit's rounded to two decimal places
	 * -999 is also returned if there is no matching CDC stats entry in the database.
	 * @throws DBException
	 */
	public double getBMIZScore(HealthRecord record) throws DBException {
		//Get the CDCStatsBean for a patient's BMI at his or her age
<span class="fc" id="L340">		CDCStatsBean statsBean = getCDCStatsBean(record, bmiStatsDAO);</span>
		//If there is no matching entry in the CDC Stats table then return -999
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">		if (statsBean == null)</span>
<span class="nc" id="L343">			return -999;</span>
		
		//Get the bmi of the patient
<span class="fc" id="L346">		double bmi = record.getBodyMassIndex();</span>
		
		//Get the z score for the patient's bmi
<span class="fc" id="L349">		double zScore = getZScore(statsBean, bmi);</span>
		
<span class="fc" id="L351">		return zScore;</span>
	}
	
	/**
	 * Gets a CDCStatsBean based on a patient's age, sex, and health metric. Reads in a CDCStatsDAO that 
	 * determines what database the bean is taken from.
	 * @param record the HealthRecord object that a patient's age is calculated from
	 * @param statsDAO the CDCStatsDAO to get a the CDCStatsBean from
	 * @return a CDCStatsBean based on the patient's age, sex, and health metric
	 * @throws DBException
	 */
	private CDCStatsBean getCDCStatsBean(HealthRecord record, CDCStatsDAO statsDAO) throws DBException {
		//Integer for holding the patient's gender
<span class="fc" id="L364">		int sex = 0;</span>
		//Get the patient's gender
<span class="pc bpc" id="L366" title="1 of 2 branches missed.">		if (patientDAO.getPatient(patientID).getGender().toString().equals(&quot;Male&quot;)) {</span>
<span class="fc" id="L367">			sex = MALE;</span>
		} else {
<span class="nc" id="L369">			sex = FEMALE;</span>
		}
		
		//Get the patient's age
<span class="fc" id="L373">		float age = 0;</span>
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">		if (record.getVisitDate().equals(patientDAO.getPatient(patientID).getDateOfBirth())) {</span>
			//If the patient's birthdate equals the office visit date, 
			//the patient's age is 0 months
<span class="nc" id="L377">			age = (float) 0.0;</span>
		} else {
			//Otherwise add 0.5 to the patient's age in months
<span class="fc" id="L380">			age = (float) (calculateAgeInMonthsAtOfficeVisit(record.getOfficeVisitID()) + 0.5);</span>
		}
		
		//Get the CDCStatsBean for a patient's health metric at his or her age
<span class="fc" id="L384">		CDCStatsBean statsBean = statsDAO.getCDCStats(sex, age);</span>
		
<span class="pc bpc" id="L386" title="3 of 4 branches missed.">		if (statsBean == null &amp;&amp; age != 0) {</span>
			//If there is no match with the specified age and sex, 
			//query again with the age rounded down as a whole number
<span class="nc" id="L389">			statsBean = statsDAO.getCDCStats(sex, (float) Math.floor(age));</span>
		}
		
<span class="fc" id="L392">		return statsBean;</span>
	}
	
	/**
	 * Calculates the z score for a patient's health metric. Takes the L (Box-Cox transformation), M (median), 
	 * and S (generalized coefficient of variation) from the passed in CDCStatsBean and calculates the z-score 
	 * using the following equation:
	 * Z = ((X / M) ^ L - 1) / (L * S), if L != 0
	 * and
	 * Z = ln(X / M) / S, if L == 0
	 * where X is the patient's health metric in metric units (Centimeters for height and head circumference. 
	 * Kilograms for weight). After the z score is calculated, it is rounded to two decimal places before it 
	 * is returned.
	 * @param statsBean The stats bean for 
	 * @param healthMetric value for the health metric to get a z score for. 
	 * (In cm for height and head circumference. In kg for weight)
	 * @return the z score for the health metric value based on the L, M, and S values from the CDCStatsBean.
	 */
	private double getZScore(CDCStatsBean statsBean, double healthMetric) {
		//Get the L, M, and S values for a patient's bmi at his or her age
<span class="fc" id="L412">		double L = statsBean.getL();</span>
<span class="fc" id="L413">		double M = statsBean.getM();</span>
<span class="fc" id="L414">		double S = statsBean.getS();</span>
		
		//Double for holding the z-score
		double zScore;
		
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">		if (L == 0.0) {</span>
			//If L is 0 then calculate the z score differently
<span class="nc" id="L421">			zScore = Math.log(healthMetric / M) / S;</span>
		} else {
<span class="fc" id="L423">			zScore = (Math.pow((healthMetric / M), L) - 1) / (L * S);</span>
		} 
		
		//Round the z score to two decimal places
<span class="fc" id="L427">		zScore = Double.parseDouble(String.format(&quot;%.2f&quot;, zScore));</span>
		
<span class="fc" id="L429">		return zScore;</span>
	}
	
	/**
	 * Returns the patient's gender for use in percentile charting.
	 * @return patient gender as a string: &quot;Male&quot; or &quot;Female&quot;
	 * @throws DBException
	 */
	public String getPatientGender() throws DBException{
<span class="nc" id="L438">		return patientDAO.getPatient(patientID).getGender().toString();</span>
		
	}
	
	/**
	 * Calculates the patient's age during an office visit. Reads in an office visit ID and gets 
	 * its visit date to check against the patient's birthday. Returns the patient's age in months.
	 * @param ovID long for the office visit ID of the office visit to get the patient's age for
	 * @return the patient's age in months
	 * @throws DBException
	 */
	public int calculateAgeInMonthsAtOfficeVisit(long ovID) throws DBException{
		//Create int for patient's age in months
<span class="fc" id="L451">		int ageInMonths = 0;</span>
		
		//Get office visit information		
<span class="fc" id="L454">		Calendar ovDate = Calendar.getInstance();</span>
<span class="fc" id="L455">		OfficeVisitBean ov = ovDAO.getOfficeVisit(ovID);</span>
<span class="fc" id="L456">		ovDate.setTime(ov.getVisitDate());		</span>
		
		//Get the patient's birthdate	
<span class="fc" id="L459">		Calendar dateOfBirth = Calendar.getInstance();</span>
<span class="fc" id="L460">		PatientBean patient = patientDAO.getPatient(patientID);</span>
<span class="fc" id="L461">		dateOfBirth.setTime(patient.getDateOfBirth());</span>
		
		//Split the patient's birthdate into day, month, and year
<span class="fc" id="L464">		int birthDay = dateOfBirth.get(Calendar.DAY_OF_MONTH);</span>
<span class="fc" id="L465">		int birthMonth = dateOfBirth.get(Calendar.MONTH) + 1;</span>
<span class="fc" id="L466">		int birthYear = dateOfBirth.get(Calendar.YEAR);</span>
		//Split the office visit date into day month and year
<span class="fc" id="L468">		int visitDay = ovDate.get(Calendar.DAY_OF_MONTH);</span>
<span class="fc" id="L469">		int visitMonth = ovDate.get(Calendar.MONTH) + 1;</span>
<span class="fc" id="L470">		int visitYear = ovDate.get(Calendar.YEAR);</span>
		
		//Calculate the year, month, and day differences
<span class="fc" id="L473">		int yearDiff = visitYear - birthYear;</span>
<span class="fc" id="L474">		int monthDiff = visitMonth - birthMonth;</span>
<span class="fc" id="L475">		int dayDiff = visitDay - birthDay;</span>
		
		//Get the patient's age in months by multiplying the year difference by 12
		//and adding the month difference
<span class="fc" id="L479">		ageInMonths = yearDiff * MONTHS_IN_YEAR + monthDiff;</span>
		
		//If the day difference is negative, subtract a month from the age
<span class="fc bfc" id="L482" title="All 2 branches covered.">		if (dayDiff &lt; 0) {</span>
<span class="fc" id="L483">			ageInMonths -= 1;</span>
		}
		
		//Return the age in months
<span class="fc" id="L487">		return ageInMonths;</span>
		
	}	

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>