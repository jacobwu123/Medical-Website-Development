<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ViewDiagnosisStatisticsAction.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.action</a> &gt; <span class="el_source">ViewDiagnosisStatisticsAction.java</span></div><h1>ViewDiagnosisStatisticsAction.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.action;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import edu.ncsu.csc.itrust.beans.DiagnosisBean;
import edu.ncsu.csc.itrust.beans.DiagnosisStatisticsBean;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.dao.mysql.DiagnosesDAO;
import edu.ncsu.csc.itrust.dao.mysql.ICDCodesDAO;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.exception.FormValidationException;
import edu.ncsu.csc.itrust.exception.ITrustException;

/**
 * Used for the View Diagnosis Statistics page. Can return a list of all Diagnoses
 * and get diagnosis statistics for a specified Zip code, Diagnosis code, and date range.
 */
public class ViewDiagnosisStatisticsAction {
	/** Database access methods for ICD codes (diagnoses) */
	private ICDCodesDAO icdDAO;
	/** Database access methods for diagnosis information */
	private DiagnosesDAO diagnosesDAO;
	/** ICD Code for malaria */
	private static final String ICD_MALARIA = &quot;84.50&quot;;
	/** ICD Code for Influenza */
	private static final String ICD_INFLUENZA = &quot;487.00&quot;;
	
	/**
	 * Constructor for the action. Initializes DAO fields
	 * @param factory The session's factory for DAOs
	 */
<span class="fc" id="L36">	public ViewDiagnosisStatisticsAction(DAOFactory factory) {</span>
<span class="fc" id="L37">		this.icdDAO = factory.getICDCodesDAO();</span>
<span class="fc" id="L38">		this.diagnosesDAO = factory.getDiagnosesDAO();</span>
<span class="fc" id="L39">	}</span>
	
	/**
	 * Gets all the diagnosis codes in iTrust and returns them in a list of beans.
	 * 
	 * @return List of DiagnosisBeans correlating to all ICDCodes
	 * @throws ITrustException
	 */
	public List&lt;DiagnosisBean&gt; getDiagnosisCodes() throws ITrustException  {
<span class="fc" id="L48">		return icdDAO.getAllICDCodes();</span>
	}
	
	/**
	 * Gets the counts of local and regional diagnoses for the specified input
	 * 
	 * @param lowerDate The beginning date for the time range
	 * @param upperDate The ending date for the time range
	 * @param icdCode The diagnosis code to examine
	 * @param zip The zip code to examine
	 * @return A bean containing the local and regional counts
	 * @throws FormValidationException
	 * @throws ITrustException
	 */
	public DiagnosisStatisticsBean getDiagnosisStatistics(String lowerDate, String upperDate, String icdCode, String zip) throws FormValidationException, ITrustException {
		DiagnosisStatisticsBean dsBean;
		try {
			
<span class="pc bpc" id="L66" title="2 of 6 branches missed.">			if (lowerDate == null || upperDate == null || icdCode == null)</span>
<span class="fc" id="L67">				return null;</span>
			
<span class="fc" id="L69">			Date lower = new SimpleDateFormat(&quot;MM/dd/yyyy&quot;).parse(lowerDate);</span>
<span class="fc" id="L70">			Date upper = new SimpleDateFormat(&quot;MM/dd/yyyy&quot;).parse(upperDate);</span>

<span class="fc bfc" id="L72" title="All 2 branches covered.">			if (lower.after(upper))</span>
<span class="fc" id="L73">				throw new FormValidationException(&quot;Start date must be before end date!&quot;);</span>
			
<span class="fc bfc" id="L75" title="All 2 branches covered.">			if (!zip.matches(&quot;([0-9]{5})|([0-9]{5}-[0-9]{4})&quot;))</span>
<span class="fc" id="L76">				throw new FormValidationException(&quot;Zip Code must be 5 digits!&quot;);</span>

<span class="fc" id="L78">			boolean validCode = false;</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">			for(DiagnosisBean diag : getDiagnosisCodes()) {</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">					if (diag.getICDCode().equals(icdCode))</span>
<span class="fc" id="L81">						validCode = true;</span>
<span class="fc" id="L82">			}</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">			if (validCode == false) {</span>
<span class="fc" id="L84">				throw new FormValidationException(&quot;ICDCode must be valid diagnosis!&quot;);</span>
			}

<span class="fc" id="L87">			dsBean = diagnosesDAO.getDiagnosisCounts(icdCode, zip, lower, upper);</span>
			
<span class="fc" id="L89">		} catch (ParseException e) {</span>
<span class="fc" id="L90">			throw new FormValidationException(&quot;Enter dates in MM/dd/yyyy&quot;);</span>
<span class="fc" id="L91">		} </span>
		
		
<span class="fc" id="L94">		return dsBean;</span>
	}
	
	/**
	 * Gets the local and regional counts for the specified week and calculates the prior average.
	 * 
	 * @param startDate a date in the week to analyze
	 * @param icdCode the diagnosis to analyze
	 * @param zip the area to analyze
	 * @param threshold threshold
	 * @return statistics for the week and previous averages
	 * @throws FormValidationException
	 * @throws DBException
	 */
	public ArrayList&lt;DiagnosisStatisticsBean&gt; getEpidemicStatistics(String startDate, String icdCode, String zip, String threshold) throws FormValidationException, DBException {
		
<span class="pc bpc" id="L110" title="2 of 4 branches missed.">		if (startDate == null || icdCode == null)</span>
<span class="nc" id="L111">			return null;</span>
		
<span class="pc bpc" id="L113" title="1 of 4 branches missed.">		if (!(icdCode.equals(&quot;84.50&quot;) || icdCode.equals(&quot;487.00&quot;)) ) {</span>
<span class="nc" id="L114">			throw new FormValidationException(&quot;Exception&quot;);</span>
		}
<span class="fc bfc" id="L116" title="All 2 branches covered.">		if(ICD_MALARIA.equals(icdCode)){</span>
			try{
<span class="nc" id="L118">				Integer.parseInt(threshold);</span>
<span class="fc" id="L119">			}catch(NumberFormatException e){</span>
<span class="fc" id="L120">				throw new FormValidationException(&quot;Threshold must be an integer.&quot;);</span>
<span class="nc" id="L121">			}</span>
		}
		Date lower;  //lower, which is parsed to startDate
		try {
<span class="fc" id="L125">			lower = new SimpleDateFormat(&quot;MM/dd/yyyy&quot;).parse(startDate);</span>
<span class="nc" id="L126">		} catch (ParseException e) {</span>
<span class="nc" id="L127">			throw new FormValidationException(&quot;Enter dates in MM/dd/yyyy&quot;);</span>
<span class="fc" id="L128">		}</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">		if (!zip.matches(&quot;([0-9]{5})|([0-9]{5}-[0-9]{4})&quot;))</span>
<span class="nc" id="L130">			throw new FormValidationException(&quot;Zip Code must be 5 digits!&quot;);</span>
		
<span class="fc" id="L132">		DiagnosisStatisticsBean dbWeek = diagnosesDAO.getCountForWeekOf(icdCode, zip, lower);</span>
<span class="fc" id="L133">		DiagnosisStatisticsBean dbAvg = new DiagnosisStatisticsBean(zip, 0, 0, lower, lower);</span>
		
<span class="fc" id="L135">		Calendar cal = Calendar.getInstance();</span>
		
<span class="fc" id="L137">		Date start = diagnosesDAO.findEarliestIncident(icdCode); //start, which is set to earliest incident</span>
<span class="fc" id="L138">		Calendar startCal = Calendar.getInstance();</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">		if(start != null)</span>
<span class="fc" id="L140">			startCal.setTime(start);</span>
		
<span class="fc" id="L142">		ArrayList&lt;DiagnosisStatisticsBean&gt; ret = new ArrayList&lt;DiagnosisStatisticsBean&gt;();</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">		if (start == null) {</span>
<span class="nc" id="L144">			ret.add(dbWeek);</span>
<span class="nc" id="L145">			ret.add(dbAvg);</span>
<span class="nc" id="L146">			return ret;</span>
		}
<span class="fc" id="L148">		cal.setTime(lower); //cal, which is set to lower</span>
<span class="fc" id="L149">		Calendar lowerCal = Calendar.getInstance();</span>
<span class="fc" id="L150">		lowerCal.setTime(lower);</span>
<span class="fc" id="L151">		int weekOfYr = cal.get(Calendar.WEEK_OF_YEAR);</span>
		
<span class="fc" id="L153">		cal.set(Calendar.YEAR, startCal.get(Calendar.YEAR));  //cal's year then gets set to start's year</span>
<span class="fc" id="L154">		ArrayList&lt;DiagnosisStatisticsBean&gt; dbList = new ArrayList&lt;DiagnosisStatisticsBean&gt;();</span>
		
<span class="pc bpc" id="L156" title="1 of 4 branches missed.">		while( cal.getTime().before(lower) &amp;&amp; cal.get(Calendar.YEAR) != lowerCal.get(Calendar.YEAR)) {</span>
<span class="fc" id="L157">			dbList.add( diagnosesDAO.getCountForWeekOf(icdCode, zip, cal.getTime()) );</span>
<span class="fc" id="L158">			cal.add(Calendar.YEAR, 1);</span>
<span class="fc" id="L159">			cal.set(Calendar.WEEK_OF_YEAR, weekOfYr);</span>
<span class="fc" id="L160">			cal.set(Calendar.DAY_OF_WEEK, Calendar.MONDAY);</span>
		}
		
<span class="fc" id="L163">		long avg = 0;</span>
<span class="fc" id="L164">		long avgRegion = 0;</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">		if (dbList.size() &gt; 0) {</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">			for (DiagnosisStatisticsBean d : dbList) {</span>
<span class="fc" id="L167">				avg += d.getZipStats();</span>
<span class="fc" id="L168">				avgRegion += d.getRegionStats();</span>
<span class="fc" id="L169">			}</span>
<span class="fc" id="L170">			avg /= dbList.size();</span>
<span class="fc" id="L171">			avgRegion /= dbList.size();</span>
		}
		
<span class="fc" id="L174">		dbAvg.setRegionStats(avgRegion);</span>
<span class="fc" id="L175">		dbAvg.setZipStats(avg);</span>
		
<span class="fc" id="L177">		ret.add(dbWeek);</span>
<span class="fc" id="L178">		ret.add(dbAvg);</span>
<span class="fc" id="L179">		return ret;</span>
	}
	
	/**
	 * Determines if an Influenza Epidemic is happening
	 * 
	 * @param curDateStr a date in the currently evaluated week
	 * @param zip the zip code to analyze
	 * @return whether or not there is an epidemic
	 * @throws ParseException
	 * @throws DBException
	 */
	public boolean isFluEpidemic(String curDateStr, String zip) throws ParseException, DBException {
<span class="fc" id="L192">		new SimpleDateFormat(&quot;MM/dd/yyyy&quot;).parse(&quot;01/04/1998&quot;);</span>
<span class="fc" id="L193">		Date curDate = new SimpleDateFormat(&quot;MM/dd/yyyy&quot;).parse(curDateStr);</span>
		
<span class="fc" id="L195">		Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L196">		cal.setTime(curDate);</span>
		
<span class="fc" id="L198">		int weekOfYr = cal.get(Calendar.WEEK_OF_YEAR);</span>
<span class="fc" id="L199">		double threshold = calcThreshold(weekOfYr);</span>
<span class="fc" id="L200">		double thresholdL = calcThreshold(weekOfYr-1);</span>
<span class="fc" id="L201">		double thresholdN = calcThreshold(weekOfYr+1); </span>
		
<span class="fc" id="L203">		DiagnosisStatisticsBean dbNow = diagnosesDAO.getCountForWeekOf(ICD_INFLUENZA, zip, cal.getTime());</span>
<span class="fc" id="L204">		cal.add(Calendar.HOUR, -12*7);</span>
<span class="fc" id="L205">		DiagnosisStatisticsBean dbLast = diagnosesDAO.getCountForWeekOf(ICD_INFLUENZA, zip, cal.getTime());</span>
<span class="fc" id="L206">		cal.add(Calendar.HOUR, 2*12*7);</span>
<span class="fc" id="L207">		DiagnosisStatisticsBean dbNext =  diagnosesDAO.getCountForWeekOf(ICD_INFLUENZA, zip, cal.getTime());</span>
		
<span class="fc" id="L209">		double weekNow = (double) dbNow.getRegionStats();</span>
<span class="fc" id="L210">		double weekL = (double) dbLast.getRegionStats();</span>
<span class="fc" id="L211">		double weekN = (double) dbNext.getRegionStats();</span>
		
<span class="pc bpc" id="L213" title="3 of 6 branches missed.">		return weekNow &gt; threshold &amp;&amp; (weekL &gt; thresholdL || weekN &gt; thresholdN);</span>
		
	}
	
	/**
	 * Calculates the threshold of an influenza epidemic
	 * 
	 * @param weekNumber the week of the year
	 * @return the epidemic threshold for flu cases
	 */
	private double calcThreshold(double weekNumber) {
<span class="fc" id="L224">		return 5.34 + 0.271 * weekNumber + 3.45 * Math.sin(2 * Math.PI * weekNumber / 52.0) + 8.41 * Math.cos(2 * Math.PI * weekNumber / 52.0);</span>
	}
	
	/**
	 * Determines whether a Malaria epidemic is happening
	 * 
	 * @param weekDate a date in the currently evaluated week
	 * @param zip the zip code to analyze
	 * @param thresholdStr the threshold for an epidemic
	 * @return whether or not there is an epidemic
	 * @throws DBException
	 * @throws ParseException
	 */
	public boolean isMalariaEpidemic(String weekDate, String zip, String thresholdStr) throws DBException, ParseException {
		
<span class="fc" id="L239">		Date wkDate = new SimpleDateFormat(&quot;MM/dd/yyyy&quot;).parse(weekDate);</span>
		
<span class="fc" id="L241">		ArrayList&lt;DiagnosisStatisticsBean&gt; dbList = new ArrayList&lt;DiagnosisStatisticsBean&gt;();</span>
<span class="fc" id="L242">		ArrayList&lt;DiagnosisStatisticsBean&gt; dbListL = new ArrayList&lt;DiagnosisStatisticsBean&gt;();</span>
<span class="fc" id="L243">		ArrayList&lt;DiagnosisStatisticsBean&gt; dbListN = new ArrayList&lt;DiagnosisStatisticsBean&gt;();</span>
<span class="fc" id="L244">		int threshold = Integer.parseInt(thresholdStr);</span>
<span class="fc" id="L245">		DiagnosisStatisticsBean current = diagnosesDAO.getCountForWeekOf(ICD_MALARIA, zip, wkDate);</span>
<span class="fc" id="L246">		long weekTotal = current.getRegionStats();</span>
		
<span class="fc" id="L248">		Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L249">		cal.setTime(wkDate);</span>
<span class="fc" id="L250">		cal.add(Calendar.HOUR, -7*24);</span>
<span class="fc" id="L251">		DiagnosisStatisticsBean last = diagnosesDAO.getCountForWeekOf(ICD_MALARIA, zip, cal.getTime());</span>
<span class="fc" id="L252">		long weekTotalL = last.getRegionStats();</span>
<span class="fc" id="L253">		cal.add(Calendar.HOUR, 2*7*24);</span>
<span class="fc" id="L254">		DiagnosisStatisticsBean next = diagnosesDAO.getCountForWeekOf(ICD_MALARIA, zip, cal.getTime());</span>
<span class="fc" id="L255">		long weekTotalN = next.getRegionStats();</span>
		
<span class="fc" id="L257">		cal.setTime(wkDate);</span>
<span class="fc" id="L258">		int weekOfYr = cal.get(Calendar.WEEK_OF_YEAR);</span>
		
		//Find earliest Malaria Case. Set calendar's year to that year
<span class="fc" id="L261">		Date startData = diagnosesDAO.findEarliestIncident(ICD_MALARIA);</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">		if (startData == null) {</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">			if (current.getRegionStats() &gt; 0) {</span>
<span class="nc" id="L264">				return true;</span>
			}
<span class="nc" id="L266">			return false;</span>
		}
<span class="fc" id="L268">		Calendar startDateCal = Calendar.getInstance();</span>
<span class="fc" id="L269">		startDateCal.setTime(startData);</span>
<span class="fc" id="L270">		Calendar wkDateCal = Calendar.getInstance();</span>
<span class="fc" id="L271">		wkDateCal.setTime(wkDate);</span>
<span class="fc" id="L272">		cal.set(Calendar.YEAR, startDateCal.get(Calendar.YEAR));</span>

<span class="pc bpc" id="L274" title="1 of 4 branches missed.">		while( cal.getTime().before(wkDate) &amp;&amp; cal.get(Calendar.YEAR) != wkDateCal.get(Calendar.YEAR)) {</span>
			
<span class="fc" id="L276">			dbList.add( diagnosesDAO.getCountForWeekOf(ICD_MALARIA, zip, cal.getTime()) );</span>
<span class="fc" id="L277">			cal.add(Calendar.HOUR, -7*24);</span>
<span class="fc" id="L278">			dbListL.add( diagnosesDAO.getCountForWeekOf(ICD_MALARIA, zip, cal.getTime()) );</span>
<span class="fc" id="L279">			cal.add(Calendar.HOUR, 2*7*24);</span>
<span class="fc" id="L280">			dbListN.add( diagnosesDAO.getCountForWeekOf(ICD_MALARIA, zip, cal.getTime()) );</span>
<span class="fc" id="L281">			cal.add(Calendar.YEAR, 1);</span>
<span class="fc" id="L282">			cal.set(Calendar.WEEK_OF_YEAR, weekOfYr);</span>
<span class="fc" id="L283">			cal.set(Calendar.DAY_OF_WEEK, Calendar.MONDAY);</span>
		}
		
<span class="fc" id="L286">		long total = 0;</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">		for (DiagnosisStatisticsBean d : dbList) {</span>
<span class="fc" id="L288">			total += d.getRegionStats();</span>
<span class="fc" id="L289">		}</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">		for (DiagnosisStatisticsBean d : dbListL) {</span>
<span class="fc" id="L291">			d.getRegionStats();</span>
<span class="fc" id="L292">		}</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">		for (DiagnosisStatisticsBean d : dbListN) {</span>
<span class="fc" id="L294">			d.getRegionStats();</span>
<span class="fc" id="L295">		}</span>
		
<span class="fc" id="L297">		long avg = 0;</span>
<span class="fc" id="L298">		long avgL = 0;</span>
<span class="fc" id="L299">		long avgN = 0;</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">		if (dbList.size() != 0) {</span>
<span class="fc" id="L301">			avg = total / dbList.size();</span>
<span class="fc" id="L302">			avgL = total/ dbListL.size();</span>
<span class="fc" id="L303">			avgN = total/ dbListN.size();</span>
		} 
			
<span class="pc bpc" id="L306" title="6 of 12 branches missed.">		return weekTotal != 0 &amp;&amp; (weekTotal*100/threshold) &gt; avg &amp;&amp; </span>
				(	( weekTotalL != 0 &amp;&amp; (weekTotalL*100/threshold) &gt; avgL ) || 
					( weekTotalN != 0 &amp;&amp; (weekTotalN*100/threshold) &gt; avgN ) );
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>