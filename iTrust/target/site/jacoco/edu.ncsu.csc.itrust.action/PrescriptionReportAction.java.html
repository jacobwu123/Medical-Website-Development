<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PrescriptionReportAction.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.action</a> &gt; <span class="el_source">PrescriptionReportAction.java</span></div><h1>PrescriptionReportAction.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.action;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import edu.ncsu.csc.itrust.ParameterUtil;
import edu.ncsu.csc.itrust.action.base.PatientBaseAction;
import edu.ncsu.csc.itrust.beans.OfficeVisitBean;
import edu.ncsu.csc.itrust.beans.PatientBean;
import edu.ncsu.csc.itrust.beans.PrescriptionReportBean;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.dao.mysql.OfficeVisitDAO;
import edu.ncsu.csc.itrust.dao.mysql.PatientDAO;
import edu.ncsu.csc.itrust.dao.mysql.PrescriptionReportDAO;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.exception.FormValidationException;
import edu.ncsu.csc.itrust.exception.NoHealthRecordsException;
import edu.ncsu.csc.itrust.exception.ITrustException;

/**
 * Handles Prescription Reports for the given pid Used by hcp-uap/getPrescriptionReport.jsp,
 * hcp-uap/viewPrescriptionRecord.jsp, patient/getMyPrescriptionReport.jsp, &amp;
 * patient/viewMyPrescriptionRecord.jsp
 * 
 * 
 */
public class PrescriptionReportAction extends PatientBaseAction {
<span class="fc" id="L29">	private boolean isRepresenting = false;</span>
	private OfficeVisitDAO ovDAO;
	private PrescriptionReportDAO prDAO;
	private PatientDAO patientDAO;
	private long loggedInMID;

	/**
	 * Super class validates pidString
	 * 
	 * @param factory The DAOFactory used to create the DAOs used in this action.
	 * @param loggedInMID The MID of the user who is making a prescription report.
	 * @param pidString The MID of the patient in question.
	 * @throws ITrustException
	 * @throws DBException
	 * @throws NoHealthRecordsException
	 */
	public PrescriptionReportAction(DAOFactory factory, long loggedInMID, String pidString)
			throws ITrustException, DBException, NoHealthRecordsException {
<span class="fc" id="L47">		super(factory, pidString);</span>
<span class="fc" id="L48">		this.ovDAO = factory.getOfficeVisitDAO();</span>
<span class="fc" id="L49">		this.patientDAO = factory.getPatientDAO();</span>
<span class="fc" id="L50">		this.prDAO = factory.getPrescriptionReportDAO();</span>
<span class="fc" id="L51">		this.loggedInMID = loggedInMID;</span>
<span class="fc" id="L52">	}</span>

	/**
	 * Takes the patient's representee as a param and returns it as a long if the patient represents the input
	 * param
	 * 
	 * @param input
	 *            the patient's representee mid
	 * @return representee's mid as a long
	 * @throws ITrustException
	 */
	public long representPatient(String input) throws ITrustException {
		try {
<span class="fc" id="L65">			long reppeeMID = Long.valueOf(input);</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">			if (patientDAO.represents(loggedInMID, reppeeMID)) {</span>
<span class="fc" id="L67">				loggedInMID = reppeeMID;</span>
<span class="fc" id="L68">				pid = reppeeMID;</span>
<span class="fc" id="L69">				isRepresenting = true;</span>
<span class="fc" id="L70">				return reppeeMID;</span>
			} else
<span class="nc" id="L72">				throw new ITrustException(&quot;You do not represent patient &quot; + reppeeMID);</span>
<span class="nc" id="L73">		} catch (NumberFormatException e) {</span>
<span class="nc" id="L74">			throw new ITrustException(&quot;MID is not a number&quot;);</span>
		}
	}

	/**
	 * Returns a list of all office visits for the pid
	 * 
	 * @return list of OfficeVisitBeans for the pid
	 * @throws DBException
	 */
	public List&lt;OfficeVisitBean&gt; getAllOfficeVisits() throws DBException {
<span class="fc" id="L85">		return ovDAO.getAllOfficeVisits(pid);</span>
	}

	/**
	 * Used by the JSP, passes a Map from the html form and a list of OfficeVisitBeans Returns a list of
	 * PrescriptionReportBeans
	 * 
	 * @param params A java.util.HashMap containing the parameter map.
	 * @param officeVisits A java.util.List of OfficeVisitBeans for the visits.
	 * @return list of PrescriptionReportBeans
	 * @throws DBException
	 */
	public List&lt;PrescriptionReportBean&gt; getPrescriptionReports(Map&lt;String, String&gt; params, List&lt;OfficeVisitBean&gt; officeVisits)
			throws DBException {
<span class="fc" id="L99">		HashMap&lt;String, String&gt; myParams = ParameterUtil.convertMap(params);</span>
<span class="fc" id="L100">		List&lt;Long&gt; ovIDs = new ArrayList&lt;Long&gt;();</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">		for (int i = 0; i &lt; officeVisits.size(); i++) {</span>
			try {
<span class="fc bfc" id="L103" title="All 2 branches covered.">				if (params.get(&quot;ovOff&quot; + i) != null) {</span>
<span class="fc" id="L104">					int offset = Integer.valueOf(myParams.get(&quot;ovOff&quot; + i));</span>
<span class="fc" id="L105">					ovIDs.add(officeVisits.get(offset).getVisitID());</span>
				}
<span class="nc" id="L107">			} catch (NumberFormatException e) {</span>
				// just skip it
<span class="fc" id="L109">			}</span>
		}
<span class="fc bfc" id="L111" title="All 2 branches covered.">		if (ovIDs.size() == 0)</span>
<span class="fc" id="L112">			return new ArrayList&lt;PrescriptionReportBean&gt;();</span>

<span class="fc" id="L114">		return prDAO.byOfficeVisitAndPatient(ovIDs, pid);</span>
	}

	/**
	 * Returns a PatientBean for the pid
	 * 
	 * @return PatientBean
	 * @throws DBException
	 */
	public PatientBean getPatient() throws DBException {
<span class="nc" id="L124">		return patientDAO.getPatient(pid);</span>
	}

	/**
	 * Used by the JSP, which passes the param map from the html form and a list of OfficeVisitBeans Returns a
	 * string that will be used to create a new url. The JSP will pull params from this url to create the
	 * prescription report.
	 * 
	 * @param paramMap A java.util.HashMap of the parameters.
	 * @param officeVisits A java.util.List of OfficeVisitBeans.
	 * @return the string that will be used in the new url
	 * @throws FormValidationException
	 * @throws DBException
	 */
	@SuppressWarnings(&quot;rawtypes&quot;)
	public String getQueryString(Map paramMap, List&lt;OfficeVisitBean&gt; officeVisits)
			throws FormValidationException, DBException {
<span class="fc" id="L141">		HashMap&lt;String, String&gt; myParams = ParameterUtil.convertMap(paramMap);</span>
<span class="fc" id="L142">		List&lt;Integer&gt; ovOffsets = checkOfficeVisits(myParams, officeVisits);</span>
<span class="fc" id="L143">		String queryString = buildQueryString(ovOffsets);</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">		if (isRepresenting)</span>
<span class="nc" id="L145">			queryString += &quot;&amp;rep=&quot; + pid;</span>
<span class="fc" id="L146">		return queryString;</span>
	}

	/**
	 * Checks office visits
	 * 
	 * @param myParams list of parameters
	 * @param officeVisits list of office visits
	 * @return Returns a java.util.ArrayList of Integers for the given office visits.
	 */
	private ArrayList&lt;Integer&gt; checkOfficeVisits(HashMap&lt;String, String&gt; myParams,
			List&lt;OfficeVisitBean&gt; officeVisits) {
<span class="fc" id="L158">		ArrayList&lt;Integer&gt; list = new ArrayList&lt;Integer&gt;();</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">		for (int i = 0; i &lt; officeVisits.size(); i++) {</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">			if (&quot;on&quot;.equals(myParams.get(&quot;ov&quot; + i)))</span>
<span class="fc" id="L161">				list.add(i);</span>
		}
<span class="fc" id="L163">		return list;</span>
	}

	/**
	 * Builds a query string for office visits
	 * 
	 * @param ovOffsets offsets for the office visits
	 * @return A SQL query in a Java String.
	 */
	private String buildQueryString(List&lt;Integer&gt; ovOffsets) {
<span class="fc" id="L173">		int n = ovOffsets.size();</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">		if (n == 0)</span>
<span class="fc" id="L175">			return &quot;&quot;;</span>
<span class="fc" id="L176">		String str = &quot;&amp;n=&quot; + n;</span>
<span class="fc" id="L177">		StringBuffer buf = new StringBuffer();</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">		for (int i = 0; i &lt; ovOffsets.size(); i++) {</span>
<span class="fc" id="L179">			buf.append(&quot;&amp;ovOff&quot; + i + &quot;=&quot; + ovOffsets.get(i));</span>
		}
<span class="fc" id="L181">		str += buf.toString();</span>
<span class="fc" id="L182">		return str;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>