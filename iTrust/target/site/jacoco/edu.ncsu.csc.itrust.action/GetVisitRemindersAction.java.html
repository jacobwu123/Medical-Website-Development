<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GetVisitRemindersAction.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.action</a> &gt; <span class="el_source">GetVisitRemindersAction.java</span></div><h1>GetVisitRemindersAction.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.action;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.List;
import java.util.Calendar;
import edu.ncsu.csc.itrust.beans.forms.VisitReminderReturnForm;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.dao.mysql.VisitRemindersDAO;
import edu.ncsu.csc.itrust.dao.mysql.PatientDAO;
import edu.ncsu.csc.itrust.beans.ProcedureBean;
import edu.ncsu.csc.itrust.exception.FormValidationException;
import edu.ncsu.csc.itrust.exception.ITrustException;
import edu.ncsu.csc.itrust.beans.VisitFlag;
import edu.ncsu.csc.itrust.beans.PatientBean;
import edu.ncsu.csc.itrust.enums.Gender;

/**
 * Gets the VisitReminders for a given patient Used by visitReminders.jsp
 * 
 * 
 */
public class GetVisitRemindersAction {

	private static final int WEEK_IN_MILLIS = 1000 * 60 * 60 * 24 * 7;

	/**
	 * Reminder Type enumeration.
	 */
<span class="pc" id="L32">	public static enum ReminderType {</span>
<span class="fc" id="L33">		DIAGNOSED_CARE_NEEDERS(&quot;Diagnosed Care Needers&quot;),</span>
<span class="fc" id="L34">		FLU_SHOT_NEEDERS(&quot;Flu Shot Needers&quot;),</span>
<span class="fc" id="L35">		IMMUNIZATION_NEEDERS(&quot;Immunization Needers&quot;);</span>

		private String typeName;

<span class="fc" id="L39">		private ReminderType(String typeName) {</span>
<span class="fc" id="L40">			this.typeName = typeName;</span>
<span class="fc" id="L41">		}</span>

<span class="fc" id="L43">		private static final Map&lt;String, ReminderType&gt; map = new HashMap&lt;String, ReminderType&gt;();</span>
		static {
<span class="fc bfc" id="L45" title="All 2 branches covered.">			for (ReminderType rt : ReminderType.values()) {</span>
<span class="fc" id="L46">				map.put(rt.getTypeName(), rt);</span>
			}
<span class="fc" id="L48">		}</span>

		/**
		 * Gets the ReminderType for the name passed as a param
		 * 
		 * @param name
		 * @return the ReminderType associated with the name
		 */
		public static ReminderType getReminderType(String name) {
<span class="fc" id="L57">			return map.get(name);</span>
		}

		/**
		 * Returns the type name as a string
		 * 
		 * @return
		 */
		public String getTypeName() {
<span class="fc" id="L66">			return typeName;</span>
		}
	}

	/**
	 * 
	 * Begin GetVisitRemindersAction code
	 * 
	 */
	private VisitRemindersDAO visitReminderDAO;
	private PatientDAO patientDAO;
	private long loggedInMID;

	/**
	 * Set up defaults
	 * 
	 * @param factory The DAOFactory used to create the DAOs used in this action.
	 * @param loggedInMID MID of the person who is logged in
	 * @throws ITrustException
	 */
<span class="fc" id="L86">	public GetVisitRemindersAction(DAOFactory factory, long loggedInMID) throws ITrustException {</span>
<span class="fc" id="L87">		this.loggedInMID = loggedInMID;</span>
<span class="fc" id="L88">		visitReminderDAO = factory.getVisitRemindersDAO();</span>
<span class="fc" id="L89">		patientDAO = factory.getPatientDAO();</span>
<span class="fc" id="L90">	}</span>

	/**
	 * Returns a list of VisitReminderReturnForms for the type passed in as a param
	 * 
	 * @param type
	 *            the ReminderType
	 * @return the list of VisitReminderReturnForms
	 * @throws ITrustException
	 * @throws FormValidationException
	 */
	public List&lt;VisitReminderReturnForm&gt; getVisitReminders(ReminderType type) throws ITrustException, FormValidationException {
		
<span class="fc bfc" id="L103" title="All 2 branches covered.">		if (null == type)</span>
<span class="fc" id="L104">			throw new ITrustException(&quot;Reminder Type DNE&quot;);</span>
		
<span class="pc bpc" id="L106" title="1 of 4 branches missed.">		switch (type) {</span>
			case DIAGNOSED_CARE_NEEDERS:
<span class="fc" id="L108">				return visitReminderDAO.getDiagnosedVisitNeeders(loggedInMID);</span>
				//return stripDupes(visitReminderDAO.getDiagnosedVisitNeeders(loggedInMID));

			case FLU_SHOT_NEEDERS:
<span class="fc" id="L112">				return visitReminderDAO.getFluShotDelinquents(loggedInMID);</span>
				
			case IMMUNIZATION_NEEDERS:
<span class="fc" id="L115">				return getImmunizationNeeders(loggedInMID);</span>
				
			default:
<span class="nc" id="L118">				throw new ITrustException(&quot;Reminder Type DNE&quot;);</span>
		}
	}
	
	/**
	 * Gets a list of anyone who need immunizations
	 * 
	 * @param mid the HCP whose patients are being checked
	 * @return a list of all the people who need immunizations--done in a visit reminder
	 * @throws ITrustException
	 */

	private List&lt;VisitReminderReturnForm&gt; getImmunizationNeeders(long mid) throws ITrustException {
		
		List&lt;VisitReminderReturnForm&gt; formList;
<span class="fc" id="L133">		List&lt;VisitReminderReturnForm&gt; needList = new ArrayList&lt;VisitReminderReturnForm&gt;();</span>
<span class="fc" id="L134">		String reason = &quot;&quot;;</span>
		// Get list of patients that designate this HCP
<span class="fc" id="L136">		formList = visitReminderDAO.getPatients(mid);</span>
		
<span class="fc bfc" id="L138" title="All 2 branches covered.">		for (VisitReminderReturnForm r : formList) {</span>
<span class="fc" id="L139">			reason = checkImmunizations(r.getPatientID());</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">			if (0 &lt; reason.length()) {</span>
<span class="fc" id="L141">				needList.add(r);</span>
<span class="fc" id="L142">				r.addVisitFlag(new VisitFlag(VisitFlag.IMMUNIZATION, reason));</span>
			}
<span class="fc" id="L144">		}	</span>
		
<span class="fc" id="L146">		return needList;</span>
	}
	
	

	/**
	 * Checks a patient to see what immunizations they need
	 * 
	 * @param pid patient to be checked
	 * @return patient list of those lacking immunizations according to the schedule
	 */
	private String checkImmunizations(long pid) throws ITrustException {
		
<span class="fc" id="L159">		String reason = &quot;&quot;;</span>
<span class="fc" id="L160">		List&lt;ProcedureBean&gt; procs = patientDAO.getProcedures(pid);</span>
<span class="fc" id="L161">		PatientBean patient = patientDAO.getPatient(pid);</span>

<span class="fc" id="L163">		Date patientDOB = patient.getDateOfBirth();</span>
<span class="fc" id="L164">		Gender gen = patient.getGender();</span>
		
<span class="fc" id="L166">		int hepB = 0;</span>
<span class="fc" id="L167">		long hepBTime = 0;</span>

<span class="fc" id="L169">		int rota = 0;</span>
<span class="fc" id="L170">		long rotaTime = 0;</span>

<span class="fc" id="L172">		int diptet = 0;</span>
<span class="fc" id="L173">		long deptetTime = 0;</span>
		
<span class="fc" id="L175">		int haemoflu = 0;</span>
<span class="fc" id="L176">		long haemofluTime = 0;</span>
<span class="fc" id="L177">		long haemofluTimeFirst = 0;</span>
		
<span class="fc" id="L179">		int pneumo = 0;</span>
<span class="fc" id="L180">		long pneumoTime = 0;</span>
<span class="fc" id="L181">		long pneumofluTimeFirst = 0;</span>
		
<span class="fc" id="L183">		int polio = 0;</span>
<span class="fc" id="L184">		long polioTime = 0;</span>
		
<span class="fc" id="L186">		int measles = 0;</span>
<span class="fc" id="L187">		long measlesTime = 0;</span>
		
<span class="fc" id="L189">		int varicella = 0;</span>
<span class="fc" id="L190">		long varicellaTime = 0;</span>
		
<span class="fc" id="L192">		int hepA = 0;</span>
<span class="fc" id="L193">		long hepATime = 0;</span>
		
<span class="fc" id="L195">		int hpv = 0;</span>
<span class="fc" id="L196">		long hpvTime = 0;</span>
		
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">		for (ProcedureBean proc: procs) {</span>
		
<span class="nc" id="L200">			String cpt = proc.getCPTCode();</span>
			
			// Hep B (90371)
<span class="nc bnc" id="L203" title="All 2 branches missed.">			if (cpt.equals(&quot;90371&quot;)) {</span>
<span class="nc" id="L204">				hepB++;</span>
<span class="nc" id="L205">				hepBTime = proc.getDate().getTime();</span>
			}
				
			// Rotavirus (90681)
<span class="nc bnc" id="L209" title="All 2 branches missed.">			else if (cpt.equals(&quot;90681&quot;)) {</span>
<span class="nc" id="L210">				rota++;</span>
<span class="nc" id="L211">				rotaTime = proc.getDate().getTime();</span>
			}
			
			// Diptheria, Tetanus, Pertussis (90696)
<span class="nc bnc" id="L215" title="All 2 branches missed.">			else if (cpt.equals(&quot;90696&quot;)) {</span>
<span class="nc" id="L216">				diptet++;</span>
<span class="nc" id="L217">				deptetTime = proc.getDate().getTime();</span>
			}
			
			// Haemophilus influenza (90645)
<span class="nc bnc" id="L221" title="All 2 branches missed.">			else if (cpt.equals(&quot;90645&quot;)) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">				if (0 == haemoflu)</span>
<span class="nc" id="L223">					haemofluTimeFirst = proc.getDate().getTime();</span>
				
<span class="nc" id="L225">				haemoflu++;</span>
<span class="nc" id="L226">				haemofluTime = proc.getDate().getTime();</span>
				
			}
			
			// Pneumococcal (90669)
<span class="nc bnc" id="L231" title="All 2 branches missed.">			else if (cpt.equals(&quot;90669&quot;)) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">				if (0 == pneumo)</span>
<span class="nc" id="L233">					pneumofluTimeFirst = proc.getDate().getTime();</span>
<span class="nc" id="L234">				pneumo++;</span>
<span class="nc" id="L235">				pneumoTime = proc.getDate().getTime();</span>
			}
			
			// Poliovirus (90712)
<span class="nc bnc" id="L239" title="All 2 branches missed.">			else if (cpt.equals(&quot;90712&quot;)) {</span>
<span class="nc" id="L240">				polio++;</span>
<span class="nc" id="L241">				polioTime = proc.getDate().getTime();</span>
			}
			
			// Measles, Mumps, Rubella (90707)
<span class="nc bnc" id="L245" title="All 2 branches missed.">			else if (cpt.equals(&quot;90707&quot;)) {</span>
<span class="nc" id="L246">				measles++;</span>
<span class="nc" id="L247">				measlesTime = proc.getDate().getTime();</span>
			}
			
			// Varicella (90396)
<span class="nc bnc" id="L251" title="All 2 branches missed.">			else if (cpt.equals(&quot;90396&quot;)) {</span>
<span class="nc" id="L252">				varicella++;</span>
<span class="nc" id="L253">				varicellaTime = proc.getDate().getTime();</span>
			}
			
			// Hep A (90633)
<span class="nc bnc" id="L257" title="All 2 branches missed.">			else if (cpt.equals(&quot;90633&quot;)) {</span>
<span class="nc" id="L258">				hepA++;</span>
<span class="nc" id="L259">				hepATime = proc.getDate().getTime();</span>
			}
			
			// Human Papillomaavirus (90649)
<span class="nc bnc" id="L263" title="All 2 branches missed.">			else if (cpt.equals(&quot;90649&quot;)) {</span>
<span class="nc" id="L264">				hpv++;</span>
<span class="nc" id="L265">				hpvTime = proc.getDate().getTime();</span>
			}
<span class="nc" id="L267">		}</span>
		
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">		if (3 &gt; hepB) {</span>
<span class="fc" id="L270">			reason += testHepB(hepB, patientDOB, hepBTime);</span>
		}
		
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">		if (3 &gt; rota) {</span>
<span class="fc" id="L274">			reason += testRotaVirus(rota, patientDOB, rotaTime);</span>
		}
		
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">		if (6 &gt; diptet) {</span>
<span class="fc" id="L278">			reason += testDipTet(diptet, patientDOB, deptetTime);</span>
		}
		
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">		if (3 &gt; haemoflu) {</span>
<span class="fc" id="L282">			reason += testHaemoFlu(haemoflu, patientDOB, haemofluTime, haemofluTimeFirst);</span>
		}
		
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">		if (4 &gt; pneumo) {</span>
<span class="fc" id="L286">			reason += testPneumo(pneumo, patientDOB, pneumoTime, pneumofluTimeFirst);</span>
		}
		
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">		if (3 &gt; polio) {</span>
<span class="fc" id="L290">			reason += testPolio(polio, patientDOB, polioTime);</span>
		}
		
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">		if (2 &gt; measles) {</span>
<span class="fc" id="L294">			reason += testMeasles(measles, patientDOB, measlesTime);</span>
		}
		
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">		if (2 &gt; varicella) {</span>
<span class="fc" id="L298">			reason += testVaricella(varicella, patientDOB, varicellaTime);</span>
		}
		
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">		if (2 &gt; hepA) {</span>
<span class="fc" id="L302">			reason += testHepA(hepA, patientDOB, hepATime);</span>
		}
		
<span class="pc bpc" id="L305" title="2 of 4 branches missed.">		if (3 &gt; hpv &amp;&amp; gen.getName().equals(&quot;Female&quot;)) {</span>
<span class="fc" id="L306">			reason += testHPV(hpv, patientDOB, hpvTime);</span>
		}
	
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">		if(reason.length() &gt; 2)</span>
<span class="fc" id="L310">			return reason.substring(0, reason.length() - 2);</span>
		
<span class="nc" id="L312">		return reason;</span>
	}
	
	
	/**
	 * Checks to see if a patient needs the HPV immunization
	 * 
	 * @param count			how many HPV immunizations she has already had
	 * @param patientAge	how old the patient is, in weeks
	 * @param time			date of the last procedure
	 * @return the			reason the immunization should be given, including required immunization age
	 */
	public static String testHPV(int count, Date patientDOB, long time) {
<span class="fc" id="L325">		String reason = &quot;&quot;;</span>
<span class="fc" id="L326">		long weeks = (Calendar.getInstance().getTimeInMillis() - time) / WEEK_IN_MILLIS;</span>
<span class="fc" id="L327">		new Date();</span>
		
		
		
		
		
<span class="fc bfc" id="L333" title="All 2 branches covered.">		if (0 == count) {</span>
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">			if (olderThan(patientDOB, 9, 0, 0))</span>
<span class="fc" id="L335">				reason += &quot;90649 Human Papillomavirus (9 years), &quot;;</span>
		}
<span class="fc bfc" id="L337" title="All 2 branches covered.">		else if (1 == count) {</span>
<span class="pc bpc" id="L338" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 9, 2, 0) &amp;&amp; 8 &lt;= weeks)</span>
<span class="fc" id="L339">				reason += &quot;90649 Human Papillomavirus (9 years, 2 months), &quot;;</span>
		}
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">		else if (2 == count) {</span>
<span class="pc bpc" id="L342" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 9, 6, 0) &amp;&amp; 16 &lt;= weeks)</span>
<span class="fc" id="L343">				reason += &quot;90649 Human Papillomavirus (9 years, 6 months), &quot;;</span>
		}
		
<span class="fc" id="L346">		return reason;</span>
	}
	
	/**
	 * Checks to see if a patient needs the Hepatits A immunization
	 * 
	 * @param count which immunization they are on
	 * @param patientAge how old the patient is
	 * @param time what the current date is
	 * @return when the immunization should be given
	 */
	public static String testHepA(int count, Date patientDOB, long time) {
<span class="fc" id="L358">		String reason = &quot;&quot;;</span>
<span class="fc" id="L359">		long weeks = (Calendar.getInstance().getTimeInMillis() - time) / WEEK_IN_MILLIS;</span>
		
<span class="fc bfc" id="L361" title="All 2 branches covered.">		if (0 == count) {</span>
<span class="pc bpc" id="L362" title="1 of 2 branches missed.">			if (olderThan(patientDOB, 1, 0, 0))</span>
<span class="fc" id="L363">				reason += &quot;90633 Hepatits A (12 months), &quot;;</span>
		}
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">		else if (1 == count) {</span>
<span class="pc bpc" id="L366" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 1, 6, 0) &amp;&amp; 26 &lt;= weeks)</span>
<span class="fc" id="L367">				reason += &quot;90633 Hepatits A (18 months), &quot;;</span>
		}
		
<span class="fc" id="L370">		return reason;	</span>
	}
	
	/**
	 * Checks to see if a patient needs the Varicella immunization
	 * 
	 * @param count which immunization they are on
	 * @param patientAge how old the patient is
	 * @param time what the current date is
	 * @return when the immunization should be given
	 */
	public static String testVaricella(int count, Date patientDOB, long time) {
<span class="fc" id="L382">		String reason = &quot;&quot;;</span>
<span class="fc" id="L383">		long weeks = (Calendar.getInstance().getTimeInMillis() - time) / WEEK_IN_MILLIS;</span>
		
<span class="fc bfc" id="L385" title="All 2 branches covered.">		if (0 == count) {</span>
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">			if (olderThan(patientDOB, 1, 0, 0))</span>
<span class="fc" id="L387">				reason += &quot;90396 Varicella (12 months), &quot;;</span>
		}
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">		else if (1 == count) {</span>
<span class="pc bpc" id="L390" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 4, 0, 0) &amp;&amp; 12 &lt;= weeks)</span>
<span class="fc" id="L391">				reason += &quot;90396 Varicella (4 years), &quot;;</span>
		}
		
<span class="fc" id="L394">		return reason;</span>
	}
	
	/**
	 * Checks to see if a patient needs the Measles, Mumps, and Rubekka immunization
	 * 
	 * @param count which immunization they are on
	 * @param patientAge how old the patient is
	 * @param time what the current date is
	 * @return when the immunization should be given
	 */
	public static String testMeasles(int count, Date patientDOB, long time) {
<span class="fc" id="L406">		String reason = &quot;&quot;;</span>
<span class="fc" id="L407">		long weeks = (Calendar.getInstance().getTimeInMillis() - time) / WEEK_IN_MILLIS;</span>
		
<span class="fc bfc" id="L409" title="All 2 branches covered.">		if (0 == count) {</span>
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">			if (olderThan(patientDOB, 1, 0, 0))</span>
<span class="fc" id="L411">				reason += &quot;90707 Measles, Mumps, Rubekka (12 months), &quot;;</span>
		}
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">		else if (1 == count) {</span>
<span class="pc bpc" id="L414" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 4, 0, 0) &amp;&amp; 12 &lt;= weeks)</span>
<span class="fc" id="L415">				reason += &quot;90707 Measles, Mumps, Rubekka (4 years), &quot;;</span>
		}
		
<span class="fc" id="L418">		return reason;</span>
	}
	
	/**
	 * Checks to see if a patient needs the Polio immunization
	 * 
	 * @param count which immunization they are on
	 * @param patientAge how old the patient is
	 * @param time what the current date is
	 * @return when the immunization should be given
	 */
	public static String testPolio(int count, Date patientDOB, long time) {
<span class="fc" id="L430">		String reason = &quot;&quot;;</span>
<span class="fc" id="L431">		long weeks = (Calendar.getInstance().getTimeInMillis() - time) / WEEK_IN_MILLIS;</span>
		
<span class="fc bfc" id="L433" title="All 2 branches covered.">		if (0 == count) {</span>
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">			if (olderThan(patientDOB, 0, 0, 6))</span>
<span class="fc" id="L435">				reason += &quot;90712 Poliovirus (6 weeks), &quot;;</span>
		}
<span class="fc bfc" id="L437" title="All 2 branches covered.">		else if (1 == count) {</span>
<span class="pc bpc" id="L438" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 0, 4, 0) &amp;&amp; 4 &lt;= weeks)</span>
<span class="fc" id="L439">				reason += &quot;90712 Poliovirus (4 months), &quot;;</span>
		}
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">		else if (2 == count) {</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">			if (olderThan(patientDOB, 0, 6, 0))</span>
<span class="fc" id="L443">				reason += &quot;90712 Poliovirus (6 months), &quot;;				</span>
		}
		
<span class="fc" id="L446">		return reason;	</span>
	}
	
	/**
	 * Checks to see if a patient needs the Pneumococcal immunization
	 * 
	 * @param count which immunization they are on
	 * @param time what the current date is
	 * @return when the immunization should be given
	 */
	public static String testPneumo(int count, Date patientDOB, long time, long firstDoseTime) {
<span class="fc" id="L457">		String reason = &quot;&quot;;</span>
<span class="fc" id="L458">		Date firstDose = new Date(firstDoseTime);</span>
<span class="fc" id="L459">		long weeks = (Calendar.getInstance().getTimeInMillis() - time) / WEEK_IN_MILLIS;</span>
		
<span class="fc bfc" id="L461" title="All 2 branches covered.">		if (0 == count) {</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">			if (olderThan(patientDOB, 0, 0, 6))</span>
<span class="fc" id="L463">				reason += &quot;90669 Pneumococcal (6 weeks), &quot;;</span>
		}
<span class="fc bfc" id="L465" title="All 2 branches covered.">		else if (1 == count) {</span>
<span class="pc bpc" id="L466" title="3 of 6 branches missed.">			if (olderThan(patientDOB, 0, 4, 0) &amp;&amp; !(firstDoseAfter(patientDOB, firstDose, 1, 0, 0)) &amp;&amp; 4 &lt;= weeks)</span>
<span class="fc" id="L467">				reason += &quot;90669 Pneumococcal (4 months), &quot;;</span>
<span class="nc bnc" id="L468" title="All 8 branches missed.">			else if (olderThan(patientDOB, 0, 4, 0) &amp;&amp; (firstDoseAfter(patientDOB, firstDose, 1, 0, 0)) &amp;&amp; !(firstDoseAfter(patientDOB, firstDose, 1, 2, 0)) &amp;&amp; 8 &lt;= weeks)</span>
<span class="nc" id="L469">				reason += &quot;90669 Pneumococcal (4 months), &quot;;</span>
		}
<span class="fc bfc" id="L471" title="All 2 branches covered.">		else if (2 == count) {</span>
<span class="pc bpc" id="L472" title="3 of 6 branches missed.">			if (olderThan(patientDOB, 0, 6, 0) &amp;&amp; 4 &lt;= weeks &amp;&amp; !(firstDoseAfter(patientDOB, firstDose, 1, 0, 0)))</span>
<span class="fc" id="L473">				reason += &quot;90669 Pneumococcal (6 months), &quot;;				</span>
		}
<span class="pc bpc" id="L475" title="1 of 2 branches missed.">		else if (3 == count) {</span>
<span class="pc bpc" id="L476" title="3 of 6 branches missed.">			if (olderThan(patientDOB, 1, 0, 0) &amp;&amp; 8 &lt;= weeks &amp;&amp; !(firstDoseAfter(patientDOB, firstDose, 1, 0, 0)))</span>
<span class="fc" id="L477">				reason += &quot;90669 Pneumococcal (12 months), &quot;;				</span>
		}
<span class="fc" id="L479">		return reason;</span>
	}
	
	/**
	 * Checks to see if a patient needs the Haemophilus Infulenzae immunization
	 * 
	 * @param count which immunization they are on
	 * @param time what the current date is
	 * @return when the immunization should be given
	 */
	public static String testHaemoFlu(int count, Date patientDOB, long time, long firstDoseTime) {
<span class="fc" id="L490">		String reason = &quot;&quot;;</span>
<span class="fc" id="L491">		long weeks = (Calendar.getInstance().getTimeInMillis() - time) / WEEK_IN_MILLIS;</span>
<span class="fc" id="L492">		Date firstDose = new Date(firstDoseTime);</span>
		
<span class="fc bfc" id="L494" title="All 2 branches covered.">		if (0 == count) {</span>
<span class="pc bpc" id="L495" title="1 of 2 branches missed.">			if (olderThan(patientDOB, 0, 0, 6))</span>
<span class="fc" id="L496">				reason += &quot;90645 Haemophilus influenzae (6 weeks), &quot;;</span>
		}
<span class="fc bfc" id="L498" title="All 2 branches covered.">		else if (1 == count) {</span>
<span class="pc bpc" id="L499" title="3 of 6 branches missed.">			if (olderThan(patientDOB, 0, 4, 0) &amp;&amp; !(firstDoseAfter(patientDOB, firstDose, 1, 0, 0)) &amp;&amp; 4 &lt;= weeks)</span>
<span class="fc" id="L500">				reason += &quot;90645 Haemophilus influenzae (4 months), &quot;;</span>
<span class="nc bnc" id="L501" title="All 8 branches missed.">			else if (olderThan(patientDOB, 0, 4, 0) &amp;&amp; firstDoseAfter(patientDOB, firstDose, 1, 0, 0) &amp;&amp; !(firstDoseAfter(patientDOB, firstDose, 1, 2, 0)) &amp;&amp; 8 &lt;= weeks)</span>
<span class="nc" id="L502">				reason += &quot;90645 Haemophilus influenzae (4 months), &quot;;</span>
		}
<span class="pc bpc" id="L504" title="1 of 2 branches missed.">		else if (2 == count) {</span>
<span class="pc bpc" id="L505" title="3 of 6 branches missed.">			if (olderThan(patientDOB, 0, 6, 0) &amp;&amp; 4 &lt;= weeks &amp;&amp; !(firstDoseAfter(patientDOB, firstDose, 1, 0, 0)))</span>
<span class="fc" id="L506">				reason += &quot;90645 Haemophilus influenzae (6 months), &quot;;</span>
		}
		
<span class="fc" id="L509">		return reason;</span>
	}
	
	/**
	 * Checks to see if a patient needs the Diphtheria, Tetanus, Pertussis immunization
	 * 
	 * @param count which immunization they are on
	 * @param time what the current date is
	 * @return when the immunization should be given
	 */
	public static String testDipTet(int count, Date patientDOB, long time) {
<span class="fc" id="L520">		String reason = &quot;&quot;;</span>
<span class="fc" id="L521">		long weeks = (Calendar.getInstance().getTimeInMillis() - time) / WEEK_IN_MILLIS;</span>
		
<span class="fc bfc" id="L523" title="All 2 branches covered.">		if (0 == count) {</span>
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">			if (olderThan(patientDOB, 0, 0, 6))</span>
<span class="fc" id="L525">				reason += &quot;90696 Diphtheria, Tetanus, Pertussis (6 weeks), &quot;;</span>
		}
<span class="fc bfc" id="L527" title="All 2 branches covered.">		else if (1 == count) {</span>
<span class="pc bpc" id="L528" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 0, 4, 0) &amp;&amp; 4 &lt;= weeks )</span>
<span class="fc" id="L529">				reason += &quot;90696 Diphtheria, Tetanus, Pertussis (4 months), &quot;;</span>
		}
<span class="fc bfc" id="L531" title="All 2 branches covered.">		else if (2 == count) {</span>
<span class="pc bpc" id="L532" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 0, 6, 0) &amp;&amp; 4 &lt;= weeks)</span>
<span class="fc" id="L533">				reason += &quot;90696 Diphtheria, Tetanus, Pertussis (6 months), &quot;;				</span>
		}
<span class="fc bfc" id="L535" title="All 2 branches covered.">		else if (3 == count) {</span>
<span class="pc bpc" id="L536" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 0, 0, 15) &amp;&amp; 26 &lt;= weeks)</span>
<span class="fc" id="L537">				reason += &quot;90696 Diphtheria, Tetanus, Pertussis (15 weeks), &quot;;</span>
		}
<span class="fc bfc" id="L539" title="All 2 branches covered.">		else if (4 == count) {</span>
<span class="pc bpc" id="L540" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 4, 0, 0) &amp;&amp; 26 &lt;= weeks)</span>
<span class="fc" id="L541">				reason += &quot;90696 Diphtheria, Tetanus, Pertussis (4 years), &quot;;</span>
		}
<span class="pc bpc" id="L543" title="1 of 2 branches missed.">		else if (5 == count) {</span>
<span class="pc bpc" id="L544" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 11, 0, 0) &amp;&amp; 260 &lt;= weeks)</span>
<span class="fc" id="L545">				reason += &quot;90696 Diphtheria, Tetanus, Pertussis (11 years), &quot;;				</span>
		}
		
<span class="fc" id="L548">		return reason;</span>
	}
	
	/**
	 * Checks to see if a patient needs the Rotavirus immunization
	 * 
	 * @param count which immunization they are on
	 * @param time what the current date is
	 * @return when the immunization should be given
	 */
	
	public static String testRotaVirus(int count, Date patientDOB, long time) {
<span class="fc" id="L560">		String reason = &quot;&quot;;</span>
<span class="fc" id="L561">		long weeks = (Calendar.getInstance().getTimeInMillis() - time) / WEEK_IN_MILLIS;</span>
		
<span class="fc bfc" id="L563" title="All 2 branches covered.">		if (0 == count) {</span>
<span class="pc bpc" id="L564" title="1 of 2 branches missed.">			if (olderThan(patientDOB, 0, 0, 6))</span>
<span class="fc" id="L565">				reason += &quot;90681 Rotavirus (6 weeks), &quot;;</span>
		}
<span class="fc bfc" id="L567" title="All 2 branches covered.">		else if (1 == count) {</span>
<span class="pc bpc" id="L568" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 0, 4, 0) &amp;&amp; 4 &lt;= weeks)</span>
<span class="fc" id="L569">				reason += &quot;90681 Rotavirus (4 months), &quot;;</span>
		}
<span class="pc bpc" id="L571" title="1 of 2 branches missed.">		else if (2 == count) {</span>
<span class="pc bpc" id="L572" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 0, 6, 0) &amp;&amp; 4 &lt;= weeks )</span>
<span class="fc" id="L573">				reason += &quot;90681 Rotavirus (6 months), &quot;;				</span>
		}
		
<span class="fc" id="L576">		return reason;</span>
	}

	
	/**
	 * Checks to see if a patient needs the Hepatitis B immunization
	 * 
	 * @param count which immunization they are on
	 * @param time what the current date is
	 * @return when the immunization should be given
	 */
	public static String testHepB(int count, Date patientDOB, long time) {
<span class="fc" id="L588">		String reason = &quot;&quot;;</span>
<span class="fc" id="L589">		long weeks = (Calendar.getInstance().getTimeInMillis() - time) / WEEK_IN_MILLIS;</span>
		
<span class="fc bfc" id="L591" title="All 2 branches covered.">		if (0 == count) {</span>
<span class="pc bpc" id="L592" title="1 of 2 branches missed.">			if (olderThan(patientDOB, 0, 0, 0))</span>
<span class="fc" id="L593">				reason += &quot;90371 Hepatitis B (birth), &quot;;</span>
		}
<span class="fc bfc" id="L595" title="All 2 branches covered.">		else if (1 == count) {</span>
<span class="pc bpc" id="L596" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 0, 1, 0) &amp;&amp; 4 &lt;= weeks)</span>
<span class="fc" id="L597">				reason += &quot;90371 Hepatitis B (1 month), &quot;;</span>
		}
<span class="pc bpc" id="L599" title="1 of 2 branches missed.">		else if (2 == count) {</span>
<span class="pc bpc" id="L600" title="2 of 4 branches missed.">			if (olderThan(patientDOB, 0, 6, 0) &amp;&amp; 8 &lt;= weeks)</span>
<span class="fc" id="L601">				reason += &quot;90371 Hepatitis B (6 months), &quot;;				</span>
		}
		
<span class="fc" id="L604">		return reason;</span>
	}
	
	private static boolean olderThan(Date patientDOB, int years, int months, int weeks) {
<span class="fc" id="L608">		return endBefore(patientDOB, new Date(), years, months, weeks);</span>
	}
	
	private static boolean firstDoseAfter(Date patientDOB, Date ageFirst, int years, int months, int weeks) {
<span class="fc" id="L612">		return endBefore(patientDOB, ageFirst, years, months, weeks);</span>
	}
	
	private static boolean endBefore(Date startTime, Date endTime, int years, int months, int weeks) {
<span class="fc" id="L616">		Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L617">		cal.setTime(startTime);</span>
<span class="fc" id="L618">		cal.add(Calendar.YEAR, years);</span>
<span class="fc" id="L619">		cal.add(Calendar.MONTH, months);</span>
<span class="fc" id="L620">		cal.add(Calendar.HOUR, weeks*7*24);</span>
		
<span class="fc bfc" id="L622" title="All 2 branches covered.">		return (cal.getTime().compareTo(endTime) &lt;= 0); </span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>