<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EmergencyReportAction.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.action</a> &gt; <span class="el_source">EmergencyReportAction.java</span></div><h1>EmergencyReportAction.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.action;

import java.util.ArrayList;
import java.util.List;
import java.util.Calendar;
import edu.ncsu.csc.itrust.action.base.PatientBaseAction;
import edu.ncsu.csc.itrust.beans.AllergyBean;
import edu.ncsu.csc.itrust.beans.DiagnosisBean;
import edu.ncsu.csc.itrust.beans.Email;
import edu.ncsu.csc.itrust.beans.PatientBean;
import edu.ncsu.csc.itrust.beans.PrescriptionBean;
import edu.ncsu.csc.itrust.beans.OfficeVisitBean;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.dao.mysql.AllergyDAO;
import edu.ncsu.csc.itrust.dao.mysql.PatientDAO;
import edu.ncsu.csc.itrust.dao.mysql.OfficeVisitDAO;
import edu.ncsu.csc.itrust.enums.PrescriptionAlerts;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.exception.ITrustException;
import edu.ncsu.csc.itrust.EmailUtil;
import edu.ncsu.csc.itrust.beans.ProcedureBean;

/**
 * Creates a new Emergency Report Used by emergencyReport.jsp
 * 
 * 
 */
public class EmergencyReportAction extends PatientBaseAction {
	private PatientDAO patientDAO;
	private AllergyDAO allergyDAO;
	private OfficeVisitDAO ovDAO;
	private PatientBean pb;
	private EmailUtil emailutil;
	/**
	 * The super class handles validating the pid Logs viewing of the report
	 * 
	 * @param factory The DAOFactory used in creating the DAOs for this action.
	 * @param loggedInMID The MID of the user who is looking at the emergency report.
	 * @param pidString The ID of the patient whose report is being generated.
	 * @throws ITrustException
	 */
	public EmergencyReportAction(DAOFactory factory, long loggedInMID, String pidString) throws ITrustException {
<span class="fc" id="L43">		super(factory, pidString);</span>
<span class="fc" id="L44">		this.patientDAO = factory.getPatientDAO();</span>
<span class="fc" id="L45">		this.allergyDAO = factory.getAllergyDAO();</span>
<span class="fc" id="L46">		this.ovDAO = factory.getOfficeVisitDAO();</span>
<span class="fc" id="L47">		emailutil = new EmailUtil(factory);</span>
		
<span class="fc" id="L49">		pb = patientDAO.getPatient(this.pid);</span>
<span class="fc" id="L50">		emailutil.sendEmail(makeEmail());</span>
<span class="fc" id="L51">	}</span>

	/**
	 * Returns the patient's name
	 * 
	 * @return patient's full name
	 */
	public String getPatientName() {
<span class="fc" id="L59">		return (pb.getFirstName() + &quot; &quot; + pb.getLastName());</span>
	}

	/**
	 * Returns the patient's age
	 * 
	 * @return patient's age
	 */
	public String getPatientAge() {
<span class="nc" id="L68">		return Integer.toString(pb.getAge());</span>
	}
	
	/**
	 * Returns the patient's gender
	 * 
	 * @return patient's gender
	 */
	public String getPatientGender() {
<span class="nc" id="L77">		return pb.getGender().toString();</span>
	}
	
	/**
	 * Returns the patient's emergency contact
	 * 
	 * @return patient's emergency contact
	 */
	public String getPatientEmergencyContact() {
<span class="nc" id="L86">		return pb.getEmergencyName() + &quot; &quot; + pb.getEmergencyPhone();</span>
	}
	
	/**
	 * Returns the patient's blood type
	 * 
	 * @return the patient's blood type
	 */
	public String getBloodType() {
<span class="fc" id="L95">		return pb.getBloodType() + &quot;&quot;;</span>
	}

	/**
	 * Returns a list of allergies for the given patient
	 * 
	 * @return a list of AllergyBeans
	 * @throws ITrustException
	 */
	public List&lt;AllergyBean&gt; getAllergies() throws ITrustException {
<span class="fc" id="L105">		return allergyDAO.getAllergies(this.pid);</span>
	}

	/**
	 * Returns a list of prescriptions the patient is currently taking
	 * 
	 * @return a list of PrescriptionBeans for which the patient is currently taking
	 * @throws ITrustException
	 */
	public List&lt;PrescriptionBean&gt; getCurrentPrescriptions() throws ITrustException {
<span class="fc" id="L115">		List&lt;PrescriptionBean&gt; allPrescriptions = patientDAO.getCurrentPrescriptions(this.pid);</span>
<span class="fc" id="L116">		ArrayList&lt;PrescriptionBean&gt; warningList = new ArrayList&lt;PrescriptionBean&gt;();</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">		for (int i = 0; i &lt; allPrescriptions.size(); i++) {</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">			if (PrescriptionAlerts.isAlert(allPrescriptions.get(i).getMedication().getNDCode()))</span>
<span class="fc" id="L119">				warningList.add(allPrescriptions.get(i));</span>
		}
<span class="fc" id="L121">		return warningList;</span>
	}

	/**
	 * Returns a list of diagnoses that are in the range indicated by the DiagnosisRange enum
	 * 
	 * @return list of DiagnosisBeans
	 * @throws ITrustException
	 */
	public List&lt;DiagnosisBean&gt; getWarningDiagnoses() throws ITrustException {
		try {
<span class="fc" id="L132">			boolean dup = false;</span>
<span class="fc" id="L133">			List&lt;DiagnosisBean&gt; allDiagnoses = patientDAO.getDiagnoses(this.pid);</span>
<span class="fc" id="L134">			ArrayList&lt;DiagnosisBean&gt; warningList = new ArrayList&lt;DiagnosisBean&gt;();</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">			for (DiagnosisBean bean: allDiagnoses) {</span>
<span class="fc" id="L136">				OfficeVisitBean ovb = ovDAO.getOfficeVisit(bean.getVisitID());</span>

<span class="pc bpc" id="L138" title="1 of 2 branches missed.">				if(ovb == null){</span>
<span class="nc" id="L139">					continue;</span>
					
				}
<span class="pc bpc" id="L142" title="1 of 4 branches missed.">				if (&quot;yes&quot;.equals(bean.getClassification()) || (ovb.getVisitDate().getTime() &gt; Calendar.getInstance().getTimeInMillis() - 30 * 24 * 60 * 60 * 1000))  {</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">					for (DiagnosisBean wbean: warningList) {</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">						if (bean.getDescription().equals(wbean.getDescription())) {</span>
<span class="fc" id="L145">							dup = true;</span>
						}
<span class="fc" id="L147">					}</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">					if (!dup) {</span>
<span class="fc" id="L149">						warningList.add(bean);</span>
					}
				}
<span class="fc" id="L152">			}</span>
<span class="fc" id="L153">			return warningList;</span>
<span class="nc" id="L154">		} catch (DBException dbe) {</span>
<span class="nc" id="L155">			throw new ITrustException(dbe.getMessage());</span>
		}
	}

	/**
	 * Returns a list of prescriptions the patient is currently taking
	 * 
	 * @return a list of PrescriptionBeans for which the patient is currently taking
	 * @throws ITrustException
	 */
	public List&lt;ProcedureBean&gt; getImmunizations() throws ITrustException {
<span class="nc" id="L166">		List&lt;ProcedureBean&gt; allImmunizations = patientDAO.getImmunizationProcedures(this.pid);</span>
<span class="nc" id="L167">		return allImmunizations;</span>
	}
	
	/**
	 * Creates a fake e-mail to notify the user that an emergency report has been created and viewed.
	 * 
	 * @return the e-mail to be sent
	 * @throws DBException
	 */
	private Email makeEmail() throws DBException{

<span class="fc" id="L178">		Email email = new Email();</span>
<span class="fc" id="L179">		List&lt;PatientBean&gt; reps = patientDAO.getRepresenting(pb.getMID());</span>
		
<span class="fc" id="L181">		List&lt;String&gt; toAddrs = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L182">		toAddrs.add(pb.getEmail());</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">		for (PatientBean r: reps) {</span>
<span class="nc" id="L184">			toAddrs.add(r.getEmail());</span>
<span class="nc" id="L185">		}</span>
		
<span class="fc" id="L187">		email.setFrom(&quot;no-reply@itrust.com&quot;);</span>
<span class="fc" id="L188">    	email.setToList(toAddrs); // patient and personal representative</span>
<span class="fc" id="L189">    	email.setSubject(String.format(&quot;Emergency Report Viewed Notification&quot;));</span>
<span class="fc" id="L190">    	email.setBody(&quot;Dear &quot; + pb.getFullName() + &quot;,\n An emergency report has been generated. &quot; + </span>
    			&quot;Please login to iTrust to see who has viewed your records.&quot;);
<span class="fc" id="L192">		return email;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>