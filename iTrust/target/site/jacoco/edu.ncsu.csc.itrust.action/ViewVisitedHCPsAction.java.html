<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ViewVisitedHCPsAction.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">iTrust</a> &gt; <a href="index.source.html" class="el_package">edu.ncsu.csc.itrust.action</a> &gt; <span class="el_source">ViewVisitedHCPsAction.java</span></div><h1>ViewVisitedHCPsAction.java</h1><pre class="source lang-java linenums">package edu.ncsu.csc.itrust.action;

import java.util.Date;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.ArrayList;
import edu.ncsu.csc.itrust.beans.PersonnelBean;
import edu.ncsu.csc.itrust.beans.OfficeVisitBean;
import edu.ncsu.csc.itrust.beans.HCPVisitBean;
import edu.ncsu.csc.itrust.dao.DAOFactory;
import edu.ncsu.csc.itrust.dao.mysql.PatientDAO;
import edu.ncsu.csc.itrust.dao.mysql.PersonnelDAO;
import edu.ncsu.csc.itrust.dao.mysql.OfficeVisitDAO;
import edu.ncsu.csc.itrust.exception.DBException;
import edu.ncsu.csc.itrust.exception.ITrustException;

/**
 * Action class for ViewVisitedHCPs.jsp
 */
public class ViewVisitedHCPsAction {

	private long patientMID;
	private PersonnelDAO docDAO;
	private OfficeVisitDAO visitDAO;
	private PatientDAO patientDAO;
	//private ArrayList&lt;HCPVisitBean&gt; visits;
	private DeclareHCPAction declareAction; 
	/**
	 * Set up defaults 
	 * @param factory The DAOFactory used to create the DAOs used in this action.
	 * @param loggedInMID The MID of the person viewing the visited HCPs.
	 */
<span class="fc" id="L33">	public ViewVisitedHCPsAction(DAOFactory factory, long loggedInMID) {</span>
<span class="fc" id="L34">		patientMID = loggedInMID;</span>
<span class="fc" id="L35">		docDAO = factory.getPersonnelDAO();</span>
<span class="fc" id="L36">		visitDAO = factory.getOfficeVisitDAO();</span>
<span class="fc" id="L37">		patientDAO = factory.getPatientDAO();</span>
		
<span class="fc" id="L39">		declareAction = new DeclareHCPAction(factory, loggedInMID);</span>
<span class="fc" id="L40">	}</span>
	
	/**
	 * Create an HCPVisitBean from a given PersonnelBean and office visit date.
	 * 
	 * @param pb The PersonnelBean that will be visited.
	 * @param visitDate The date of the visit.  This may be the empty string.
	 * @return The new HCPVisitBean. 
	 * @throws DBException
	 */
	private HCPVisitBean makeHCPVisitBean(PersonnelBean pb, String visitDate) throws DBException {
<span class="fc" id="L51">		long hcpid = pb.getMID();</span>
<span class="fc" id="L52">		HCPVisitBean visitBean = new HCPVisitBean();</span>
<span class="fc" id="L53">		visitBean.setHCPMID(hcpid);</span>
<span class="fc" id="L54">		visitBean.setHCPName(pb.getFullName());</span>
<span class="fc" id="L55">		visitBean.setOVDate(visitDate);</span>
<span class="fc" id="L56">		visitBean.setHCPSpecialty(pb.getSpecialty());</span>
<span class="fc" id="L57">		visitBean.setHCPAddr(pb.getStreetAddress1() +&quot; &quot;+ pb.getStreetAddress2() +&quot; &quot;</span>
<span class="fc" id="L58">						   + pb.getCity() +&quot;, &quot;+ pb.getState() +&quot; &quot;+ pb.getZip());</span>
<span class="fc" id="L59">		visitBean.setDesignated(patientDAO.checkDeclaredHCP(patientMID, hcpid));</span>
<span class="fc" id="L60">		return visitBean;</span>
	}
	
	/**
	 * Checks to see if a PersonnelBean matches against a given set of 
	 * criteria.
	 * 
	 * @param pb The PersonnelBean to check.
	 * @param lastName The last name to check against.  May be null or the empty string to ignore.
	 * @param specialty The specialty to check against.  May be null or the empty string to ignore.
	 * @param zip The zip code to check against.  May be null or the empty string to ignore.
	 * @return true if the PersonnelBean matches all the given parameters, or false otherwise.
	 */
	private boolean matchPersonnel(PersonnelBean pb, String lastName, String specialty, String zip) {
<span class="fc bfc" id="L74" title="All 6 branches covered.">		if (lastName != null &amp;&amp; !lastName.equals(&quot;&quot;) &amp;&amp; !pb.getLastName().startsWith(lastName)){</span>
<span class="fc" id="L75">			return false;</span>
		}
<span class="fc bfc" id="L77" title="All 6 branches covered.">		if (specialty != null &amp;&amp; !specialty.equals(&quot;&quot;) &amp;&amp; !specialty.equals(pb.getSpecialty())){</span>
<span class="fc" id="L78">			return false;</span>
		}
<span class="fc bfc" id="L80" title="All 6 branches covered.">		if (zip != null &amp;&amp; !zip.equals(&quot;&quot;) &amp;&amp; !zip.equals(pb.getZip())){</span>
<span class="fc" id="L81">			return false;</span>
		}
<span class="fc" id="L83">		return true;</span>
	}
	
	/**
	 * Get a list of all HCPs visited and/or designated by by the current 
	 * user.  The list can optionally be filtered by the doctor's last name, 
	 * specialty, or zip code.
	 * 
	 * @param lastName The last name (or a part of it) of the doctor to search 
	 * 				   for, or null or an empty string to accept all doctors.
	 * @param specialty The specialty of the doctor to search for, or null or 
	 * 					an empty string to accept all doctors.
	 * @param zip The zip code of the doctor to search for, or null or an empty 
	 * 			  string to accept all doctors.
	 * @return A list of HCPVisitBeans where each represents one HCP that has 
	 * 	       been visited or has been designated.
	 * @throws ITrustException
	 */
	private List&lt;HCPVisitBean&gt; getAllVisitedHCPs(String lastName, String specialty, String zip) 
										     throws ITrustException 
	{
		// Visited HCPs in this case includes both HCPs visited *and* HCPs 
		// designated by the patient.  These two groups are retrieved in 
		// different ways, then combined.
<span class="fc" id="L107">		List&lt;HCPVisitBean&gt; visits = new ArrayList&lt;HCPVisitBean&gt;();</span>
		try {
<span class="fc" id="L109">			List&lt;OfficeVisitBean&gt; ovlist = visitDAO.getAllOfficeVisits(patientMID);</span>
			// get most recent office visit for each provider
<span class="fc" id="L111">			LinkedHashMap&lt;Long, OfficeVisitBean&gt; mostRecentVisits = new LinkedHashMap&lt;Long, OfficeVisitBean&gt;();</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">			for (OfficeVisitBean ov: ovlist) {</span>
<span class="fc" id="L113">				long id = ov.getHcpID();</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">				if (!mostRecentVisits.containsKey(id)) {</span>
<span class="fc" id="L115">					mostRecentVisits.put(id, ov);</span>
				} else {
<span class="fc" id="L117">					OfficeVisitBean old = mostRecentVisits.get(id);</span>
<span class="fc" id="L118">					Date ovDate = ov.getVisitDate();</span>
<span class="fc" id="L119">					Date oldDate = old.getVisitDate();</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">					if (oldDate.before(ovDate)) {</span>
<span class="nc" id="L121">						mostRecentVisits.put(id, ov);</span>
					}
				}
<span class="fc" id="L124">			}</span>
			
			// Get visited HCPs.
<span class="fc bfc" id="L127" title="All 2 branches covered.">			for (OfficeVisitBean ov: mostRecentVisits.values()) {</span>
<span class="fc" id="L128">				long hcpid = ov.getHcpID();</span>
<span class="fc" id="L129">				PersonnelBean pb = docDAO.getPersonnel(hcpid);</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">				if (matchPersonnel(pb, lastName, specialty, zip)) {</span>
<span class="fc" id="L131">					HCPVisitBean visitBean = makeHCPVisitBean(pb, mostRecentVisits.get(hcpid).getVisitDateStr());</span>
<span class="fc" id="L132">					visits.add(visitBean);</span>
				}
<span class="fc" id="L134">			}</span>
			
			// Get all designated HCPs.  Because a designated HCP may have been 
			// visited, we will ensure the HCP is not already in the list.
<span class="fc" id="L138">			List&lt;PersonnelBean&gt; dhcps = patientDAO.getDeclaredHCPs(patientMID);</span>
		next:
<span class="fc bfc" id="L140" title="All 2 branches covered.">			for (PersonnelBean pb: dhcps) {</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">				if (matchPersonnel(pb, lastName, specialty, zip)) {</span>
<span class="fc" id="L142">					long hcpid = pb.getMID();</span>
					// if HCP is already in visits list, skip here
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">					for (HCPVisitBean hv: visits) {</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">						if (hv.getHCPMID() == hcpid) {</span>
<span class="fc" id="L146">							continue next;</span>
						}
<span class="fc" id="L148">					}</span>
<span class="nc" id="L149">					String date = &quot;&quot;;</span>
<span class="nc" id="L150">					HCPVisitBean visitBean = makeHCPVisitBean(pb, date);</span>
<span class="nc" id="L151">					visits.add(visitBean);</span>
				}
<span class="fc" id="L153">			}</span>
<span class="nc" id="L154">		} catch (DBException dbe) {</span>
<span class="nc" id="L155">			throw new ITrustException(dbe.getMessage());</span>
<span class="fc" id="L156">		}</span>
		
<span class="fc" id="L158">		return visits;</span>
	}
	
	/**
	 * Returns a list of all the visited and/or designated HCPs.
	 * @return list of all the visited HCPs
	 */
	public List&lt;HCPVisitBean&gt; getVisitedHCPs() {
		List&lt;HCPVisitBean&gt; visits;
		try {
<span class="fc" id="L168">			visits = getAllVisitedHCPs(null, null, null);</span>
		}
<span class="nc" id="L170">		catch (ITrustException ie) {</span>
<span class="nc" id="L171">			visits = new ArrayList&lt;HCPVisitBean&gt;();</span>
<span class="fc" id="L172">		}</span>
			
<span class="fc" id="L174">		return visits;</span>
	}
	
	
	/**
	 * Given an HCP's name, return the corresponding HCPVisitBean.
	 * @param name name
	 * @return r
	 */
	public HCPVisitBean getNamedHCP(String name) {
<span class="fc" id="L184">		HCPVisitBean r = new HCPVisitBean();</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">		for (HCPVisitBean bean : getVisitedHCPs()) {</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">			if (name.equals(bean.getHCPName())) {</span>
<span class="fc" id="L187">				r = bean;</span>
<span class="fc" id="L188">				break;</span>
			}
<span class="fc" id="L190">		}</span>
<span class="fc" id="L191">		return r;</span>
	}
	
	/**
	 * Set a given HCP as undeclared.
	 * 
	 * @param name HCP to undeclare.
	 * @return An empty string.
	 * @throws ITrustException
	 */
	public String undeclareHCP(String name) throws ITrustException {
		
<span class="fc bfc" id="L203" title="All 2 branches covered.">		for (HCPVisitBean visit: getVisitedHCPs()) {</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">			if (0 == visit.getHCPName().toLowerCase().compareTo(name.toLowerCase())) {</span>
<span class="fc" id="L205">				Long mid = Long.valueOf(visit.getHCPMID());</span>

<span class="fc" id="L207">				declareAction.undeclareHCP(mid.toString());</span>
<span class="fc" id="L208">				visit.setDesignated(false);</span>
			}
<span class="fc" id="L210">		}</span>
		
<span class="fc" id="L212">		return &quot;&quot;;</span>
	}
	
	/**
	 * Set a given HCP as declared
	 * 
	 * @param name HCP to declare
	 * @return An empty string.
	 * @throws ITrustException
	 */
	public String declareHCP(String name) throws ITrustException {
<span class="fc" id="L223">		boolean match = false;</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">		for (HCPVisitBean visit: getVisitedHCPs()) {</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">			if (0 == visit.getHCPName().toLowerCase().compareTo(name.toLowerCase())) {</span>
<span class="fc" id="L226">				match = true;</span>
<span class="fc" id="L227">				Long mid = Long.valueOf(visit.getHCPMID());</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">				if (!patientDAO.checkDeclaredHCP(patientMID, visit.getHCPMID())) {</span>
<span class="fc" id="L229">					declareAction.declareHCP(mid.toString());</span>
				}
<span class="fc" id="L231">				visit.setDesignated(true);</span>
			}
<span class="fc" id="L233">		}</span>
		
<span class="fc bfc" id="L235" title="All 2 branches covered.">		if (!match) {</span>
<span class="fc" id="L236">				List&lt;PersonnelBean&gt; doclist = docDAO.getAllPersonnel();</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">				for (PersonnelBean ele: doclist) {</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">					if (0 == name.compareTo(ele.getFullName())) {</span>
						HCPVisitBean visitBean;
<span class="fc" id="L240">						visitBean = new HCPVisitBean();</span>
<span class="fc" id="L241">						visitBean.setHCPMID(ele.getMID());</span>
<span class="fc" id="L242">						visitBean.setHCPName(ele.getFullName());</span>
<span class="fc" id="L243">						visitBean.setOVDate(&quot;&quot;);</span>
<span class="fc" id="L244">						visitBean.setHCPSpecialty(ele.getSpecialty());</span>
<span class="fc" id="L245">						visitBean.setHCPAddr(ele.getStreetAddress1() +&quot; &quot;+ ele.getStreetAddress2() +&quot; &quot;+ ele.getCity() +&quot;, &quot;+ ele.getState() +&quot; &quot;+ ele.getZip());</span>
						
<span class="fc" id="L247">						visitBean.setDesignated(true);</span>
				
<span class="fc" id="L249">						Long mid = Long.valueOf(ele.getMID());</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">						if (!patientDAO.checkDeclaredHCP(patientMID, mid)) {</span>
<span class="fc" id="L251">							declareAction.declareHCP(mid.toString());</span>
						}
					}
<span class="fc" id="L254">				}</span>
		}
<span class="fc" id="L256">		return &quot;&quot;;</span>
	}
	
	/**
	 * Check to see if a given HCP is declared
	 * @param mid HCP to check
	 * @return true if the HCP is declared, otherwise false
	 */
	public boolean checkDeclared(long mid) throws DBException {
<span class="fc" id="L265">		return patientDAO.checkDeclaredHCP(patientMID, mid);</span>
	}
	
	/**
	 * Filter the list of HCPs by last name, specialty, or zip code.
	 * @param specialty Filter by specialty.  May be null or the empty string 
	 *   			    to ignore.
	 * @param zip Filter by zip.  May be null or the empty string to ignore.
	 * @param lastName lastName
	 * @return Filtered list of HCPs.
	 */
	public List&lt;HCPVisitBean&gt; filterHCPList(String lastName, String specialty, String zip) {
		List&lt;HCPVisitBean&gt; visits;
		try {
<span class="fc" id="L279">			visits = getAllVisitedHCPs(lastName, specialty, zip);</span>
		}
<span class="nc" id="L281">		catch (ITrustException ie) {</span>
<span class="nc" id="L282">			visits = new ArrayList&lt;HCPVisitBean&gt;();</span>
<span class="fc" id="L283">		}</span>
			
<span class="fc" id="L285">		return visits;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>